
    digraph G {
      rankdir=LR;
      graph [fontname="Helvetica", fontsize=10, bgcolor="white"];
      node  [fontname="Helvetica", fontsize=10, shape=box, style="rounded,filled", fillcolor="#f7fafc", color="#4a5568"];
      edge  [fontname="Helvetica", fontsize=10, color="#4a5568"];

      IB [shape=box, style="rounded,filled", fillcolor="#f8f8f8", color="#333333", label="IB TWS/Gateway"];
      ALP [shape=box, style="rounded,filled", fillcolor="#f8f8f8", color="#333333", label="Alpaca WebSocket"];
      FS [shape=cylinder, style="filled", fillcolor="#fff5f5", color="#c53030", label="Filesystem"];

      subgraph cluster_infra {
        label="Infrastructure";
        color="#2b6cb0";
        style="rounded";
        CONN [label="EnhancedIBConnectionManager\n(EWrapper)"];
        ROUTE [label="IBCallbackRouter"];
        FACT [label="ContractFactory"];
        CLIENT [label="IIBMarketDataClient\nIBMarketDataClient/AlpacaMarketDataClient/NoOp"];
      }

      subgraph cluster_dom {
        label="Domain";
        color="#2c7a7b";
        style="rounded";
        TD [label="TradeDataCollector"];
        MD [label="MarketDepthCollector"];
        QC [label="QuoteCollector\n(BBO cache/emitter)"];
        MODELS [label="Models\nTrade/LOBSnapshot/BboQuotePayload/Integrity"];
      }

      subgraph cluster_app {
        label="Application";
        color="#805ad5";
        style="rounded";
        CW [label="ConfigWatcher"];
        SW [label="StatusWriter"];
        MET [label="Metrics"];
      }

      subgraph cluster_pipe {
        label="Pipeline/Storage";
        color="#c05621";
        style="rounded";
        EP [label="EventPipeline\nBounded Channel"];
        SINK [label="JsonlStorageSink"];
        POL [label="JsonlStoragePolicy"];
      }

      IB -> CONN -> ROUTE;
      ALP -> CLIENT;
      ROUTE -> TD;
      ROUTE -> MD;
      ROUTE -> QC;
      CLIENT -> TD;
      CLIENT -> QC;
      TD -> EP;
      MD -> EP;
      QC -> EP;
      QC -> TD [style=dashed, label="IQuoteStateStore"];
      EP -> SINK -> FS;
      POL -> SINK;

      CW -> CLIENT [style=dashed];
      SW -> FS;

      CLIENT -> FACT;
      CLIENT -> CONN;
    }
