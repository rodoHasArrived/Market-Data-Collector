using System.Text;

var outputPath = "Generated/MarketDataCollector.FSharp.Interop.g.cs";
for (var i = 0; i < args.Length; i++)
{
    if (args[i].Equals("--output", StringComparison.OrdinalIgnoreCase) && i + 1 < args.Length)
    {
        outputPath = args[i + 1];
        i++;
    }
}

var outputDir = Path.GetDirectoryName(outputPath);
if (!string.IsNullOrWhiteSpace(outputDir))
{
    Directory.CreateDirectory(outputDir);
}

var content = """
// <auto-generated />
// Generated by tools/FSharpInteropGenerator. Do not edit manually.

using System;
using MarketDataCollector.FSharp.Domain.MarketEvents;
using MarketDataCollector.FSharp.Domain.Sides;

namespace MarketDataCollector.FSharp.Interop.Generated;

/// <summary>
/// C#-friendly DTO for TradeEvent.
/// </summary>
public sealed class TradeEventDto
{
    public string Symbol { get; init; } = string.Empty;
    public decimal Price { get; init; }
    public long Quantity { get; init; }
    public int Side { get; init; }
    public long SequenceNumber { get; init; }
    public DateTimeOffset Timestamp { get; init; }
    public DateTimeOffset? ExchangeTimestamp { get; init; }
    public string? StreamId { get; init; }
    public string? Venue { get; init; }

    public static TradeEventDto FromFSharp(TradeEvent trade) => new()
    {
        Symbol = trade.Symbol,
        Price = trade.Price,
        Quantity = trade.Quantity,
        Side = trade.Side.ToInt(),
        SequenceNumber = trade.SequenceNumber,
        Timestamp = trade.Timestamp,
        ExchangeTimestamp = trade.ExchangeTimestamp.HasValue ? trade.ExchangeTimestamp.Value : null,
        StreamId = trade.StreamId.IsSome ? trade.StreamId.Value : null,
        Venue = trade.Venue.IsSome ? trade.Venue.Value : null
    };

    public TradeEvent ToFSharp() => new()
    {
        Symbol = Symbol,
        Price = Price,
        Quantity = Quantity,
        Side = AggressorSide.FromInt(Side),
        SequenceNumber = SequenceNumber,
        Timestamp = Timestamp,
        ExchangeTimestamp = ExchangeTimestamp.HasValue
            ? Microsoft.FSharp.Core.FSharpOption<DateTimeOffset>.Some(ExchangeTimestamp.Value)
            : null,
        StreamId = StreamId is null ? null : Microsoft.FSharp.Core.FSharpOption<string>.Some(StreamId),
        Venue = Venue is null ? null : Microsoft.FSharp.Core.FSharpOption<string>.Some(Venue)
    };
}

/// <summary>
/// C#-friendly DTO for QuoteEvent.
/// </summary>
public sealed class QuoteEventDto
{
    public string Symbol { get; init; } = string.Empty;
    public decimal BidPrice { get; init; }
    public long BidSize { get; init; }
    public decimal AskPrice { get; init; }
    public long AskSize { get; init; }
    public long SequenceNumber { get; init; }
    public DateTimeOffset Timestamp { get; init; }
    public DateTimeOffset? ExchangeTimestamp { get; init; }

    public static QuoteEventDto FromFSharp(QuoteEvent quote) => new()
    {
        Symbol = quote.Symbol,
        BidPrice = quote.BidPrice,
        BidSize = quote.BidSize,
        AskPrice = quote.AskPrice,
        AskSize = quote.AskSize,
        SequenceNumber = quote.SequenceNumber,
        Timestamp = quote.Timestamp,
        ExchangeTimestamp = quote.ExchangeTimestamp.HasValue ? quote.ExchangeTimestamp.Value : null
    };

    public QuoteEvent ToFSharp() => new()
    {
        Symbol = Symbol,
        BidPrice = BidPrice,
        BidSize = BidSize,
        AskPrice = AskPrice,
        AskSize = AskSize,
        SequenceNumber = SequenceNumber,
        Timestamp = Timestamp,
        ExchangeTimestamp = ExchangeTimestamp.HasValue
            ? Microsoft.FSharp.Core.FSharpOption<DateTimeOffset>.Some(ExchangeTimestamp.Value)
            : null,
        StreamId = null
    };
}
""";

await File.WriteAllTextAsync(outputPath, content, Encoding.UTF8);
Console.WriteLine($"Generated C# interop wrappers at {outputPath}");
