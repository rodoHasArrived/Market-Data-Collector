<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.CollectionSessionPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24">
            <!-- Header -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <FontIcon Glyph="&#xE8F1;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                    <TextBlock Text="Collection Sessions" Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center" />
                </StackPanel>

                <!-- Quick Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button x:Name="NewSessionButton" Click="NewSession_Click" Style="{StaticResource AccentButtonStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE710;" FontSize="14" />
                            <TextBlock Text="New Session" />
                        </StackPanel>
                    </Button>
                    <Button x:Name="CreateDailyButton" Click="CreateDaily_Click">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE787;" FontSize="14" />
                            <TextBlock Text="Create Daily" />
                        </StackPanel>
                    </Button>
                    <Button x:Name="RefreshButton" Click="Refresh_Click">
                        <FontIcon Glyph="&#xE72C;" FontSize="14" />
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Active Session Card -->
            <Border x:Name="ActiveSessionCard" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Ellipse Width="12" Height="12" Fill="#48BB78" />
                            <TextBlock Text="Active Session" Style="{StaticResource SubtitleTextBlockStyle}" Foreground="#48BB78" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                            <Button x:Name="PauseSessionButton" Click="PauseSession_Click">
                                <FontIcon Glyph="&#xE769;" FontSize="14" />
                            </Button>
                            <Button x:Name="StopSessionButton" Click="StopSession_Click" Style="{StaticResource AccentButtonStyle}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xE71A;" FontSize="14" />
                                    <TextBlock Text="Stop" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Grid>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Spacing="4">
                            <TextBlock x:Name="ActiveSessionName" Text="Session Name" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <TextBlock x:Name="ActiveSessionStarted" Text="Started: --" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Spacing="4">
                            <TextBlock x:Name="ActiveSessionEvents" Text="0" Style="{StaticResource SubheaderTextBlockStyle}" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Events" Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2" Spacing="4">
                            <TextBlock x:Name="ActiveSessionSymbols" Text="0" Style="{StaticResource SubheaderTextBlockStyle}" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Symbols" Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>

                        <StackPanel Grid.Column="3" Spacing="4">
                            <TextBlock x:Name="ActiveSessionQuality" Text="--%" Style="{StaticResource SubheaderTextBlockStyle}" Foreground="#48BB78" />
                            <TextBlock Text="Quality" Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>
                    </Grid>

                    <!-- Live Statistics -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Spacing="2">
                            <TextBlock x:Name="TradeEventsCount" Text="0" FontWeight="SemiBold" />
                            <TextBlock Text="Trades" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Spacing="2">
                            <TextBlock x:Name="QuoteEventsCount" Text="0" FontWeight="SemiBold" />
                            <TextBlock Text="Quotes" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2" Spacing="2">
                            <TextBlock x:Name="DepthEventsCount" Text="0" FontWeight="SemiBold" />
                            <TextBlock Text="Depth" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <StackPanel Grid.Column="3" Spacing="2">
                            <TextBlock x:Name="EventsPerSecond" Text="0/s" FontWeight="SemiBold" />
                            <TextBlock Text="Throughput" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Session History -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE81C;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Session History" Style="{StaticResource SubtitleTextBlockStyle}" />
                        <TextBlock x:Name="SessionCountText" Text="(0 sessions)" VerticalAlignment="Center"
                                   Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />
                    </StackPanel>

                    <ListView x:Name="SessionsList" SelectionMode="Single" MaxHeight="400">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="12" ColumnSpacing="16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Status Indicator -->
                                    <Ellipse Grid.Column="0" Width="10" Height="10" VerticalAlignment="Center">
                                        <Ellipse.Fill>
                                            <SolidColorBrush x:Name="StatusBrush" Color="#48BB78" />
                                        </Ellipse.Fill>
                                    </Ellipse>

                                    <!-- Name and Description -->
                                    <StackPanel Grid.Column="1" Spacing="2">
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                        <TextBlock Text="{Binding Description}" Style="{StaticResource CaptionTextBlockStyle}"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}" TextTrimming="CharacterEllipsis" />
                                    </StackPanel>

                                    <!-- Date -->
                                    <TextBlock Grid.Column="2" Text="{Binding CreatedAt}" VerticalAlignment="Center"
                                               Style="{StaticResource CaptionTextBlockStyle}" />

                                    <!-- Events -->
                                    <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Statistics.TotalEvents}" FontWeight="SemiBold" />
                                        <TextBlock Text="events" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    </StackPanel>

                                    <!-- Quality -->
                                    <TextBlock Grid.Column="4" Text="{Binding QualityScore}" VerticalAlignment="Center" Foreground="#48BB78" />

                                    <!-- Actions -->
                                    <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="4">
                                        <Button Click="ViewSessionDetails_Click" Padding="8" ToolTipService.ToolTip="View Details">
                                            <FontIcon Glyph="&#xE8A5;" FontSize="12" />
                                        </Button>
                                        <Button Click="ExportSession_Click" Padding="8" ToolTipService.ToolTip="Export Manifest">
                                            <FontIcon Glyph="&#xEDE1;" FontSize="12" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <TextBlock x:Name="NoSessionsText" Text="No sessions yet. Create your first session to start tracking data collection."
                               Visibility="Collapsed" Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" HorizontalAlignment="Center" />
                </StackPanel>
            </Border>

            <!-- Session Settings -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE713;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Session Settings" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <ToggleSwitch x:Name="AutoCreateDailyToggle" Header="Auto-create daily sessions" IsOn="True" Toggled="AutoCreateDaily_Toggled" />

                    <TextBox x:Name="SessionNamingPatternBox" Header="Session naming pattern"
                             PlaceholderText="{date}-{mode}" Text="{date}-{mode}" />
                    <TextBlock Text="Available variables: {date}, {mode}, {symbols}"
                               Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <ToggleSwitch x:Name="GenerateManifestToggle" Header="Generate manifest on session complete" IsOn="True" />

                    <NumberBox x:Name="RetainHistoryBox" Header="Retain session history (days)" Value="365"
                               Minimum="30" Maximum="3650" SpinButtonPlacementMode="Compact" />
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>

    <!-- New Session Dialog -->
    <ContentDialog x:Name="NewSessionDialog" Title="Create New Session"
                   PrimaryButtonText="Create" SecondaryButtonText="Cancel"
                   PrimaryButtonClick="NewSessionDialog_PrimaryButtonClick">
        <StackPanel Spacing="16" MinWidth="400">
            <TextBox x:Name="NewSessionNameBox" Header="Session Name" PlaceholderText="e.g., 2026-01-03-regular" />
            <TextBox x:Name="NewSessionDescriptionBox" Header="Description (optional)"
                     PlaceholderText="e.g., Regular trading hours collection" AcceptsReturn="True" Height="80" />
            <TextBox x:Name="NewSessionTagsBox" Header="Tags (comma-separated)"
                     PlaceholderText="e.g., daily, production, earnings-week" />
            <CheckBox x:Name="StartImmediatelyCheck" Content="Start session immediately" IsChecked="True" />
        </StackPanel>
    </ContentDialog>

    <!-- Session Details Dialog -->
    <ContentDialog x:Name="SessionDetailsDialog" Title="Session Details" CloseButtonText="Close">
        <ScrollViewer MaxHeight="500" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="12" MinWidth="500">
                <TextBlock x:Name="DetailsSummaryText" TextWrapping="Wrap" FontFamily="Consolas" FontSize="12"
                           IsTextSelectionEnabled="True" />
            </StackPanel>
        </ScrollViewer>
    </ContentDialog>
</Page>
