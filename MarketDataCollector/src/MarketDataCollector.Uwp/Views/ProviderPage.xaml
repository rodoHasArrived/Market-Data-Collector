<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.ProviderPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:converters="using:MarketDataCollector.Uwp.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility" />
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24" MaxWidth="1000">
            <!-- Header -->
            <StackPanel Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE703;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                <TextBlock Text="Data Provider Configuration" Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center" />
            </StackPanel>

            <!-- Connection Health Overview -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE95E;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Connection Health" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Grid ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Connection Status -->
                        <Border Grid.Column="0" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="8" Padding="16">
                            <StackPanel Spacing="8" HorizontalAlignment="Center">
                                <Ellipse x:Name="ConnectionStatusIndicator" Width="24" Height="24" Fill="#48BB78"
                                         HorizontalAlignment="Center" />
                                <TextBlock x:Name="ConnectionStatusLabel" Text="Connected"
                                           HorizontalAlignment="Center" FontWeight="SemiBold" />
                                <TextBlock x:Name="ConnectionProviderLabel" Text="Interactive Brokers"
                                           HorizontalAlignment="Center"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                            </StackPanel>
                        </Border>

                        <!-- Latency -->
                        <Border Grid.Column="1" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="8" Padding="16">
                            <StackPanel Spacing="4">
                                <TextBlock Text="Latency" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="LatencyDisplayText" Text="12ms"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#48BB78" />
                                <Canvas x:Name="LatencySparkline" Height="25" Background="Transparent">
                                    <Polyline x:Name="LatencySparklinePath" Stroke="#48BB78" StrokeThickness="1.5" />
                                </Canvas>
                                <TextBlock x:Name="LatencyStatsText" Text="Avg: 11ms"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                            </StackPanel>
                        </Border>

                        <!-- Reconnections -->
                        <Border Grid.Column="2" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="8" Padding="16">
                            <StackPanel Spacing="4">
                                <TextBlock Text="Reconnections" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="ReconnectCountText" Text="0"
                                           Style="{StaticResource SubheaderTextBlockStyle}" />
                                <TextBlock x:Name="UptimeDisplayText" Text="Uptime: 2h 34m"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                            </StackPanel>
                        </Border>

                        <!-- Quality Score -->
                        <Border Grid.Column="3" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="8" Padding="16">
                            <StackPanel Spacing="4">
                                <TextBlock Text="Quality" Style="{StaticResource CaptionTextBlockStyle}" />
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock x:Name="QualityScoreText" Text="Excellent"
                                               Style="{StaticResource SubheaderTextBlockStyle}"
                                               Foreground="#48BB78" />
                                    <FontIcon Glyph="&#xE73E;" FontSize="16" Foreground="#48BB78" />
                                </StackPanel>
                                <ProgressBar x:Name="QualityProgressBar" Value="95" Maximum="100" Height="4" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Provider Selection with Multi-Provider Toggle -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="Select Data Provider" Style="{StaticResource SubtitleTextBlockStyle}" />
                        <ToggleSwitch x:Name="MultiProviderToggle" Grid.Column="1"
                                      OffContent="Single" OnContent="Multi"
                                      IsOn="False" Toggled="MultiProviderToggle_Toggled" />
                    </Grid>

                    <!-- Single Provider Mode -->
                    <StackPanel x:Name="SingleProviderPanel">
                        <RadioButtons x:Name="ProviderRadios" SelectionChanged="ProviderRadios_SelectionChanged">
                            <RadioButton x:Name="IbRadio" Content="Interactive Brokers (IB)" Tag="IB">
                                <RadioButton.ContentTemplate>
                                    <DataTemplate>
                                        <StackPanel Spacing="4">
                                            <TextBlock Text="Interactive Brokers (IB)" FontWeight="SemiBold" />
                                            <TextBlock Text="TWS/Gateway connection for Level 2 depth and tick-by-tick trades"
                                                       Style="{StaticResource CaptionTextBlockStyle}"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </RadioButton.ContentTemplate>
                            </RadioButton>
                            <RadioButton x:Name="AlpacaRadio" Content="Alpaca" Tag="Alpaca">
                                <RadioButton.ContentTemplate>
                                    <DataTemplate>
                                        <StackPanel Spacing="4">
                                            <TextBlock Text="Alpaca" FontWeight="SemiBold" />
                                            <TextBlock Text="WebSocket streaming for trades and quotes (free IEX tier available)"
                                                       Style="{StaticResource CaptionTextBlockStyle}"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </RadioButton.ContentTemplate>
                            </RadioButton>
                        </RadioButtons>
                    </StackPanel>

                    <!-- Multi-Provider Mode -->
                    <StackPanel x:Name="MultiProviderPanel" Visibility="Collapsed" Spacing="12">
                        <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                                 Title="Multi-Provider Mode"
                                 Message="Enable multiple providers for data comparison and automatic failover." />

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" BorderBrush="{ThemeResource SystemBaseMediumColor}"
                                    BorderThickness="1" CornerRadius="8" Padding="12">
                                <StackPanel Spacing="8">
                                    <CheckBox x:Name="EnableIbCheck" Content="Interactive Brokers" IsChecked="True" FontWeight="SemiBold" />
                                    <ComboBox Header="Role" HorizontalAlignment="Stretch" SelectedIndex="0" Margin="24,0,0,0">
                                        <ComboBoxItem Content="Primary" />
                                        <ComboBoxItem Content="Failover" />
                                        <ComboBoxItem Content="Comparison" />
                                    </ComboBox>
                                </StackPanel>
                            </Border>

                            <Border Grid.Column="1" BorderBrush="{ThemeResource SystemBaseMediumColor}"
                                    BorderThickness="1" CornerRadius="8" Padding="12">
                                <StackPanel Spacing="8">
                                    <CheckBox x:Name="EnableAlpacaCheck" Content="Alpaca" FontWeight="SemiBold" />
                                    <ComboBox Header="Role" HorizontalAlignment="Stretch" SelectedIndex="1" Margin="24,0,0,0">
                                        <ComboBoxItem Content="Primary" />
                                        <ComboBoxItem Content="Failover" />
                                        <ComboBoxItem Content="Comparison" />
                                    </ComboBox>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- IB Settings -->
            <Border x:Name="IbSettings" Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8C8;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Interactive Brokers Settings" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                             Title="Connection Requirements"
                             Message="Ensure TWS or IB Gateway is running with API connections enabled." />

                    <Grid ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="100" />
                            <ColumnDefinition Width="80" />
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="IbHostBox" Grid.Column="0" Header="Host" Text="127.0.0.1" />
                        <NumberBox x:Name="IbPortBox" Grid.Column="1" Header="Port" Value="7496"
                                   SpinButtonPlacementMode="Compact" />
                        <NumberBox x:Name="IbClientIdBox" Grid.Column="2" Header="Client ID" Value="1"
                                   SpinButtonPlacementMode="Compact" />
                    </Grid>

                    <!-- Connection Test -->
                    <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                            CornerRadius="8" Padding="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <Ellipse x:Name="IbTestIndicator" Width="12" Height="12" Fill="#A0AEC0" />
                                <TextBlock x:Name="IbTestStatusText" Text="Not tested" VerticalAlignment="Center" />
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                <Button Content="Test Connection" Click="TestIbConnection_Click" />
                                <ProgressRing x:Name="IbTestProgress" IsActive="False" Width="20" Height="20" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Alpaca Settings -->
            <Border x:Name="AlpacaSettings" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8C8;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Alpaca Configuration" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <!-- Credential Management with Test -->
                    <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                            CornerRadius="8" Padding="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Spacing="4">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon Glyph="&#xE72E;" FontSize="14" Foreground="{ThemeResource SystemAccentColor}" />
                                    <TextBlock Text="API Credentials" FontWeight="SemiBold" />
                                </StackPanel>
                                <TextBlock x:Name="CredentialStatusText" Text="No credentials stored"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                <Button x:Name="SetCredentialsButton" Content="Set Credentials"
                                        Click="SetAlpacaCredentials_Click" />
                                <Button x:Name="TestCredentialsButton" Content="Test"
                                        Click="TestAlpacaCredentials_Click" />
                                <Button x:Name="ClearCredentialsButton" Content="Clear"
                                        Visibility="Collapsed" Click="ClearAlpacaCredentials_Click" />
                                <ProgressRing x:Name="CredentialTestProgress" IsActive="False" Width="20" Height="20" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <InfoBar x:Name="CredentialTestInfoBar" IsOpen="False" IsClosable="True" />

                    <Grid ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <ComboBox x:Name="AlpacaFeedCombo" Grid.Column="0" Header="Feed Type" HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="IEX (Free)" Tag="iex" IsSelected="True" />
                            <ComboBoxItem Content="SIP (Paid)" Tag="sip" />
                            <ComboBoxItem Content="Delayed SIP" Tag="delayed_sip" />
                        </ComboBox>

                        <ComboBox x:Name="AlpacaEnvironmentCombo" Grid.Column="1" Header="Environment" HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Production" Tag="false" IsSelected="True" />
                            <ComboBoxItem Content="Sandbox (Paper)" Tag="true" />
                        </ComboBox>
                    </Grid>

                    <CheckBox x:Name="AlpacaSubscribeQuotesCheck" Content="Subscribe to Quotes (BBO)" />

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button Content="Save Alpaca Settings" Style="{StaticResource AccentButtonStyle}"
                                Click="SaveAlpacaSettings_Click" />
                        <ProgressRing x:Name="AlpacaSaveProgress" IsActive="False" Width="20" Height="20" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Latency History -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE9D9;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Latency History" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                            CornerRadius="4" Padding="12">
                        <Canvas x:Name="LatencyHistoryChart" Height="80">
                            <Polyline x:Name="LatencyHistoryPath" Stroke="{ThemeResource SystemAccentColor}"
                                      StrokeThickness="2" />
                        </Canvas>
                    </Border>

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Current" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="CurrentLatencyText" Text="12ms" FontWeight="SemiBold" />
                        </StackPanel>
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Average" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="AvgLatencyText" Text="11ms" FontWeight="SemiBold" />
                        </StackPanel>
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="P95" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="P95LatencyText" Text="18ms" FontWeight="SemiBold" />
                        </StackPanel>
                        <StackPanel Grid.Column="3">
                            <TextBlock Text="P99" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="P99LatencyText" Text="25ms" FontWeight="SemiBold" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Save Provider Button -->
            <StackPanel Orientation="Horizontal" Spacing="12">
                <Button Content="Save Provider Selection" Style="{StaticResource AccentButtonStyle}"
                        Click="SaveProvider_Click" />
                <ProgressRing x:Name="SaveProgress" IsActive="False" Width="20" Height="20" />
            </StackPanel>

            <InfoBar x:Name="SaveInfoBar" IsOpen="False" IsClosable="True" />
        </StackPanel>
    </ScrollViewer>
</Page>
