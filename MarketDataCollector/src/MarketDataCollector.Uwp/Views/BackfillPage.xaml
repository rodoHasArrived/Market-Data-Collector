<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.BackfillPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24" MaxWidth="900">
            <!-- Header -->
            <StackPanel Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE787;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                <TextBlock Text="Historical Data Backfill" Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center" />
            </StackPanel>

            <TextBlock Text="Download free end-of-day historical data from multiple providers with automatic failover."
                       Style="{StaticResource BodyTextBlockStyle}"
                       Foreground="{ThemeResource SystemBaseMediumColor}" />

            <!-- Provider Selection -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <TextBlock Text="Data Provider" Style="{StaticResource SubtitleTextBlockStyle}" />

                    <Grid ColumnSpacing="16" RowSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <ComboBox x:Name="ProviderCombo"
                                  Grid.Column="0"
                                  Header="Provider"
                                  HorizontalAlignment="Stretch"
                                  SelectedIndex="0">
                            <ComboBoxItem Content="Multi-Source (Auto-Failover)" Tag="composite" />
                            <ComboBoxItem Content="Yahoo Finance (Free)" Tag="yahoo" />
                            <ComboBoxItem Content="Stooq (Free EOD)" Tag="stooq" />
                            <ComboBoxItem Content="Nasdaq Data Link (Quandl)" Tag="nasdaq" />
                        </ComboBox>

                        <TextBox x:Name="SymbolsBox"
                                 Grid.Column="1"
                                 Header="Symbols (comma-separated)"
                                 PlaceholderText="AAPL,MSFT,TSLA" />
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Date Range -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <TextBlock Text="Date Range" Style="{StaticResource SubtitleTextBlockStyle}" />

                    <Grid ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <CalendarDatePicker x:Name="FromDatePicker"
                                            Grid.Column="0"
                                            Header="From Date (UTC)"
                                            HorizontalAlignment="Stretch"
                                            PlaceholderText="Select start date" />

                        <CalendarDatePicker x:Name="ToDatePicker"
                                            Grid.Column="1"
                                            Header="To Date (UTC)"
                                            HorizontalAlignment="Stretch"
                                            PlaceholderText="Select end date" />
                    </Grid>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Last 30 Days" Click="Last30Days_Click" />
                        <Button Content="Last 90 Days" Click="Last90Days_Click" />
                        <Button Content="Year to Date" Click="YearToDate_Click" />
                        <Button Content="Last Year" Click="LastYear_Click" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Advanced Options -->
            <Expander Header="Advanced Options" IsExpanded="False" HorizontalAlignment="Stretch">
                <Border Style="{StaticResource CardStyle}" Margin="0,8,0,0">
                    <StackPanel Spacing="16">
                        <CheckBox x:Name="EnableSymbolResolutionCheck"
                                  Content="Enable Symbol Resolution (OpenFIGI)"
                                  IsChecked="True" />
                        <TextBlock Text="Automatically normalize symbols across providers"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                   Margin="28,0,0,0" />

                        <CheckBox x:Name="PreferAdjustedCheck"
                                  Content="Prefer Adjusted Prices"
                                  IsChecked="True" />
                        <TextBlock Text="Use split/dividend adjusted prices when available"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                   Margin="28,0,0,0" />

                        <!-- Secure API Key Management -->
                        <TextBlock Text="API Keys (Securely Stored)"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   Margin="0,8,0,0" />

                        <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                                 Title="Secure Storage"
                                 Message="API keys are stored in Windows Credential Manager, not in config files." />

                        <!-- Nasdaq API Key -->
                        <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="8" Padding="16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0" Spacing="4">
                                    <TextBlock Text="Nasdaq Data Link (Quandl)" FontWeight="SemiBold" />
                                    <TextBlock x:Name="NasdaqKeyStatusText"
                                               Text="No API key stored"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                </StackPanel>

                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                    <Button x:Name="SetNasdaqKeyButton"
                                            Content="Set Key"
                                            Click="SetNasdaqApiKey_Click" />
                                    <Button x:Name="ClearNasdaqKeyButton"
                                            Content="Clear"
                                            Visibility="Collapsed"
                                            Click="ClearNasdaqApiKey_Click" />
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- OpenFIGI API Key -->
                        <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="8" Padding="16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0" Spacing="4">
                                    <TextBlock Text="OpenFIGI (Symbol Resolution)" FontWeight="SemiBold" />
                                    <TextBlock x:Name="OpenFigiKeyStatusText"
                                               Text="No API key stored (optional)"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                </StackPanel>

                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                    <Button x:Name="SetOpenFigiKeyButton"
                                            Content="Set Key"
                                            Click="SetOpenFigiApiKey_Click" />
                                    <Button x:Name="ClearOpenFigiKeyButton"
                                            Content="Clear"
                                            Visibility="Collapsed"
                                            Click="ClearOpenFigiApiKey_Click" />
                                </StackPanel>
                            </Grid>
                        </Border>
                    </StackPanel>
                </Border>
            </Expander>

            <!-- Run Backfill -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button x:Name="StartBackfillButton"
                                Content="Start Backfill"
                                Style="{StaticResource AccentButtonStyle}"
                                Click="StartBackfill_Click" />
                        <Button x:Name="CancelBackfillButton"
                                Content="Cancel"
                                Visibility="Collapsed"
                                Click="CancelBackfill_Click" />
                        <ProgressRing x:Name="BackfillProgress" IsActive="False" Width="24" Height="24" />
                    </StackPanel>

                    <!-- Progress Bar -->
                    <StackPanel x:Name="ProgressPanel" Visibility="Collapsed" Spacing="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="ProgressLabel" Grid.Column="0" Text="Processing..." />
                            <TextBlock x:Name="ProgressPercent" Grid.Column="1" Text="0%" />
                        </Grid>
                        <ProgressBar x:Name="ProgressBar" Minimum="0" Maximum="100" Value="0" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Last Run Status -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <TextBlock Text="Last Backfill Status" Style="{StaticResource SubtitleTextBlockStyle}" />

                    <Grid x:Name="StatusGrid" Visibility="Collapsed">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Status:" FontWeight="SemiBold" />
                        <TextBlock x:Name="StatusText" Grid.Row="0" Grid.Column="1" />

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Provider:" FontWeight="SemiBold" />
                        <TextBlock x:Name="ProviderText" Grid.Row="1" Grid.Column="1" />

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Symbols:" FontWeight="SemiBold" />
                        <TextBlock x:Name="SymbolsText" Grid.Row="2" Grid.Column="1" TextWrapping="Wrap" />

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Bars Written:" FontWeight="SemiBold" />
                        <TextBlock x:Name="BarsWrittenText" Grid.Row="3" Grid.Column="1" />

                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Started:" FontWeight="SemiBold" />
                        <TextBlock x:Name="StartedText" Grid.Row="4" Grid.Column="1" />

                        <TextBlock Grid.Row="5" Grid.Column="0" Text="Completed:" FontWeight="SemiBold" />
                        <TextBlock x:Name="CompletedText" Grid.Row="5" Grid.Column="1" />
                    </Grid>

                    <TextBlock x:Name="NoStatusText"
                               Text="No backfill runs yet. Select a provider and symbols to get started."
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <TextBlock x:Name="ErrorText"
                               Visibility="Collapsed"
                               Foreground="#F56565"
                               TextWrapping="Wrap" />

                    <Button Content="Refresh Status" Click="RefreshStatus_Click" />
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</Page>
