#if STOCKSHARP
using StockSharp.BusinessEntities;
using StockSharp.Messages;
#endif
using MarketDataCollector.Application.Config;

namespace MarketDataCollector.Infrastructure.Providers.StockSharp.Converters;

/// <summary>
/// Converts between MarketDataCollector symbol configuration and StockSharp security types.
/// Handles security type mapping and exchange board resolution.
/// </summary>
public static class SecurityConverter
{
#if STOCKSHARP
    /// <summary>
    /// Create a StockSharp Security from MDC SymbolConfig.
    /// </summary>
    /// <param name="cfg">MDC symbol configuration.</param>
    /// <returns>StockSharp Security object configured for subscription.</returns>
    public static Security ToSecurity(SymbolConfig cfg)
    {
        var security = new Security
        {
            Id = BuildSecurityId(cfg),
            Code = cfg.Symbol,
            Board = ResolveBoard(cfg.Exchange, cfg.SecurityType),
            Type = MapSecurityType(cfg.SecurityType),
            Currency = MapCurrency(cfg.Currency)
        };

        if (!string.IsNullOrEmpty(cfg.LocalSymbol))
            security.Code = cfg.LocalSymbol;

        return security;
    }

    /// <summary>
    /// Create a StockSharp SecurityId from MDC SymbolConfig.
    /// </summary>
    /// <param name="cfg">MDC symbol configuration.</param>
    /// <returns>StockSharp SecurityId for message-level operations.</returns>
    public static SecurityId ToSecurityId(SymbolConfig cfg)
    {
        return new SecurityId
        {
            SecurityCode = cfg.LocalSymbol ?? cfg.Symbol,
            BoardCode = cfg.Exchange
        };
    }

    /// <summary>
    /// Build a unique security identifier string.
    /// Format: SYMBOL@EXCHANGE (e.g., "ES@CME", "AAPL@NASDAQ")
    /// </summary>
    private static string BuildSecurityId(SymbolConfig cfg)
    {
        var symbol = cfg.LocalSymbol ?? cfg.Symbol;
        var exchange = cfg.PrimaryExchange ?? cfg.Exchange;
        return $"{symbol}@{exchange}";
    }

    /// <summary>
    /// Resolve StockSharp ExchangeBoard from exchange name and security type.
    /// </summary>
    private static ExchangeBoard ResolveBoard(string exchange, string securityType)
    {
        // Common futures exchanges
        return exchange.ToUpperInvariant() switch
        {
            "CME" => ExchangeBoard.Cme,
            "NYMEX" => ExchangeBoard.Nymex,
            "COMEX" => ExchangeBoard.Comex,
            "CBOT" => ExchangeBoard.Cbot,
            "ICE" => ExchangeBoard.Ice,

            // US Equities
            "NYSE" => ExchangeBoard.Nyse,
            "NASDAQ" => ExchangeBoard.Nasdaq,
            "AMEX" => ExchangeBoard.Amex,
            "ARCA" => ExchangeBoard.Arca,
            "BATS" => ExchangeBoard.Bats,
            "IEX" => ExchangeBoard.Iex,

            // International
            "LSE" => ExchangeBoard.Lse,
            "TSE" => ExchangeBoard.Tse,

            // Crypto
            "BINANCE" => ExchangeBoard.Binance,
            "COINBASE" => ExchangeBoard.Coinbase,
            "KRAKEN" => ExchangeBoard.Kraken,

            // Forex
            "FXCM" => ExchangeBoard.Fxcm,
            "OANDA" => ExchangeBoard.Oanda,

            // Interactive Brokers SMART routing
            "SMART" => ExchangeBoard.Nyse, // Default to NYSE for SMART

            _ => ExchangeBoard.Associated
        };
    }

    /// <summary>
    /// Map MDC security type string to StockSharp SecurityTypes enum.
    /// </summary>
    private static SecurityTypes? MapSecurityType(string securityType)
    {
        return securityType.ToUpperInvariant() switch
        {
            "STK" => SecurityTypes.Stock,
            "STOCK" => SecurityTypes.Stock,
            "FUT" => SecurityTypes.Future,
            "FUTURE" => SecurityTypes.Future,
            "OPT" => SecurityTypes.Option,
            "OPTION" => SecurityTypes.Option,
            "FOP" => SecurityTypes.Option, // Futures option
            "CASH" => SecurityTypes.Currency,
            "FOREX" => SecurityTypes.Currency,
            "FX" => SecurityTypes.Currency,
            "CRYPTO" => SecurityTypes.CryptoCurrency,
            "IND" => SecurityTypes.Index,
            "INDEX" => SecurityTypes.Index,
            "ETF" => SecurityTypes.Etf,
            "BOND" => SecurityTypes.Bond,
            "CFD" => SecurityTypes.Cfd,
            _ => null
        };
    }

    /// <summary>
    /// Map currency code string to StockSharp CurrencyTypes enum.
    /// </summary>
    private static CurrencyTypes MapCurrency(string currency)
    {
        return currency.ToUpperInvariant() switch
        {
            "USD" => CurrencyTypes.USD,
            "EUR" => CurrencyTypes.EUR,
            "GBP" => CurrencyTypes.GBP,
            "JPY" => CurrencyTypes.JPY,
            "CHF" => CurrencyTypes.CHF,
            "CAD" => CurrencyTypes.CAD,
            "AUD" => CurrencyTypes.AUD,
            "NZD" => CurrencyTypes.NZD,
            "CNY" => CurrencyTypes.CNY,
            "HKD" => CurrencyTypes.HKD,
            "SGD" => CurrencyTypes.SGD,
            "BTC" => CurrencyTypes.BTC,
            "ETH" => CurrencyTypes.ETH,
            _ => CurrencyTypes.USD
        };
    }
#else
    // Stub implementations when StockSharp is not available

    /// <summary>
    /// Stub: StockSharp packages not installed.
    /// </summary>
    public static object ToSecurity(SymbolConfig cfg)
    {
        throw new NotSupportedException(
            "StockSharp integration requires StockSharp.BusinessEntities NuGet package.");
    }

    /// <summary>
    /// Stub: StockSharp packages not installed.
    /// </summary>
    public static object ToSecurityId(SymbolConfig cfg)
    {
        throw new NotSupportedException(
            "StockSharp integration requires StockSharp.Messages NuGet package.");
    }
#endif
}
