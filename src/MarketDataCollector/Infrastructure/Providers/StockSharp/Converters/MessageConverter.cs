#if STOCKSHARP
using StockSharp.Messages;
#endif
using MarketDataCollector.Contracts.Domain.Enums;
using MarketDataCollector.Domain.Models;

namespace MarketDataCollector.Infrastructure.Providers.StockSharp.Converters;

/// <summary>
/// Converts StockSharp messages to MarketDataCollector domain models.
/// This converter bridges S# message types to MDC's immutable domain records.
/// </summary>
public static class MessageConverter
{
#if STOCKSHARP
    /// <summary>
    /// Convert StockSharp ExecutionMessage (trade tick) to MDC Trade.
    /// </summary>
    /// <param name="msg">StockSharp execution message containing trade data.</param>
    /// <param name="symbol">Symbol identifier for the security.</param>
    /// <returns>Immutable Trade domain model.</returns>
    public static Trade ToTrade(ExecutionMessage msg, string symbol)
    {
        return new Trade(
            Timestamp: msg.ServerTime,
            Symbol: symbol,
            Price: msg.TradePrice ?? 0m,
            Size: (long)(msg.TradeVolume ?? 0m),
            Aggressor: ConvertSide(msg.OriginSide),
            SequenceNumber: msg.SeqNum ?? 0,
            StreamId: msg.TradeId?.ToString(),
            Venue: msg.SecurityId.BoardCode
        );
    }

    /// <summary>
    /// Convert StockSharp QuoteChangeMessage to MDC LOBSnapshot.
    /// </summary>
    /// <param name="msg">StockSharp quote change message with bid/ask arrays.</param>
    /// <param name="symbol">Symbol identifier for the security.</param>
    /// <returns>Immutable LOBSnapshot domain model.</returns>
    public static LOBSnapshot ToLOBSnapshot(QuoteChangeMessage msg, string symbol)
    {
        var bids = msg.Bids?
            .Select((q, i) => new OrderBookLevel(
                Side: OrderBookSide.Bid,
                Level: i,
                Price: q.Price,
                Size: q.Volume))
            .ToList() ?? new List<OrderBookLevel>();

        var asks = msg.Asks?
            .Select((q, i) => new OrderBookLevel(
                Side: OrderBookSide.Ask,
                Level: i,
                Price: q.Price,
                Size: q.Volume))
            .ToList() ?? new List<OrderBookLevel>();

        var bestBid = bids.FirstOrDefault()?.Price ?? 0;
        var bestAsk = asks.FirstOrDefault()?.Price ?? 0;
        var midPrice = bestBid > 0 && bestAsk > 0 ? (bestBid + bestAsk) / 2 : (decimal?)null;

        return new LOBSnapshot(
            Timestamp: msg.ServerTime,
            Symbol: symbol,
            Bids: bids,
            Asks: asks,
            MidPrice: midPrice,
            SequenceNumber: msg.SeqNum ?? 0,
            Venue: msg.SecurityId.BoardCode
        );
    }

    /// <summary>
    /// Convert StockSharp Level1ChangeMessage to MDC BboQuotePayload.
    /// </summary>
    /// <param name="msg">StockSharp Level1 message with best bid/offer data.</param>
    /// <param name="symbol">Symbol identifier for the security.</param>
    /// <returns>Immutable BboQuotePayload domain model.</returns>
    public static BboQuotePayload ToBboQuote(Level1ChangeMessage msg, string symbol)
    {
        var bidPrice = GetDecimal(msg, Level1Fields.BestBidPrice);
        var askPrice = GetDecimal(msg, Level1Fields.BestAskPrice);
        var bidSize = (long)GetDecimal(msg, Level1Fields.BestBidVolume);
        var askSize = (long)GetDecimal(msg, Level1Fields.BestAskVolume);

        decimal? midPrice = null;
        decimal? spread = null;

        if (bidPrice > 0 && askPrice > 0 && askPrice >= bidPrice)
        {
            spread = askPrice - bidPrice;
            midPrice = bidPrice + (spread.Value / 2m);
        }

        return new BboQuotePayload(
            Timestamp: msg.ServerTime,
            Symbol: symbol,
            BidPrice: bidPrice,
            BidSize: bidSize,
            AskPrice: askPrice,
            AskSize: askSize,
            MidPrice: midPrice,
            Spread: spread,
            SequenceNumber: msg.SeqNum ?? 0,
            Venue: msg.SecurityId.BoardCode
        );
    }

    /// <summary>
    /// Convert StockSharp TimeFrameCandleMessage to MDC HistoricalBar.
    /// </summary>
    /// <param name="msg">StockSharp candle message with OHLCV data.</param>
    /// <param name="symbol">Symbol identifier for the security.</param>
    /// <returns>Immutable HistoricalBar domain model.</returns>
    public static HistoricalBar ToHistoricalBar(TimeFrameCandleMessage msg, string symbol)
    {
        return new HistoricalBar(
            Symbol: symbol,
            SessionDate: DateOnly.FromDateTime(msg.OpenTime.Date),
            Open: msg.OpenPrice,
            High: msg.HighPrice,
            Low: msg.LowPrice,
            Close: msg.ClosePrice,
            Volume: (long)msg.TotalVolume,
            Source: "stocksharp",
            SequenceNumber: 0
        );
    }

    /// <summary>
    /// Convert S# Sides enum to MDC AggressorSide enum.
    /// </summary>
    private static AggressorSide ConvertSide(Sides? side) => side switch
    {
        Sides.Buy => AggressorSide.Buy,
        Sides.Sell => AggressorSide.Sell,
        _ => AggressorSide.Unknown
    };

    /// <summary>
    /// Extract decimal value from Level1ChangeMessage changes dictionary.
    /// </summary>
    private static decimal GetDecimal(Level1ChangeMessage msg, Level1Fields field)
    {
        if (msg.Changes.TryGetValue(field, out var value) && value is decimal d)
            return d;
        return 0m;
    }
#else
    // Stub implementations when StockSharp is not available
    // These allow the code to compile without the StockSharp packages

    /// <summary>
    /// Stub: StockSharp packages not installed.
    /// </summary>
    public static Trade ToTrade(object msg, string symbol)
    {
        throw new NotSupportedException(
            "StockSharp integration requires StockSharp.Algo NuGet package. " +
            "Install with: dotnet add package StockSharp.Algo");
    }

    /// <summary>
    /// Stub: StockSharp packages not installed.
    /// </summary>
    public static LOBSnapshot ToLOBSnapshot(object msg, string symbol)
    {
        throw new NotSupportedException(
            "StockSharp integration requires StockSharp.Messages NuGet package.");
    }

    /// <summary>
    /// Stub: StockSharp packages not installed.
    /// </summary>
    public static BboQuotePayload ToBboQuote(object msg, string symbol)
    {
        throw new NotSupportedException(
            "StockSharp integration requires StockSharp.Messages NuGet package.");
    }

    /// <summary>
    /// Stub: StockSharp packages not installed.
    /// </summary>
    public static HistoricalBar ToHistoricalBar(object msg, string symbol)
    {
        throw new NotSupportedException(
            "StockSharp integration requires StockSharp.Messages NuGet package.");
    }
#endif
}
