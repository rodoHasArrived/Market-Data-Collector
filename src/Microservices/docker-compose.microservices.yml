# =============================================================================
# Data Ingestion Microservices - Docker Compose Configuration
# =============================================================================
#
# Quick Start:
#   1. Build all services: docker compose -f docker-compose.microservices.yml build
#   2. Start all services: docker compose -f docker-compose.microservices.yml up -d
#   3. Scale services: docker compose -f docker-compose.microservices.yml up -d --scale trade-ingestion=3
#
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # API Gateway - Entry point for all data ingestion
  # ---------------------------------------------------------------------------
  gateway:
    build:
      context: .
      dockerfile: Gateway/Dockerfile
    container_name: ingestion-gateway
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_URLS=http://+:5000
      - Gateway__MessageBus__Transport=RabbitMQ
      - Gateway__MessageBus__RabbitMq__Host=rabbitmq
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # Trade Ingestion Service
  # ---------------------------------------------------------------------------
  trade-ingestion:
    build:
      context: .
      dockerfile: TradeIngestion/Dockerfile
    container_name: trade-ingestion
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      - ASPNETCORE_URLS=http://+:5001
      - TradeService__MessageBus__Transport=RabbitMQ
      - TradeService__MessageBus__RabbitMq__Host=rabbitmq
    volumes:
      - trade-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # OrderBook Ingestion Service
  # ---------------------------------------------------------------------------
  orderbook-ingestion:
    build:
      context: .
      dockerfile: OrderBookIngestion/Dockerfile
    container_name: orderbook-ingestion
    restart: unless-stopped
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_URLS=http://+:5002
      - OrderBookService__MessageBus__Transport=RabbitMQ
      - OrderBookService__MessageBus__RabbitMq__Host=rabbitmq
    volumes:
      - orderbook-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # Quote Ingestion Service
  # ---------------------------------------------------------------------------
  quote-ingestion:
    build:
      context: .
      dockerfile: QuoteIngestion/Dockerfile
    container_name: quote-ingestion
    restart: unless-stopped
    ports:
      - "5003:5003"
    environment:
      - ASPNETCORE_URLS=http://+:5003
      - QuoteService__MessageBus__Transport=RabbitMQ
      - QuoteService__MessageBus__RabbitMq__Host=rabbitmq
    volumes:
      - quote-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # Historical Data Ingestion Service
  # ---------------------------------------------------------------------------
  historical-ingestion:
    build:
      context: .
      dockerfile: HistoricalDataIngestion/Dockerfile
    container_name: historical-ingestion
    restart: unless-stopped
    ports:
      - "5004:5004"
    environment:
      - ASPNETCORE_URLS=http://+:5004
      - HistoricalService__MessageBus__Transport=RabbitMQ
      - HistoricalService__MessageBus__RabbitMq__Host=rabbitmq
    volumes:
      - historical-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # Data Validation Service
  # ---------------------------------------------------------------------------
  validation-service:
    build:
      context: .
      dockerfile: DataValidation/Dockerfile
    container_name: validation-service
    restart: unless-stopped
    ports:
      - "5005:5005"
    environment:
      - ASPNETCORE_URLS=http://+:5005
      - ValidationService__MessageBus__Transport=RabbitMQ
      - ValidationService__MessageBus__RabbitMq__Host=rabbitmq
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # RabbitMQ - Message Broker
  # ---------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ingestion-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=ingestion
      - RABBITMQ_DEFAULT_PASS=ingestion-secret
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # Prometheus - Metrics Collection (Optional)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: ingestion-prometheus
    profiles:
      - monitoring
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
    networks:
      - ingestion-network

  # ---------------------------------------------------------------------------
  # Grafana - Metrics Visualization (Optional)
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: ingestion-grafana
    profiles:
      - monitoring
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - ingestion-network

networks:
  ingestion-network:
    driver: bridge

volumes:
  trade-data:
  orderbook-data:
  quote-data:
  historical-data:
  rabbitmq-data:
  prometheus-data:
  grafana-data:

# =============================================================================
# Usage:
# =============================================================================
#
# Start core services:
#   docker compose -f docker-compose.microservices.yml up -d
#
# Start with monitoring:
#   docker compose -f docker-compose.microservices.yml --profile monitoring up -d
#
# View logs:
#   docker compose -f docker-compose.microservices.yml logs -f gateway
#
# Scale trade ingestion:
#   docker compose -f docker-compose.microservices.yml up -d --scale trade-ingestion=3
#
# Stop all:
#   docker compose -f docker-compose.microservices.yml down
#
# =============================================================================
