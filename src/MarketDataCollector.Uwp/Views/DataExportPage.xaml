<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.DataExportPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24" MaxWidth="1000">
            <!-- Header -->
            <StackPanel Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xEDE1;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                <TextBlock Text="Data Export &amp; Integration" Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center" />
            </StackPanel>

            <TextBlock Text="Export collected market data to various formats and integrate with external systems."
                       Style="{StaticResource BodyTextBlockStyle}"
                       Foreground="{ThemeResource SystemBaseMediumColor}" />

            <!-- Quick Export -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE78C;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Quick Export" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Grid ColumnSpacing="16" RowSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!-- Symbol Selection -->
                        <StackPanel Grid.Row="0" Grid.Column="0" Spacing="8">
                            <TextBlock Text="Symbols" Style="{StaticResource CaptionTextBlockStyle}" />
                            <AutoSuggestBox x:Name="SymbolSearchBox"
                                            PlaceholderText="Search symbols..."
                                            QueryIcon="Find" />
                            <ListView x:Name="SelectedSymbolsList"
                                      Height="120"
                                      SelectionMode="Multiple">
                                <ListViewItem Content="AAPL" IsSelected="True" />
                                <ListViewItem Content="MSFT" IsSelected="True" />
                                <ListViewItem Content="TSLA" />
                                <ListViewItem Content="GOOGL" />
                                <ListViewItem Content="AMZN" />
                            </ListView>
                        </StackPanel>

                        <!-- Date Range -->
                        <StackPanel Grid.Row="0" Grid.Column="1" Spacing="8">
                            <CalendarDatePicker x:Name="ExportFromDate"
                                                Header="From Date"
                                                HorizontalAlignment="Stretch"
                                                PlaceholderText="Start date" />
                            <CalendarDatePicker x:Name="ExportToDate"
                                                Header="To Date"
                                                HorizontalAlignment="Stretch"
                                                PlaceholderText="End date" />
                            <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,8,0,0">
                                <Button Content="Today" Click="SetToday_Click" />
                                <Button Content="Week" Click="SetWeek_Click" />
                                <Button Content="Month" Click="SetMonth_Click" />
                            </StackPanel>
                        </StackPanel>

                        <!-- Data Types -->
                        <StackPanel Grid.Row="0" Grid.Column="2" Spacing="8">
                            <TextBlock Text="Data Types" Style="{StaticResource CaptionTextBlockStyle}" />
                            <CheckBox x:Name="ExportTradesCheck" Content="Trades" IsChecked="True" />
                            <CheckBox x:Name="ExportDepthCheck" Content="Order Book Depth" IsChecked="True" />
                            <CheckBox x:Name="ExportQuotesCheck" Content="BBO Quotes" IsChecked="False" />
                            <CheckBox x:Name="ExportBarsCheck" Content="Historical Bars" IsChecked="False" />
                        </StackPanel>

                        <!-- Export Format -->
                        <ComboBox x:Name="ExportFormatCombo"
                                  Grid.Row="1" Grid.Column="0"
                                  Header="Export Format"
                                  HorizontalAlignment="Stretch"
                                  SelectedIndex="0">
                            <ComboBoxItem Content="CSV (Comma-Separated)" Tag="csv" />
                            <ComboBoxItem Content="Parquet (Columnar)" Tag="parquet" />
                            <ComboBoxItem Content="JSON Lines" Tag="jsonl" />
                            <ComboBoxItem Content="HDF5 (Hierarchical)" Tag="hdf5" />
                            <ComboBoxItem Content="Feather (Arrow IPC)" Tag="feather" />
                        </ComboBox>

                        <!-- Compression -->
                        <ComboBox x:Name="CompressionCombo"
                                  Grid.Row="1" Grid.Column="1"
                                  Header="Compression"
                                  HorizontalAlignment="Stretch"
                                  SelectedIndex="1">
                            <ComboBoxItem Content="None" Tag="none" />
                            <ComboBoxItem Content="Gzip" Tag="gzip" />
                            <ComboBoxItem Content="LZ4 (Fast)" Tag="lz4" />
                            <ComboBoxItem Content="Zstd (Best)" Tag="zstd" />
                        </ComboBox>

                        <!-- Export Button -->
                        <StackPanel Grid.Row="1" Grid.Column="2"
                                    Orientation="Horizontal" Spacing="8"
                                    VerticalAlignment="Bottom">
                            <Button x:Name="ExportButton"
                                    Content="Export Data"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="ExportData_Click" />
                            <ProgressRing x:Name="ExportProgress" IsActive="False" Width="20" Height="20" />
                        </StackPanel>
                    </Grid>

                    <!-- Export Progress -->
                    <StackPanel x:Name="ExportProgressPanel" Visibility="Collapsed" Spacing="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="ExportProgressLabel" Grid.Column="0" Text="Exporting AAPL trades..." />
                            <TextBlock x:Name="ExportProgressPercent" Grid.Column="1" Text="45%" />
                        </Grid>
                        <ProgressBar x:Name="ExportProgressBar" Minimum="0" Maximum="100" Value="45" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Database Export -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE968;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Database Export" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                             Title="Direct Database Export"
                             Message="Export market data directly to your database for analysis and backtesting." />

                    <Grid ColumnSpacing="16" RowSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <ComboBox x:Name="DatabaseTypeCombo"
                                  Grid.Row="0" Grid.Column="0"
                                  Header="Database Type"
                                  HorizontalAlignment="Stretch"
                                  SelectedIndex="0"
                                  SelectionChanged="DatabaseType_SelectionChanged">
                            <ComboBoxItem Content="PostgreSQL" Tag="postgresql" />
                            <ComboBoxItem Content="TimescaleDB" Tag="timescaledb" />
                            <ComboBoxItem Content="ClickHouse" Tag="clickhouse" />
                            <ComboBoxItem Content="QuestDB" Tag="questdb" />
                            <ComboBoxItem Content="InfluxDB" Tag="influxdb" />
                            <ComboBoxItem Content="SQLite" Tag="sqlite" />
                        </ComboBox>

                        <TextBox x:Name="DatabaseHostBox"
                                 Grid.Row="0" Grid.Column="1"
                                 Header="Host"
                                 PlaceholderText="localhost" />

                        <NumberBox x:Name="DatabasePortBox"
                                   Grid.Row="1" Grid.Column="0"
                                   Header="Port"
                                   Value="5432"
                                   SpinButtonPlacementMode="Inline" />

                        <TextBox x:Name="DatabaseNameBox"
                                 Grid.Row="1" Grid.Column="1"
                                 Header="Database Name"
                                 PlaceholderText="market_data" />

                        <TextBox x:Name="DatabaseUserBox"
                                 Grid.Row="2" Grid.Column="0"
                                 Header="Username"
                                 PlaceholderText="postgres" />

                        <StackPanel Grid.Row="2" Grid.Column="1" Spacing="8">
                            <TextBlock Text="Password" Style="{StaticResource CaptionTextBlockStyle}" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="Set Credentials" Click="SetDatabaseCredentials_Click" />
                                <TextBlock x:Name="DbCredentialStatus" Text="Not configured"
                                           VerticalAlignment="Center"
                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                            </StackPanel>
                        </StackPanel>
                    </Grid>

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button Content="Test Connection" Click="TestDatabaseConnection_Click" />
                        <Button Content="Configure Sync" Click="ConfigureDatabaseSync_Click"
                                Style="{StaticResource AccentButtonStyle}" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Scheduled Exports -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE823;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Scheduled Exports" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <ToggleSwitch x:Name="EnableScheduledExportsToggle"
                                  Header="Enable Scheduled Exports"
                                  OffContent="Disabled"
                                  OnContent="Enabled"
                                  IsOn="False" />

                    <Grid ColumnSpacing="16" RowSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <ComboBox x:Name="ScheduleFrequencyCombo"
                                  Grid.Column="0"
                                  Header="Frequency"
                                  HorizontalAlignment="Stretch"
                                  SelectedIndex="1">
                            <ComboBoxItem Content="Hourly" Tag="hourly" />
                            <ComboBoxItem Content="Daily" Tag="daily" />
                            <ComboBoxItem Content="Weekly" Tag="weekly" />
                            <ComboBoxItem Content="Monthly" Tag="monthly" />
                        </ComboBox>

                        <TimePicker x:Name="ScheduleTimePicker"
                                    Grid.Column="1"
                                    Header="Time (Local)"
                                    ClockIdentifier="24HourClock" />

                        <TextBox x:Name="ExportDestinationBox"
                                 Grid.Column="2"
                                 Header="Destination Path"
                                 PlaceholderText="C:\Exports\MarketData" />
                    </Grid>

                    <!-- Email Delivery -->
                    <Expander Header="Email Delivery (Optional)" IsExpanded="False" HorizontalAlignment="Stretch">
                        <StackPanel Spacing="12" Padding="0,8,0,0">
                            <TextBox x:Name="EmailRecipientsBox"
                                     Header="Recipients (comma-separated)"
                                     PlaceholderText="analyst@company.com, trader@company.com" />

                            <TextBox x:Name="EmailSubjectBox"
                                     Header="Subject Template"
                                     Text="Market Data Export - {date}" />

                            <CheckBox x:Name="AttachExportCheck"
                                      Content="Attach export file (if under 25MB)"
                                      IsChecked="True" />
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </Border>

            <!-- Webhook Integration -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE704;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Webhook Integration" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <TextBlock Text="Send real-time events to external systems via webhooks."
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <ToggleSwitch x:Name="EnableWebhooksToggle"
                                  Header="Enable Webhooks"
                                  OffContent="Disabled"
                                  OnContent="Enabled"
                                  IsOn="False" />

                    <TextBox x:Name="WebhookUrlBox"
                             Header="Webhook URL"
                             PlaceholderText="https://api.yourservice.com/webhook/market-data" />

                    <Grid ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <ComboBox x:Name="WebhookFormatCombo"
                                  Grid.Column="0"
                                  Header="Payload Format"
                                  HorizontalAlignment="Stretch"
                                  SelectedIndex="0">
                            <ComboBoxItem Content="JSON" Tag="json" />
                            <ComboBoxItem Content="MessagePack" Tag="msgpack" />
                            <ComboBoxItem Content="Protobuf" Tag="protobuf" />
                        </ComboBox>

                        <ComboBox x:Name="WebhookBatchCombo"
                                  Grid.Column="1"
                                  Header="Batching"
                                  HorizontalAlignment="Stretch"
                                  SelectedIndex="1">
                            <ComboBoxItem Content="Real-time (each event)" Tag="realtime" />
                            <ComboBoxItem Content="Micro-batch (100ms)" Tag="microbatch" />
                            <ComboBoxItem Content="Batch (1 second)" Tag="batch" />
                            <ComboBoxItem Content="Bulk (1 minute)" Tag="bulk" />
                        </ComboBox>
                    </Grid>

                    <StackPanel Spacing="8">
                        <TextBlock Text="Event Types to Send" Style="{StaticResource CaptionTextBlockStyle}" />
                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <CheckBox Content="Trades" IsChecked="True" />
                            <CheckBox Content="Quotes" IsChecked="True" />
                            <CheckBox Content="Depth Updates" IsChecked="False" />
                            <CheckBox Content="Integrity Alerts" IsChecked="True" />
                        </StackPanel>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button Content="Test Webhook" Click="TestWebhook_Click" />
                        <TextBlock x:Name="WebhookTestResult"
                                   VerticalAlignment="Center"
                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- QuantConnect Lean Integration -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE9F5;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="QuantConnect Lean Export" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <TextBlock Text="Export data in QuantConnect Lean format for algorithmic backtesting."
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <Grid ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="LeanDataPathBox"
                                 Grid.Column="0"
                                 Header="Lean Data Folder"
                                 PlaceholderText="C:\QuantConnect\Data" />
                        <Button Grid.Column="1" Content="Browse..."
                                VerticalAlignment="Bottom"
                                Click="BrowseLeanPath_Click" />
                    </Grid>

                    <ComboBox x:Name="LeanResolutionCombo"
                              Header="Resolution"
                              HorizontalAlignment="Stretch"
                              SelectedIndex="2">
                        <ComboBoxItem Content="Tick" Tag="tick" />
                        <ComboBoxItem Content="Second" Tag="second" />
                        <ComboBoxItem Content="Minute" Tag="minute" />
                        <ComboBoxItem Content="Hour" Tag="hour" />
                        <ComboBoxItem Content="Daily" Tag="daily" />
                    </ComboBox>

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button Content="Export to Lean Format"
                                Style="{StaticResource AccentButtonStyle}"
                                Click="ExportToLean_Click" />
                        <Button Content="Verify Lean Data" Click="VerifyLeanData_Click" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Export History -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE81C;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Export History" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <ListView x:Name="ExportHistoryList"
                              SelectionMode="None"
                              MaxHeight="200">
                        <ListView.HeaderTemplate>
                            <DataTemplate>
                                <Grid Padding="8,4" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="Timestamp" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="Format" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="Symbols" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="3" Text="Size" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="4" Text="Destination" FontWeight="SemiBold" />
                                </Grid>
                            </DataTemplate>
                        </ListView.HeaderTemplate>
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="{Binding Timestamp}" />
                                    <TextBlock Grid.Column="1" Text="{Binding Format}" />
                                    <TextBlock Grid.Column="2" Text="{Binding SymbolCount}" />
                                    <TextBlock Grid.Column="3" Text="{Binding Size}" />
                                    <TextBlock Grid.Column="4" Text="{Binding Destination}"
                                               TextTrimming="CharacterEllipsis"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <TextBlock x:Name="NoExportHistoryText"
                               Text="No exports recorded yet."
                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                </StackPanel>
            </Border>

            <InfoBar x:Name="ActionInfoBar" IsOpen="False" IsClosable="True" />
        </StackPanel>
    </ScrollViewer>
</Page>
