<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.DataBrowserPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:controls="using:MarketDataCollector.Uwp.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Navigation Tree -->
        <Border Grid.Column="0" Background="{ThemeResource LayerFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" Padding="16,16,16,8">
                    <StackPanel Spacing="12">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8B7;" FontSize="20" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Data Browser" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>
                        <AutoSuggestBox x:Name="SearchBox" PlaceholderText="Search symbols..."
                                        QueryIcon="Find" QuerySubmitted="SearchBox_QuerySubmitted" />
                    </StackPanel>
                </Border>

                <!-- Quick Filters -->
                <Border Grid.Row="1" Padding="16,8,16,8">
                    <StackPanel Spacing="8">
                        <TextBlock Text="Quick Filters" FontWeight="SemiBold" FontSize="12"
                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ToggleButton x:Name="FilterHistoricalToggle" Content="Historical" IsChecked="True"
                                          Click="Filter_Click" />
                            <ToggleButton x:Name="FilterLiveToggle" Content="Live"
                                          Click="Filter_Click" />
                            <ToggleButton x:Name="FilterArchiveToggle" Content="Archive"
                                          Click="Filter_Click" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Tree View -->
                <TreeView x:Name="DataTreeView" Grid.Row="2" Padding="8"
                          SelectionMode="Single" ItemInvoked="DataTreeView_ItemInvoked">
                    <TreeView.ItemTemplate>
                        <DataTemplate>
                            <TreeViewItem ItemsSource="{Binding Children}" IsExpanded="{Binding IsExpanded}">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon Glyph="{Binding Icon}" FontSize="14"
                                              Foreground="{ThemeResource SystemAccentColor}" />
                                    <TextBlock Text="{Binding Name}" />
                                    <TextBlock Text="{Binding Badge}" FontSize="10"
                                               Foreground="{ThemeResource SystemBaseMediumColor}"
                                               Visibility="{Binding HasBadge}" />
                                </StackPanel>
                            </TreeViewItem>
                        </DataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>

                <!-- Storage Summary -->
                <Border Grid.Row="3" Padding="16" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}">
                    <StackPanel Spacing="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Total Storage" FontWeight="SemiBold" />
                            <TextBlock x:Name="TotalStorageText" Grid.Column="1" Text="0 MB" />
                        </Grid>
                        <ProgressBar x:Name="StorageUsageBar" Value="0" Maximum="100" Height="4" />
                        <TextBlock x:Name="StorageDetailsText" Text="0 files | 0 symbols"
                                   FontSize="11" Foreground="{ThemeResource SystemBaseMediumColor}" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Right Panel: Content Area -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Toolbar -->
            <Border Grid.Row="0" Padding="16" Background="{ThemeResource LayerFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Breadcrumb -->
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <Button x:Name="BreadcrumbRoot" Content="Data" Click="Breadcrumb_Click" Tag="root"
                                Background="Transparent" Padding="8,4" />
                        <TextBlock x:Name="Breadcrumb1" Text=">" VerticalAlignment="Center"
                                   Visibility="Collapsed" Margin="4,0" />
                        <Button x:Name="BreadcrumbLevel1" Visibility="Collapsed" Click="Breadcrumb_Click"
                                Background="Transparent" Padding="8,4" />
                        <TextBlock x:Name="Breadcrumb2" Text=">" VerticalAlignment="Center"
                                   Visibility="Collapsed" Margin="4,0" />
                        <Button x:Name="BreadcrumbLevel2" Visibility="Collapsed" Click="Breadcrumb_Click"
                                Background="Transparent" Padding="8,4" />
                    </StackPanel>

                    <!-- Actions -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                        <Button Click="Refresh_Click" ToolTipService.ToolTip="Refresh">
                            <FontIcon Glyph="&#xE72C;" FontSize="14" />
                        </Button>
                        <Button x:Name="ExportButton" Click="Export_Click" ToolTipService.ToolTip="Export Selected">
                            <FontIcon Glyph="&#xEDE1;" FontSize="14" />
                        </Button>
                        <Button x:Name="DeleteButton" Click="Delete_Click" ToolTipService.ToolTip="Delete Selected">
                            <FontIcon Glyph="&#xE74D;" FontSize="14" />
                        </Button>
                        <ComboBox x:Name="ViewModeCombo" Width="120" SelectionChanged="ViewMode_Changed">
                            <ComboBoxItem Content="Grid View" Tag="Grid" IsSelected="True" />
                            <ComboBoxItem Content="Calendar View" Tag="Calendar" />
                            <ComboBoxItem Content="Chart View" Tag="Chart" />
                        </ComboBox>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Content Views -->
            <Grid Grid.Row="1">
                <!-- Empty State -->
                <StackPanel x:Name="EmptyStatePanel" HorizontalAlignment="Center" VerticalAlignment="Center"
                            Spacing="16" Visibility="Collapsed">
                    <FontIcon Glyph="&#xE8B7;" FontSize="64" Foreground="{ThemeResource SystemBaseMediumColor}" />
                    <TextBlock Text="No Data Selected" Style="{StaticResource SubtitleTextBlockStyle}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Select a symbol or date range from the tree to view data"
                               Foreground="{ThemeResource SystemBaseMediumColor}"
                               HorizontalAlignment="Center" />
                    <Button Content="Start Backfill Wizard" Style="{StaticResource AccentButtonStyle}"
                            Click="StartWizard_Click" />
                </StackPanel>

                <!-- Grid View -->
                <Grid x:Name="GridViewPanel">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Selected Item Info -->
                    <Border Grid.Row="0" Margin="16,16,16,0" Style="{StaticResource CardStyle}">
                        <Grid ColumnSpacing="24">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock x:Name="SelectedItemTitle" Text="All Data"
                                           Style="{StaticResource SubtitleTextBlockStyle}" />
                                <TextBlock x:Name="SelectedItemSubtitle"
                                           Text="Browse your historical market data"
                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                            </StackPanel>

                            <StackPanel Grid.Column="1" Spacing="4" Margin="24,0">
                                <TextBlock x:Name="StatsBarsText" Text="0" Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="{ThemeResource SystemAccentColor}" />
                                <TextBlock Text="Total Bars" Style="{StaticResource CaptionTextBlockStyle}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2" Spacing="4" Margin="24,0">
                                <TextBlock x:Name="StatsFilesText" Text="0" Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#48BB78" />
                                <TextBlock Text="Files" Style="{StaticResource CaptionTextBlockStyle}" />
                            </StackPanel>

                            <StackPanel Grid.Column="3" Spacing="4" Margin="24,0">
                                <TextBlock x:Name="StatsSizeText" Text="0 MB" Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#ED8936" />
                                <TextBlock Text="Size" Style="{StaticResource CaptionTextBlockStyle}" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Data Grid -->
                    <ListView x:Name="DataListView" Grid.Row="1" Margin="16" SelectionMode="Extended"
                              SelectionChanged="DataListView_SelectionChanged">
                        <ListView.Header>
                            <Grid Padding="12,8" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="80" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Symbol" FontWeight="SemiBold" />
                                <TextBlock Grid.Column="1" Text="Date" FontWeight="SemiBold" />
                                <TextBlock Grid.Column="2" Text="Type" FontWeight="SemiBold" />
                                <TextBlock Grid.Column="3" Text="Provider" FontWeight="SemiBold" />
                                <TextBlock Grid.Column="4" Text="Bars" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                <TextBlock Grid.Column="5" Text="Size" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                <TextBlock Grid.Column="6" Text="Actions" FontWeight="SemiBold" HorizontalAlignment="Center" />
                            </Grid>
                        </ListView.Header>
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="12,8" ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="80" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="{Binding Symbol}" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="{Binding DateText}" />
                                    <Border Grid.Column="2" Background="{Binding TypeColor}" CornerRadius="4"
                                            Padding="8,2" HorizontalAlignment="Left">
                                        <TextBlock Text="{Binding DataType}" FontSize="11" />
                                    </Border>
                                    <TextBlock Grid.Column="3" Text="{Binding Provider}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    <TextBlock Grid.Column="4" Text="{Binding BarCountText}" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Column="5" Text="{Binding SizeText}" HorizontalAlignment="Right"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    <Button Grid.Column="6" Content="Preview" FontSize="11" Padding="8,4"
                                            Click="Preview_Click" Tag="{Binding}" HorizontalAlignment="Center" />
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Pagination -->
                    <Border Grid.Row="2" Margin="16,0,16,16" Padding="12" Style="{StaticResource CardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="PaginationText" Text="Showing 1-50 of 1,234 items"
                                       VerticalAlignment="Center" />
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                <Button x:Name="PrevPageButton" Content="Previous" Click="PrevPage_Click" />
                                <Button x:Name="NextPageButton" Content="Next" Click="NextPage_Click" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Calendar View -->
                <Grid x:Name="CalendarViewPanel" Visibility="Collapsed" Margin="16">
                    <controls:DataCoverageCalendar x:Name="CoverageCalendar" />
                </Grid>

                <!-- Chart View -->
                <Grid x:Name="ChartViewPanel" Visibility="Collapsed" Margin="16">
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel Spacing="16">
                            <TextBlock Text="Data Coverage Over Time" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <!-- Simple bar chart representation -->
                            <Grid Height="200">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <ItemsControl x:Name="ChartBarsControl">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal" Spacing="4" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Width="30" VerticalAlignment="Bottom" Spacing="4">
                                                <Border Background="{ThemeResource SystemAccentColor}"
                                                        Height="{Binding Height}" CornerRadius="2,2,0,0" />
                                                <TextBlock Text="{Binding Label}" FontSize="9"
                                                           HorizontalAlignment="Center"
                                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>
                            <TextBlock Text="Monthly data volume (bars downloaded)"
                                       HorizontalAlignment="Center" FontSize="11"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Preview Panel (Flyout) -->
                <Grid x:Name="PreviewPanel" Visibility="Collapsed" Background="{ThemeResource LayerFillColorDefaultBrush}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Padding="16" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <StackPanel>
                                <TextBlock x:Name="PreviewTitle" Text="Data Preview"
                                           Style="{StaticResource SubtitleTextBlockStyle}" />
                                <TextBlock x:Name="PreviewSubtitle" Text="AAPL - 2024-01-15"
                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                            </StackPanel>
                            <Button Grid.Column="1" Content="Close" Click="ClosePreview_Click" />
                        </Grid>
                    </Border>

                    <ScrollViewer Grid.Row="1" Padding="16">
                        <StackPanel Spacing="16">
                            <!-- Preview Stats -->
                            <Grid ColumnSpacing="24">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                                    <StackPanel Spacing="4">
                                        <TextBlock x:Name="PreviewOpenText" Text="$150.25"
                                                   Style="{StaticResource SubheaderTextBlockStyle}" />
                                        <TextBlock Text="Open" Style="{StaticResource CaptionTextBlockStyle}" />
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="1" Style="{StaticResource CardStyle}">
                                    <StackPanel Spacing="4">
                                        <TextBlock x:Name="PreviewHighText" Text="$152.30"
                                                   Style="{StaticResource SubheaderTextBlockStyle}" Foreground="#48BB78" />
                                        <TextBlock Text="High" Style="{StaticResource CaptionTextBlockStyle}" />
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="2" Style="{StaticResource CardStyle}">
                                    <StackPanel Spacing="4">
                                        <TextBlock x:Name="PreviewLowText" Text="$149.80"
                                                   Style="{StaticResource SubheaderTextBlockStyle}" Foreground="#F56565" />
                                        <TextBlock Text="Low" Style="{StaticResource CaptionTextBlockStyle}" />
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="3" Style="{StaticResource CardStyle}">
                                    <StackPanel Spacing="4">
                                        <TextBlock x:Name="PreviewCloseText" Text="$151.50"
                                                   Style="{StaticResource SubheaderTextBlockStyle}" />
                                        <TextBlock Text="Close" Style="{StaticResource CaptionTextBlockStyle}" />
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <!-- Raw Data Preview -->
                            <Border Style="{StaticResource CardStyle}">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Raw Data (First 10 rows)" FontWeight="SemiBold" />
                                    <ScrollViewer HorizontalScrollBarVisibility="Auto" MaxHeight="300">
                                        <TextBlock x:Name="PreviewRawData" FontFamily="Consolas" FontSize="11"
                                                   IsTextSelectionEnabled="True" />
                                    </ScrollViewer>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</Page>
