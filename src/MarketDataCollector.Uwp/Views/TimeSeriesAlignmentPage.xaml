<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.TimeSeriesAlignmentPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24" MaxWidth="1200">
            <!-- Header -->
            <StackPanel Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE9D9;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                <StackPanel>
                    <TextBlock Text="Time Series Alignment" Style="{StaticResource TitleTextBlockStyle}" />
                    <TextBlock Text="Align tick data to regular intervals and generate OHLCV bars for analysis"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                </StackPanel>
            </StackPanel>

            <!-- Quick Presets -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8F1;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Quick Presets" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <GridView x:Name="PresetsGrid"
                              SelectionMode="Single"
                              IsItemClickEnabled="True"
                              ItemClick="Preset_Click">
                        <GridView.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Padding="16"
                                        Width="180"
                                        Height="90">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="{Binding Name}"
                                                   Style="{StaticResource BodyStrongTextBlockStyle}"
                                                   TextTrimming="CharacterEllipsis" />
                                        <TextBlock Text="{Binding Description}"
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                                   TextWrapping="Wrap"
                                                   MaxLines="2" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </GridView.ItemTemplate>
                    </GridView>
                </StackPanel>
            </Border>

            <!-- Configuration -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE713;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Alignment Configuration" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Grid ColumnSpacing="24" RowSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!-- Symbol Selection -->
                        <StackPanel Grid.Row="0" Grid.Column="0" Spacing="8">
                            <TextBlock Text="Symbols" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <AutoSuggestBox x:Name="SymbolSearchBox"
                                            PlaceholderText="Search symbols..."
                                            QueryIcon="Find" />
                            <ListView x:Name="SymbolsList"
                                      Height="120"
                                      SelectionMode="Multiple"
                                      SelectionChanged="Symbols_SelectionChanged">
                                <ListViewItem Content="AAPL" IsSelected="True" />
                                <ListViewItem Content="MSFT" IsSelected="True" />
                                <ListViewItem Content="GOOGL" />
                                <ListViewItem Content="AMZN" />
                                <ListViewItem Content="SPY" IsSelected="True" />
                            </ListView>
                            <TextBlock x:Name="SelectedSymbolsCount"
                                       Text="3 symbols selected"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <!-- Date Range -->
                        <StackPanel Grid.Row="0" Grid.Column="1" Spacing="8">
                            <TextBlock Text="Date Range" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <CalendarDatePicker x:Name="FromDatePicker"
                                                Header="From"
                                                HorizontalAlignment="Stretch"
                                                PlaceholderText="Start date" />
                            <CalendarDatePicker x:Name="ToDatePicker"
                                                Header="To"
                                                HorizontalAlignment="Stretch"
                                                PlaceholderText="End date" />
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <Button Content="Week" Click="SetWeek_Click" />
                                <Button Content="Month" Click="SetMonth_Click" />
                                <Button Content="Quarter" Click="SetQuarter_Click" />
                            </StackPanel>
                        </StackPanel>

                        <!-- Interval & Aggregation -->
                        <StackPanel Grid.Row="0" Grid.Column="2" Spacing="8">
                            <TextBlock Text="Interval &amp; Aggregation" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <ComboBox x:Name="IntervalCombo"
                                      Header="Time Interval"
                                      HorizontalAlignment="Stretch"
                                      SelectedIndex="4"
                                      SelectionChanged="Interval_SelectionChanged">
                                <ComboBoxItem Content="1 Second" Tag="Second1" />
                                <ComboBoxItem Content="5 Seconds" Tag="Second5" />
                                <ComboBoxItem Content="10 Seconds" Tag="Second10" />
                                <ComboBoxItem Content="30 Seconds" Tag="Second30" />
                                <ComboBoxItem Content="1 Minute" Tag="Minute1" />
                                <ComboBoxItem Content="5 Minutes" Tag="Minute5" />
                                <ComboBoxItem Content="15 Minutes" Tag="Minute15" />
                                <ComboBoxItem Content="30 Minutes" Tag="Minute30" />
                                <ComboBoxItem Content="1 Hour" Tag="Hour1" />
                                <ComboBoxItem Content="4 Hours" Tag="Hour4" />
                                <ComboBoxItem Content="Daily" Tag="Daily" />
                            </ComboBox>
                            <ComboBox x:Name="AggregationCombo"
                                      Header="Aggregation Method"
                                      HorizontalAlignment="Stretch"
                                      SelectedIndex="0">
                                <ComboBoxItem Content="OHLCV Bars" Tag="OHLCV" />
                                <ComboBoxItem Content="Last Value" Tag="Last" />
                                <ComboBoxItem Content="First Value" Tag="First" />
                                <ComboBoxItem Content="Mean" Tag="Mean" />
                                <ComboBoxItem Content="VWAP" Tag="VWAP" />
                                <ComboBoxItem Content="TWAP" Tag="TWAP" />
                                <ComboBoxItem Content="Sum" Tag="Sum" />
                                <ComboBoxItem Content="Count" Tag="Count" />
                            </ComboBox>
                        </StackPanel>

                        <!-- Gap Handling -->
                        <StackPanel Grid.Row="1" Grid.Column="0" Spacing="8">
                            <TextBlock Text="Gap Handling" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <ComboBox x:Name="GapStrategyCombo"
                                      Header="Gap Strategy"
                                      HorizontalAlignment="Stretch"
                                      SelectedIndex="0">
                                <ComboBoxItem Content="Forward Fill" Tag="ForwardFill" />
                                <ComboBoxItem Content="Backward Fill" Tag="BackwardFill" />
                                <ComboBoxItem Content="Linear Interpolation" Tag="LinearInterpolate" />
                                <ComboBoxItem Content="Null / NaN" Tag="Null" />
                                <ComboBoxItem Content="Zero" Tag="Zero" />
                                <ComboBoxItem Content="Skip Gaps" Tag="Skip" />
                            </ComboBox>
                            <NumberBox x:Name="MaxGapBox"
                                       Header="Max Gap Intervals to Fill"
                                       Value="5"
                                       Minimum="0"
                                       Maximum="100"
                                       SpinButtonPlacementMode="Inline" />
                        </StackPanel>

                        <!-- Market Hours & Timezone -->
                        <StackPanel Grid.Row="1" Grid.Column="1" Spacing="8">
                            <TextBlock Text="Time Settings" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <ComboBox x:Name="TimezoneCombo"
                                      Header="Timezone"
                                      HorizontalAlignment="Stretch"
                                      SelectedIndex="0">
                                <ComboBoxItem Content="America/New_York (ET)" Tag="America/New_York" />
                                <ComboBoxItem Content="America/Chicago (CT)" Tag="America/Chicago" />
                                <ComboBoxItem Content="America/Los_Angeles (PT)" Tag="America/Los_Angeles" />
                                <ComboBoxItem Content="UTC" Tag="UTC" />
                                <ComboBoxItem Content="Europe/London" Tag="Europe/London" />
                                <ComboBoxItem Content="Asia/Tokyo" Tag="Asia/Tokyo" />
                            </ComboBox>
                            <CheckBox x:Name="MarketHoursOnlyCheck"
                                      Content="Market hours only (9:30-16:00)"
                                      IsChecked="True" />
                            <CheckBox x:Name="MarkFilledCheck"
                                      Content="Mark filled values"
                                      ToolTipService.ToolTip="Add flag column to indicate interpolated data" />
                        </StackPanel>

                        <!-- Output Settings -->
                        <StackPanel Grid.Row="1" Grid.Column="2" Spacing="8">
                            <TextBlock Text="Output" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <ComboBox x:Name="OutputFormatCombo"
                                      Header="Format"
                                      HorizontalAlignment="Stretch"
                                      SelectedIndex="1">
                                <ComboBoxItem Content="CSV" Tag="CSV" />
                                <ComboBoxItem Content="Parquet" Tag="Parquet" />
                                <ComboBoxItem Content="JSON Lines" Tag="JSONL" />
                                <ComboBoxItem Content="Feather" Tag="Feather" />
                            </ComboBox>
                            <CheckBox x:Name="IncludeMetadataCheck"
                                      Content="Include alignment metadata"
                                      IsChecked="True" />
                        </StackPanel>

                        <!-- Output Path -->
                        <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" ColumnSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="OutputPathBox"
                                     Grid.Column="0"
                                     Header="Output Path"
                                     PlaceholderText="C:\AlignedData\ohlcv_1min.parquet" />
                            <Button Grid.Column="1" Content="Browse..." VerticalAlignment="Bottom" Click="BrowseOutput_Click" />
                        </Grid>

                        <!-- Preview and Align -->
                        <StackPanel Grid.Row="2" Grid.Column="2" Spacing="8" VerticalAlignment="Bottom">
                            <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                    CornerRadius="8"
                                    Padding="12">
                                <Grid RowSpacing="4">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Output records:" FontSize="12" />
                                    <TextBlock x:Name="EstOutputRecords" Grid.Row="0" Grid.Column="1" Text="~23,400" FontSize="12" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Expected gaps:" FontSize="12" />
                                    <TextBlock x:Name="EstGaps" Grid.Row="1" Grid.Column="1" Text="~120" FontSize="12" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Est. file size:" FontSize="12" />
                                    <TextBlock x:Name="EstFileSize" Grid.Row="2" Grid.Column="1" Text="~2.3 MB" FontSize="12" HorizontalAlignment="Right" />
                                </Grid>
                            </Border>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="Preview" Click="Preview_Click" />
                                <Button x:Name="AlignButton"
                                        Content="Align Data"
                                        Style="{StaticResource AccentButtonStyle}"
                                        Click="Align_Click" />
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Progress Panel -->
            <Border x:Name="ProgressPanel" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <ProgressRing IsActive="True" Width="24" Height="24" />
                        <TextBlock Text="Aligning Time Series Data..." Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="ProgressLabel" Grid.Column="0" Text="Processing AAPL..." />
                        <TextBlock x:Name="ProgressPercent" Grid.Column="1" Text="45%" />
                    </Grid>
                    <ProgressBar x:Name="ProgressBar" Minimum="0" Maximum="100" Value="45" />
                    <Button Content="Cancel" Click="Cancel_Click" />
                </StackPanel>
            </Border>

            <!-- Results Panel -->
            <Border x:Name="ResultsPanel" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE73E;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Alignment Complete" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>
                        <Button Grid.Column="1" Content="Close" Click="CloseResults_Click" />
                    </Grid>

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Summary Stats -->
                        <Border Grid.Column="0"
                                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                CornerRadius="8"
                                Padding="16">
                            <StackPanel Spacing="12">
                                <TextBlock Text="Summary" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                <Grid RowSpacing="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Source records:" />
                                    <TextBlock x:Name="ResultSourceRecords" Grid.Row="0" Grid.Column="1" Text="1,500,000" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Aligned records:" />
                                    <TextBlock x:Name="ResultAlignedRecords" Grid.Row="1" Grid.Column="1" Text="23,400" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Compression:" />
                                    <TextBlock x:Name="ResultCompression" Grid.Row="2" Grid.Column="1" Text="64x" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Duration:" />
                                    <TextBlock x:Name="ResultDuration" Grid.Row="3" Grid.Column="1" Text="3.2s" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Gap Analysis -->
                        <Border Grid.Column="1"
                                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                CornerRadius="8"
                                Padding="16">
                            <StackPanel Spacing="12">
                                <TextBlock Text="Gap Analysis" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                <Grid RowSpacing="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Gaps detected:" />
                                    <TextBlock x:Name="ResultGapsDetected" Grid.Row="0" Grid.Column="1" Text="120" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Gaps filled:" />
                                    <TextBlock x:Name="ResultGapsFilled" Grid.Row="1" Grid.Column="1" Text="118" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Coverage:" />
                                    <TextBlock x:Name="ResultCoverage" Grid.Row="2" Grid.Column="1" Text="99.5%" FontWeight="SemiBold" Foreground="{ThemeResource SystemAccentColor}" HorizontalAlignment="Right" />
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Output Info -->
                        <Border Grid.Column="2"
                                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                CornerRadius="8"
                                Padding="16">
                            <StackPanel Spacing="12">
                                <TextBlock Text="Output" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                <TextBlock x:Name="ResultOutputPath"
                                           Text="C:\AlignedData\ohlcv_1min.parquet"
                                           TextWrapping="Wrap"
                                           Style="{StaticResource CaptionTextBlockStyle}" />
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Button Content="Open Folder" Click="OpenFolder_Click" />
                                    <Button Content="Open File" Click="OpenFile_Click" />
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Visual Guide -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE946;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Alignment Visualization" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="60" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Before (Irregular Ticks) -->
                        <StackPanel Grid.Column="0" Spacing="8">
                            <TextBlock Text="Source: Irregular Ticks" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                    CornerRadius="8"
                                    Height="100"
                                    Padding="8">
                                <Canvas x:Name="IrregularCanvas" />
                            </Border>
                            <TextBlock Text="Variable intervals, gaps, high frequency"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <!-- Arrow -->
                        <FontIcon Grid.Column="1"
                                  Glyph="&#xE72A;"
                                  FontSize="32"
                                  VerticalAlignment="Center"
                                  Foreground="{ThemeResource SystemAccentColor}" />

                        <!-- After (Aligned) -->
                        <StackPanel Grid.Column="2" Spacing="8">
                            <TextBlock Text="Output: Regular Intervals" Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                    CornerRadius="8"
                                    Height="100"
                                    Padding="8">
                                <Canvas x:Name="RegularCanvas" />
                            </Border>
                            <TextBlock Text="Fixed intervals, filled gaps, consistent timing"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <InfoBar x:Name="ActionInfoBar" IsOpen="False" IsClosable="True" />
        </StackPanel>
    </ScrollViewer>
</Page>
