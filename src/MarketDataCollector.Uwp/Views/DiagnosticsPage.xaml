<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.DiagnosticsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24" MaxWidth="1200">
            <!-- Header -->
            <StackPanel Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE9D9;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                <TextBlock Text="System Diagnostics" Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center" />
            </StackPanel>

            <TextBlock Text="Run diagnostics to validate configuration, check system health, and generate troubleshooting bundles."
                       Style="{StaticResource BodyTextBlockStyle}"
                       Foreground="{ThemeResource SystemBaseMediumColor}" />

            <!-- Quick Actions -->
            <Grid ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Preflight Check -->
                <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE73E;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Preflight Check" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <TextBlock Text="Verify system readiness before starting data collection."
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                   TextWrapping="Wrap" />

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button x:Name="PreflightButton"
                                    Content="Run Preflight"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="RunPreflight_Click" />
                            <ProgressRing x:Name="PreflightProgress" IsActive="False" Width="24" Height="24" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Dry Run -->
                <Border Grid.Column="1" Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE768;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Dry Run" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <TextBlock Text="Validate configuration without starting collection."
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                   TextWrapping="Wrap" />

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button x:Name="DryRunButton"
                                    Content="Run Dry Run"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="RunDryRun_Click" />
                            <ProgressRing x:Name="DryRunProgress" IsActive="False" Width="24" Height="24" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Diagnostic Bundle -->
                <Border Grid.Column="2" Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7B8;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Diagnostic Bundle" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <TextBlock Text="Generate a support bundle for troubleshooting."
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                   TextWrapping="Wrap" />

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button x:Name="BundleButton"
                                    Content="Create Bundle"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="CreateBundle_Click" />
                            <ProgressRing x:Name="BundleProgress" IsActive="False" Width="24" Height="24" />
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Preflight Results -->
            <Border x:Name="PreflightResultsCard" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon x:Name="PreflightResultIcon" Glyph="&#xE73E;" Foreground="#48BB78" />
                            <TextBlock Text="Preflight Results" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                            <TextBlock x:Name="PreflightPassedText" Foreground="#48BB78" VerticalAlignment="Center" />
                            <TextBlock x:Name="PreflightFailedText" Foreground="#F56565" VerticalAlignment="Center" />
                        </StackPanel>
                    </Grid>

                    <ListView x:Name="PreflightChecksList" SelectionMode="None" MaxHeight="400">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8,4" ColumnSpacing="12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="24" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="150" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <FontIcon Grid.Column="0"
                                              Glyph="{Binding StatusIcon}"
                                              Foreground="{Binding StatusColor}"
                                              FontSize="14" />
                                    <TextBlock Grid.Column="1" Text="{Binding Category}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    <TextBlock Grid.Column="2" Text="{Binding Name}" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="3" Text="{Binding Message}"
                                               TextTrimming="CharacterEllipsis" />
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Dry Run Results -->
            <Border x:Name="DryRunResultsCard" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon x:Name="DryRunResultIcon" Glyph="&#xE73E;" Foreground="#48BB78" />
                        <TextBlock Text="Dry Run Results" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Grid ColumnSpacing="24" RowSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon x:Name="ConfigValidIcon" Glyph="&#xE73E;" Foreground="#48BB78" FontSize="16" />
                                <TextBlock Text="Configuration" />
                            </StackPanel>
                            <TextBlock x:Name="ConfigValidText" Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon x:Name="CredentialsValidIcon" Glyph="&#xE73E;" Foreground="#48BB78" FontSize="16" />
                                <TextBlock Text="Credentials" />
                            </StackPanel>
                            <TextBlock x:Name="CredentialsValidText" Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon x:Name="StorageValidIcon" Glyph="&#xE73E;" Foreground="#48BB78" FontSize="16" />
                                <TextBlock Text="Storage" />
                            </StackPanel>
                            <TextBlock x:Name="StorageValidText" Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <StackPanel Grid.Column="3">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon x:Name="ProvidersValidIcon" Glyph="&#xE73E;" Foreground="#48BB78" FontSize="16" />
                                <TextBlock Text="Providers" />
                            </StackPanel>
                            <TextBlock x:Name="ProvidersValidText" Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>
                    </Grid>

                    <!-- Warnings -->
                    <StackPanel x:Name="DryRunWarningsPanel" Spacing="8" Visibility="Collapsed">
                        <TextBlock Text="Warnings" FontWeight="SemiBold" Foreground="#ED8936" />
                        <ListView x:Name="DryRunWarningsList" SelectionMode="None" MaxHeight="150">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE7BA;" Foreground="#ED8936" FontSize="12" />
                                        <TextBlock Text="{Binding}" TextWrapping="Wrap" />
                                    </StackPanel>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>

                    <!-- Errors -->
                    <StackPanel x:Name="DryRunErrorsPanel" Spacing="8" Visibility="Collapsed">
                        <TextBlock Text="Errors" FontWeight="SemiBold" Foreground="#F56565" />
                        <ListView x:Name="DryRunErrorsList" SelectionMode="None" MaxHeight="150">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xEA39;" Foreground="#F56565" FontSize="12" />
                                        <TextBlock Text="{Binding}" TextWrapping="Wrap" />
                                    </StackPanel>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Bundle Options -->
            <Border x:Name="BundleOptionsCard" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <TextBlock Text="Diagnostic Bundle Options" Style="{StaticResource SubtitleTextBlockStyle}" />

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Spacing="12">
                            <CheckBox x:Name="IncludeLogsCheck" Content="Include Logs" IsChecked="True" />
                            <CheckBox x:Name="IncludeConfigCheck" Content="Include Configuration" IsChecked="True" />
                            <CheckBox x:Name="IncludeMetricsCheck" Content="Include Metrics" IsChecked="True" />
                            <CheckBox x:Name="IncludeSampleDataCheck" Content="Include Sample Data" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Spacing="12">
                            <ComboBox x:Name="LogDaysCombo" Header="Log Days" SelectedIndex="1" HorizontalAlignment="Stretch">
                                <ComboBoxItem Content="1 day" Tag="1" />
                                <ComboBoxItem Content="7 days" Tag="7" />
                                <ComboBoxItem Content="14 days" Tag="14" />
                                <ComboBoxItem Content="30 days" Tag="30" />
                            </ComboBox>
                            <CheckBox x:Name="RedactSecretsCheck" Content="Redact Secrets" IsChecked="True" />
                        </StackPanel>
                    </Grid>

                    <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                             Title="Privacy Note"
                             Message="Secrets and sensitive data will be redacted by default. Review the bundle contents before sharing." />

                    <Button Content="Generate Bundle"
                            Style="{StaticResource AccentButtonStyle}"
                            Click="GenerateBundle_Click" />
                </StackPanel>
            </Border>

            <!-- Bundle Result -->
            <Border x:Name="BundleResultCard" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE73E;" Foreground="#48BB78" />
                        <TextBlock Text="Bundle Created" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="BundlePathBox" IsReadOnly="True" />
                        <Button Grid.Column="1" Content="Open Folder" Click="OpenBundleFolder_Click" />
                    </Grid>

                    <TextBlock x:Name="BundleSizeText" Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <ListView x:Name="BundleFilesList" SelectionMode="None" MaxHeight="200">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon Glyph="&#xE8A5;" FontSize="12" />
                                    <TextBlock Text="{Binding}" />
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Provider Tests -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE703;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Provider Connectivity" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <TextBlock Text="Test connectivity to individual data providers."
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <ComboBox x:Name="ProviderTestCombo" Header="Provider" HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Alpaca" Tag="alpaca" />
                            <ComboBoxItem Content="Interactive Brokers" Tag="ib" />
                            <ComboBoxItem Content="Polygon" Tag="polygon" />
                            <ComboBoxItem Content="Yahoo Finance" Tag="yahoo" />
                            <ComboBoxItem Content="Stooq" Tag="stooq" />
                            <ComboBoxItem Content="Tiingo" Tag="tiingo" />
                        </ComboBox>

                        <Button Grid.Column="1" Content="Test Connection"
                                VerticalAlignment="Bottom"
                                Click="TestProvider_Click" />
                    </Grid>

                    <Border x:Name="ProviderTestResult"
                            Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                            CornerRadius="4" Padding="12"
                            Visibility="Collapsed">
                        <StackPanel Spacing="4">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon x:Name="ProviderTestIcon" Glyph="&#xE73E;" FontSize="16" />
                                <TextBlock x:Name="ProviderTestStatusText" FontWeight="SemiBold" />
                            </StackPanel>
                            <TextBlock x:Name="ProviderTestDetailsText"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- System Metrics -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE770;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="System Metrics" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <Button Grid.Column="1" Content="Refresh" Click="RefreshMetrics_Click" />
                    </Grid>

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock x:Name="CpuUsageText" Text="--%"
                                       Style="{StaticResource SubheaderTextBlockStyle}"
                                       Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="CPU Usage" Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock x:Name="MemoryUsageText" Text="-- MB"
                                       Style="{StaticResource SubheaderTextBlockStyle}"
                                       Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Memory" Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock x:Name="EventsPerSecText" Text="--"
                                       Style="{StaticResource SubheaderTextBlockStyle}"
                                       Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Events/sec" Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>

                        <StackPanel Grid.Column="3">
                            <TextBlock x:Name="UptimeText" Text="--"
                                       Style="{StaticResource SubheaderTextBlockStyle}"
                                       Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Uptime" Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</Page>
