<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.RetentionAssurancePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:services="using:MarketDataCollector.Uwp.Services"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="24" Padding="0,0,24,24">
            <!-- Page Header -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Retention Assurance" Style="{StaticResource TitleTextBlockStyle}" />
                    <TextBlock Text="Manage data retention policies with guardrails, legal holds, and verification"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="Run Dry Run" Style="{StaticResource AccentButtonStyle}" Click="RunDryRun_Click" />
                    <Button Content="Export Report" Click="ExportReport_Click" />
                </StackPanel>
            </Grid>

            <!-- Safety Center Overview -->
            <Border Style="{StaticResource CardStyle}" Background="{ThemeResource SystemFillColorCautionBackgroundBrush}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <FontIcon Grid.Column="0" Glyph="&#xE7BA;" FontSize="32" Foreground="#ED8936"
                              Margin="0,0,16,0" VerticalAlignment="Center" />

                    <StackPanel Grid.Column="1" Spacing="8">
                        <TextBlock Text="Retention Safety Center" FontWeight="SemiBold" FontSize="16" />
                        <TextBlock TextWrapping="Wrap" Foreground="{ThemeResource SystemBaseMediumColor}">
                            This page combines guardrails, legal holds, and dry-run previews into a unified retention safety center.
                            All deletions require verification and generate audit reports for compliance evidence.
                        </TextBlock>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Guardrails Configuration -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE72E;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Retention Guardrails" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <TextBlock Text="Minimum retention periods to prevent accidental data loss"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <Grid ColumnSpacing="24" RowSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <NumberBox x:Name="MinTickDataDays" Grid.Row="0" Grid.Column="0"
                                   Header="Minimum Tick Data Retention (days)"
                                   Value="7" Minimum="1" Maximum="365"
                                   SpinButtonPlacementMode="Inline" />

                        <NumberBox x:Name="MinBarDataDays" Grid.Row="0" Grid.Column="1"
                                   Header="Minimum Bar Data Retention (days)"
                                   Value="30" Minimum="7" Maximum="3650"
                                   SpinButtonPlacementMode="Inline" />

                        <NumberBox x:Name="MinQuoteDataDays" Grid.Row="1" Grid.Column="0"
                                   Header="Minimum Quote Data Retention (days)"
                                   Value="7" Minimum="1" Maximum="365"
                                   SpinButtonPlacementMode="Inline" />

                        <NumberBox x:Name="MaxDailyDeletedFiles" Grid.Row="1" Grid.Column="1"
                                   Header="Maximum Daily Deleted Files"
                                   Value="1000" Minimum="10" Maximum="10000"
                                   SpinButtonPlacementMode="Inline" />

                        <CheckBox x:Name="RequireChecksumCheck" Grid.Row="2" Grid.Column="0"
                                  Content="Require checksum verification before deletion"
                                  IsChecked="True" />

                        <CheckBox x:Name="RequireDryRunCheck" Grid.Row="2" Grid.Column="1"
                                  Content="Require dry-run preview before execution"
                                  IsChecked="True" />
                    </Grid>

                    <Button Content="Save Guardrails" Click="SaveGuardrails_Click" />
                </StackPanel>
            </Border>

            <!-- Legal Holds Section -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE72E;" Foreground="#F56565" />
                            <TextBlock Text="Legal Holds" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <TextBlock x:Name="LegalHoldCount" Text="(0 active)"
                                       Foreground="{ThemeResource SystemBaseMediumColor}"
                                       VerticalAlignment="Center" />
                        </StackPanel>

                        <Button Grid.Column="1" Content="Create Legal Hold" Click="CreateLegalHold_Click" />
                    </Grid>

                    <TextBlock Text="Symbols under legal hold are excluded from all retention cleanup operations"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <TextBlock x:Name="NoLegalHoldsText" Text="No active legal holds"
                               Foreground="{ThemeResource SystemBaseMediumColor}"
                               Visibility="Visible" />

                    <ListView x:Name="LegalHoldsList" SelectionMode="None" Visibility="Collapsed">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="services:LegalHold">
                                <Border CornerRadius="4" Padding="12" Margin="0,4"
                                        Background="{ThemeResource SystemFillColorCriticalBackgroundBrush}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0" Spacing="4">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE72E;" Foreground="#F56565" FontSize="14" />
                                                <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold" />
                                            </StackPanel>
                                            <TextBlock Text="{x:Bind Reason}" TextWrapping="Wrap"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                            <StackPanel Orientation="Horizontal" Spacing="16">
                                                <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                                    <Run Text="Symbols:" />
                                                    <Run Text="{x:Bind Symbols.Count}" />
                                                </TextBlock>
                                                <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                                    <Run Text="Created:" />
                                                    <Run Text="{x:Bind CreatedAt}" />
                                                </TextBlock>
                                                <TextBlock Style="{StaticResource CaptionTextBlockStyle}"
                                                           Visibility="{x:Bind ExpiresAt}">
                                                    <Run Text="Expires:" />
                                                    <Run Text="{x:Bind ExpiresAt}" />
                                                </TextBlock>
                                            </StackPanel>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Top">
                                            <Button Content="View Symbols" Click="ViewHoldSymbols_Click" Tag="{x:Bind Id}" />
                                            <Button Content="Release" Click="ReleaseLegalHold_Click" Tag="{x:Bind Id}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Retention Policy Configuration -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE823;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Retention Policy" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <TextBlock Text="Configure how long to keep different types of data"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <Grid ColumnSpacing="24" RowSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <NumberBox x:Name="TickDataDays" Grid.Row="0" Grid.Column="0"
                                   Header="Tick Data Retention (days)"
                                   Value="30" Minimum="7" Maximum="3650"
                                   SpinButtonPlacementMode="Inline" />

                        <NumberBox x:Name="BarDataDays" Grid.Row="0" Grid.Column="1"
                                   Header="Bar Data Retention (days)"
                                   Value="365" Minimum="30" Maximum="3650"
                                   SpinButtonPlacementMode="Inline" />

                        <NumberBox x:Name="QuoteDataDays" Grid.Row="1" Grid.Column="0"
                                   Header="Quote Data Retention (days)"
                                   Value="30" Minimum="7" Maximum="3650"
                                   SpinButtonPlacementMode="Inline" />

                        <NumberBox x:Name="DepthDataDays" Grid.Row="1" Grid.Column="1"
                                   Header="Depth Data Retention (days)"
                                   Value="7" Minimum="3" Maximum="365"
                                   SpinButtonPlacementMode="Inline" />

                        <CheckBox x:Name="CompressBeforeDeleteCheck" Grid.Row="2" Grid.Column="0"
                                  Content="Compress to archive before deletion"
                                  IsChecked="True" />

                        <CheckBox x:Name="ArchiveToCloudCheck" Grid.Row="2" Grid.Column="1"
                                  Content="Archive to cloud storage before deletion"
                                  IsChecked="False" />
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Dry Run Results Section -->
            <Border Style="{StaticResource CardStyle}" x:Name="DryRunResultsSection" Visibility="Collapsed">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8A5;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Dry Run Results" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <Button Grid.Column="1" x:Name="ExecuteCleanupButton" Content="Execute Cleanup"
                                Style="{StaticResource AccentButtonStyle}" Click="ExecuteCleanup_Click" />
                    </Grid>

                    <!-- Summary Cards -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Style="{StaticResource CardStyle}"
                                Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}" Margin="0,0,4,0">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="FilesToDeleteCount" Text="0"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#F56565" HorizontalAlignment="Center" />
                                <TextBlock Text="Files to Delete" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="1" Style="{StaticResource CardStyle}"
                                Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}" Margin="4,0">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="BytesToDeleteText" Text="0 MB"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#F56565" HorizontalAlignment="Center" />
                                <TextBlock Text="Space to Free" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="2" Style="{StaticResource CardStyle}"
                                Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}" Margin="4,0">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="SymbolsAffectedCount" Text="0"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="{ThemeResource SystemAccentColor}" HorizontalAlignment="Center" />
                                <TextBlock Text="Symbols Affected" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="3" Style="{StaticResource CardStyle}"
                                Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}" Margin="4,0,0,0">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="SkippedFilesCount" Text="0"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#48BB78" HorizontalAlignment="Center" />
                                <TextBlock Text="Files Preserved" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- Files by Symbol -->
                    <Expander Header="Files by Symbol" IsExpanded="False" HorizontalAlignment="Stretch"
                              HorizontalContentAlignment="Stretch">
                        <ListView x:Name="BySymbolList" SelectionMode="None" MaxHeight="300">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8" ColumnSpacing="16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100" />
                                            <ColumnDefinition Width="80" />
                                            <ColumnDefinition Width="100" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0" Text="{Binding Symbol}" FontWeight="SemiBold" />
                                        <TextBlock Grid.Column="1" Text="{Binding FileCount}" />
                                        <TextBlock Grid.Column="2" Text="{Binding SizeFormatted}" />
                                        <TextBlock Grid.Column="3" Text="{Binding DataTypesText}"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Expander>

                    <!-- Skipped Files -->
                    <Expander Header="Skipped Files (Legal Hold)" IsExpanded="False" HorizontalAlignment="Stretch"
                              HorizontalContentAlignment="Stretch">
                        <ListView x:Name="SkippedFilesList" SelectionMode="None" MaxHeight="200">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="services:SkippedFileInfo">
                                    <Grid Padding="8" ColumnSpacing="16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="150" />
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0" Text="{x:Bind Symbol}" FontWeight="SemiBold" />
                                        <TextBlock Grid.Column="1" Text="{x:Bind Path}" TextTrimming="CharacterEllipsis" />
                                        <TextBlock Grid.Column="2" Text="{x:Bind Reason}"
                                                   Foreground="#48BB78" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Expander>

                    <!-- Validation Warnings -->
                    <Border x:Name="ValidationWarningsSection" Visibility="Collapsed"
                            Background="{ThemeResource SystemFillColorCautionBackgroundBrush}"
                            CornerRadius="4" Padding="12">
                        <StackPanel Spacing="8">
                            <TextBlock Text="Validation Warnings" FontWeight="SemiBold" />
                            <ListView x:Name="ValidationWarningsList" SelectionMode="None" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Audit Reports Section -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE9F9;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Audit Reports" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <Button Grid.Column="1" Content="Generate Attestation" Click="GenerateAttestation_Click" />
                    </Grid>

                    <TextBlock Text="Retention cleanup audit reports for compliance evidence"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <TextBlock x:Name="NoAuditReportsText" Text="No audit reports yet. Run a cleanup to generate reports."
                               Foreground="{ThemeResource SystemBaseMediumColor}"
                               Visibility="Visible" />

                    <ListView x:Name="AuditReportsList" SelectionMode="None" Visibility="Collapsed" MaxHeight="300">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="services:RetentionAuditReport">
                                <Border CornerRadius="4" Padding="12" Margin="0,4"
                                        Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0" Spacing="4">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{x:Bind ExecutedAt}" FontWeight="SemiBold" />
                                                <Border CornerRadius="4" Padding="6,2"
                                                        Background="{ThemeResource SystemAccentColor}">
                                                    <TextBlock Text="{x:Bind Status}" FontSize="10" Foreground="White" />
                                                </Border>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Spacing="16">
                                                <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                                    <Run Text="Deleted:" />
                                                    <Run Text="{x:Bind DeletedFiles.Count}" />
                                                    <Run Text="files" />
                                                </TextBlock>
                                                <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                                    <Run Text="Freed:" />
                                                    <Run Text="{x:Bind ActualBytesDeleted}" />
                                                    <Run Text="bytes" />
                                                </TextBlock>
                                            </StackPanel>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Top">
                                            <Button Content="View" Click="ViewAuditReport_Click" Tag="{x:Bind Id}" />
                                            <Button Content="Export" Click="ExportAuditReport_Click" Tag="{x:Bind Id}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Scheduled Checksum Audits -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE787;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Scheduled Integrity Audits" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <ToggleSwitch x:Name="EnableScheduledAuditsToggle" Grid.Column="1"
                                      IsOn="True" Toggled="EnableScheduledAudits_Toggled" />
                    </Grid>

                    <TextBlock Text="Schedule periodic checksum audits to confirm archives remain readable and uncorrupted"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <Grid ColumnSpacing="24" x:Name="ScheduledAuditConfig">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <ComboBox x:Name="AuditFrequencyCombo" Grid.Column="0" Header="Audit Frequency"
                                  HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Daily" Tag="daily" />
                            <ComboBoxItem Content="Weekly" Tag="weekly" IsSelected="True" />
                            <ComboBoxItem Content="Monthly" Tag="monthly" />
                        </ComboBox>

                        <ComboBox x:Name="AuditScopeCombo" Grid.Column="1" Header="Audit Scope"
                                  HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Recent files (7 days)" Tag="recent" IsSelected="True" />
                            <ComboBoxItem Content="Warm tier" Tag="warm" />
                            <ComboBoxItem Content="Full archive" Tag="full" />
                        </ComboBox>
                    </Grid>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</Page>
