<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.LiveDataViewerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE9D9;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                <StackPanel>
                    <TextBlock Text="Live Data Viewer" Style="{StaticResource TitleTextBlockStyle}" />
                    <TextBlock Text="Real-time trades, quotes, and order book visualization"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                </StackPanel>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                <ToggleSwitch x:Name="AutoRefreshToggle" Header="Auto-refresh" IsOn="True"
                              Toggled="AutoRefresh_Toggled" />
                <Button Click="Refresh_Click" Style="{StaticResource IconButtonStyle}"
                        ToolTipService.ToolTip="Refresh">
                    <FontIcon Glyph="&#xE72C;" FontSize="16" />
                </Button>
            </StackPanel>
        </Grid>

        <!-- Symbol Selector -->
        <Border Grid.Row="1" Style="{StaticResource CardStyle}" Margin="0,0,0,16" Padding="16">
            <Grid ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="200" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <AutoSuggestBox x:Name="SymbolInput" Grid.Column="0"
                                PlaceholderText="Enter symbol..."
                                QueryIcon="Find"
                                QuerySubmitted="Symbol_QuerySubmitted" />

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <CheckBox x:Name="ShowTradesCheck" Content="Trades" IsChecked="True" />
                    <CheckBox x:Name="ShowQuotesCheck" Content="Quotes" IsChecked="True" />
                    <CheckBox x:Name="ShowDepthCheck" Content="Depth" IsChecked="True" />
                </StackPanel>

                <ComboBox x:Name="RefreshIntervalCombo" Grid.Column="2" SelectedIndex="1"
                          SelectionChanged="RefreshInterval_Changed" MinWidth="120" VerticalAlignment="Center">
                    <ComboBoxItem Content="500ms" Tag="500" />
                    <ComboBoxItem Content="1 second" Tag="1000" />
                    <ComboBoxItem Content="2 seconds" Tag="2000" />
                    <ComboBoxItem Content="5 seconds" Tag="5000" />
                </ComboBox>

                <!-- Current Symbol Display -->
                <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock x:Name="CurrentSymbolText" Text="--" FontSize="24" FontWeight="Bold" />
                        <Border x:Name="StreamStatusBadge" Background="{StaticResource SuccessColorBrush}"
                                CornerRadius="4" Padding="8,4" VerticalAlignment="Center" Visibility="Collapsed">
                            <TextBlock x:Name="StreamStatusText" Text="Live" FontSize="11" Foreground="White" FontWeight="SemiBold" />
                        </Border>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <StackPanel>
                            <TextBlock Text="Last Price" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="LastPriceText" Text="--" FontWeight="Bold" FontSize="16" />
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Spread" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="SpreadText" Text="--" FontWeight="Bold" />
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Volume" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="VolumeText" Text="--" FontWeight="Bold" />
                        </StackPanel>
                    </StackPanel>
                </StackPanel>

                <Button Grid.Column="4" Content="Subscribe" Click="Subscribe_Click"
                        Style="{StaticResource PrimaryButtonStyle}" />
            </Grid>
        </Border>

        <!-- Main Content Grid -->
        <Grid Grid.Row="2" ColumnSpacing="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="350" />
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Order Book (Left Panel) -->
            <Border Grid.Column="0" Grid.Row="0" Grid.RowSpan="2" Style="{StaticResource CardStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
                        <FontIcon Glyph="&#xE8A1;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Order Book" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <!-- Order Book Stats -->
                    <Grid Grid.Row="1" Margin="0,0,0,16" ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Best Bid" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="BestBidText" Text="--" FontWeight="Bold" Foreground="{StaticResource SuccessColorBrush}" />
                        </StackPanel>
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Best Ask" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="BestAskText" Text="--" FontWeight="Bold" Foreground="{StaticResource ErrorColorBrush}" />
                        </StackPanel>
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Imbalance" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="ImbalanceText" Text="--" FontWeight="Bold" />
                        </StackPanel>
                        <StackPanel Grid.Column="3">
                            <TextBlock Text="Mid Price" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="MidPriceText" Text="--" FontWeight="Bold" />
                        </StackPanel>
                    </Grid>

                    <!-- Order Book Visualization -->
                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Bids -->
                        <Border Grid.Column="0" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="4" Margin="0,0,4,0">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0" Padding="8" Background="#1A48BB78">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="80" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Volume" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Column="1" Text="Size" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                    <TextBlock Grid.Column="2" Text="Bid" FontWeight="SemiBold" Foreground="{StaticResource SuccessColorBrush}" HorizontalAlignment="Right" />
                                </Grid>

                                <ListView x:Name="BidsList" Grid.Row="1" SelectionMode="None">
                                    <ListView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="8,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="80" />
                                                    <ColumnDefinition Width="80" />
                                                </Grid.ColumnDefinitions>

                                                <!-- Volume bar -->
                                                <Border Grid.Column="0" HorizontalAlignment="Right">
                                                    <Border.Background>
                                                        <SolidColorBrush Color="#48BB78" Opacity="0.3" />
                                                    </Border.Background>
                                                </Border>

                                                <TextBlock Grid.Column="1" Text="{Binding Size}" HorizontalAlignment="Right" />
                                                <TextBlock Grid.Column="2" Text="{Binding Price}" FontWeight="SemiBold"
                                                           Foreground="{StaticResource SuccessColorBrush}" HorizontalAlignment="Right" />
                                            </Grid>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </Grid>
                        </Border>

                        <!-- Asks -->
                        <Border Grid.Column="1" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="4" Margin="4,0,0,0">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0" Padding="8" Background="#1AF56565">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Ask" FontWeight="SemiBold" Foreground="{StaticResource ErrorColorBrush}" />
                                    <TextBlock Grid.Column="1" Text="Size" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="Volume" FontWeight="SemiBold" />
                                </Grid>

                                <ListView x:Name="AsksList" Grid.Row="1" SelectionMode="None">
                                    <ListView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="8,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="80" />
                                                    <ColumnDefinition Width="80" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Grid.Column="0" Text="{Binding Price}" FontWeight="SemiBold"
                                                           Foreground="{StaticResource ErrorColorBrush}" />
                                                <TextBlock Grid.Column="1" Text="{Binding Size}" />

                                                <!-- Volume bar -->
                                                <Border Grid.Column="2" HorizontalAlignment="Left">
                                                    <Border.Background>
                                                        <SolidColorBrush Color="#F56565" Opacity="0.3" />
                                                    </Border.Background>
                                                </Border>
                                            </Grid>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </Border>

            <!-- Recent Trades (Top Right) -->
            <Border Grid.Column="1" Grid.Row="0" Style="{StaticResource CardStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
                        <FontIcon Glyph="&#xE8AB;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Recent Trades" Style="{StaticResource SubtitleTextBlockStyle}" />
                        <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="10" Padding="8,2">
                            <TextBlock x:Name="TradeCountText" Text="0" FontSize="11" />
                        </Border>
                    </StackPanel>

                    <ListView x:Name="TradesList" Grid.Row="1" SelectionMode="None">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="4,6" ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="70" />
                                        <ColumnDefinition Width="60" />
                                        <ColumnDefinition Width="60" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="{Binding Timestamp}" FontSize="11"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    <TextBlock Grid.Column="1" Text="{Binding Price}" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="{Binding Size}" />
                                    <Border Grid.Column="3" CornerRadius="2" Padding="4,1"
                                            HorizontalAlignment="Left">
                                        <TextBlock Text="{Binding Side}" FontSize="10" />
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>
            </Border>

            <!-- Order Flow Stats (Bottom Right) -->
            <Border Grid.Column="1" Grid.Row="1" Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE9D9;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Order Flow Statistics" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <!-- VWAP -->
                    <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                            CornerRadius="4" Padding="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="VWAP" VerticalAlignment="Center" />
                            <TextBlock x:Name="VwapText" Grid.Column="1" Text="--" FontWeight="Bold" FontSize="18" />
                        </Grid>
                    </Border>

                    <!-- Buy/Sell Volume -->
                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Background="#1A48BB78" CornerRadius="4" Padding="12">
                            <StackPanel>
                                <TextBlock Text="Buy Volume" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="BuyVolumeText" Text="--" FontWeight="Bold"
                                           Foreground="{StaticResource SuccessColorBrush}" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="1" Background="#1AF56565" CornerRadius="4" Padding="12">
                            <StackPanel>
                                <TextBlock Text="Sell Volume" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="SellVolumeText" Text="--" FontWeight="Bold"
                                           Foreground="{StaticResource ErrorColorBrush}" />
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- Imbalance Bar -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="Order Imbalance" Style="{StaticResource CaptionTextBlockStyle}" />
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition x:Name="BuyBarColumn" Width="*" />
                                <ColumnDefinition x:Name="SellBarColumn" Width="*" />
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Background="{StaticResource SuccessColorBrush}"
                                    Height="8" CornerRadius="4,0,0,4" />
                            <Border Grid.Column="1" Background="{StaticResource ErrorColorBrush}"
                                    Height="8" CornerRadius="0,4,4,0" />
                        </Grid>
                        <Grid>
                            <TextBlock x:Name="BuyPercentText" Text="50%" HorizontalAlignment="Left"
                                       Foreground="{StaticResource SuccessColorBrush}" FontSize="11" />
                            <TextBlock x:Name="SellPercentText" Text="50%" HorizontalAlignment="Right"
                                       Foreground="{StaticResource ErrorColorBrush}" FontSize="11" />
                        </Grid>
                    </StackPanel>

                    <!-- Trade Stats Grid -->
                    <Grid ColumnSpacing="16" RowSpacing="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Grid.Column="0">
                            <TextBlock Text="Trade Count" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="TradeCountStatText" Text="--" FontWeight="SemiBold" />
                        </StackPanel>

                        <StackPanel Grid.Row="0" Grid.Column="1">
                            <TextBlock Text="Avg Size" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="AvgTradeSizeText" Text="--" FontWeight="SemiBold" />
                        </StackPanel>

                        <StackPanel Grid.Row="1" Grid.Column="0">
                            <TextBlock Text="Largest Trade" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="LargestTradeText" Text="--" FontWeight="SemiBold" />
                        </StackPanel>

                        <StackPanel Grid.Row="1" Grid.Column="1">
                            <TextBlock Text="Total Volume" Style="{StaticResource CaptionTextBlockStyle}" />
                            <TextBlock x:Name="TotalVolumeText" Text="--" FontWeight="SemiBold" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Loading Overlay -->
        <ProgressRing x:Name="LoadingRing" Grid.RowSpan="3" IsActive="False" Width="48" Height="48"
                      HorizontalAlignment="Center" VerticalAlignment="Center" Visibility="Collapsed" />

        <InfoBar x:Name="PageInfoBar" Grid.Row="2" IsOpen="False" IsClosable="True"
                 HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,16" />
    </Grid>
</Page>
