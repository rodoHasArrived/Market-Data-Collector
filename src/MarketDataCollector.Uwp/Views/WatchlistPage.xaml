<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.WatchlistPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:converters="using:MarketDataCollector.Uwp.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <converters:StringVisibilityConverter x:Key="StringVisibilityConverter" />
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24">
            <!-- Header -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <FontIcon Glyph="&#xE728;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                    <TextBlock Text="Watchlist" Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center" />
                    <Border Background="{ThemeResource SystemAccentColor}" CornerRadius="12" Padding="10,4" VerticalAlignment="Center">
                        <TextBlock x:Name="SymbolCountBadge" Text="0" FontSize="12" Foreground="White" FontWeight="SemiBold" />
                    </Border>
                </StackPanel>

                <!-- Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button x:Name="RefreshButton" Click="Refresh_Click" ToolTipService.ToolTip="Refresh status">
                        <FontIcon Glyph="&#xE72C;" FontSize="16" />
                    </Button>
                    <Button x:Name="SortButton" Click="Sort_Click" ToolTipService.ToolTip="Sort watchlist">
                        <FontIcon Glyph="&#xE8CB;" FontSize="16" />
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Quick Add Symbol -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE710;" FontSize="16" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Add Symbol" FontWeight="SemiBold" />
                    </StackPanel>

                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <AutoSuggestBox x:Name="AddSymbolBox" Grid.Column="0"
                                        PlaceholderText="Enter symbol (e.g., NVDA, META, GOOG)"
                                        QueryIcon="Find"
                                        TextChanged="AddSymbol_TextChanged"
                                        QuerySubmitted="AddSymbol_QuerySubmitted"
                                        UpdateTextOnSelect="False">
                            <AutoSuggestBox.ItemTemplate>
                                <DataTemplate x:DataType="local:SymbolSuggestion">
                                    <Grid Padding="4,6" ColumnSpacing="12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon Grid.Column="0" Glyph="{x:Bind Icon}" FontSize="16"
                                                  Foreground="{ThemeResource SystemAccentColor}"
                                                  VerticalAlignment="Center" />
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{x:Bind DisplayText}" FontWeight="SemiBold" />
                                            <TextBlock Text="{x:Bind SecondaryText}" FontSize="11"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}"
                                                       Visibility="{x:Bind SecondaryText, Converter={StaticResource StringVisibilityConverter}}" />
                                        </StackPanel>
                                        <Border Grid.Column="2" Background="{ThemeResource SystemBaseLowColor}"
                                                CornerRadius="4" Padding="6,2" VerticalAlignment="Center"
                                                Visibility="{x:Bind RelevanceText, Converter={StaticResource StringVisibilityConverter}}">
                                            <TextBlock Text="{x:Bind RelevanceText}" FontSize="10"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </AutoSuggestBox.ItemTemplate>
                        </AutoSuggestBox>
                        <Button Grid.Column="1" Content="Add to Watchlist"
                                Style="{StaticResource AccentButtonStyle}"
                                Click="AddSymbol_Click" />
                    </Grid>

                    <!-- Popular symbols quick add -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="Popular:" Foreground="{ThemeResource SystemBaseMediumColor}" FontSize="12" />
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <Button Content="SPY" Tag="SPY" Click="QuickAdd_Click" Padding="12,6" />
                            <Button Content="QQQ" Tag="QQQ" Click="QuickAdd_Click" Padding="12,6" />
                            <Button Content="AAPL" Tag="AAPL" Click="QuickAdd_Click" Padding="12,6" />
                            <Button Content="MSFT" Tag="MSFT" Click="QuickAdd_Click" Padding="12,6" />
                            <Button Content="NVDA" Tag="NVDA" Click="QuickAdd_Click" Padding="12,6" />
                            <Button Content="TSLA" Tag="TSLA" Click="QuickAdd_Click" Padding="12,6" />
                            <Button Content="AMZN" Tag="AMZN" Click="QuickAdd_Click" Padding="12,6" />
                            <Button Content="META" Tag="META" Click="QuickAdd_Click" Padding="12,6" />
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Favorites Section -->
            <Border x:Name="FavoritesSection" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE735;" FontSize="16" Foreground="{StaticResource WarningColorBrush}" />
                        <TextBlock Text="Favorites" FontWeight="SemiBold" />
                    </StackPanel>

                    <ListView x:Name="FavoritesList" SelectionMode="None" IsItemClickEnabled="True" ItemClick="Symbol_ItemClick"
                              RightTapped="SymbolItem_RightTapped">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8,12" ColumnSpacing="16" RightTapped="SymbolItem_RightTapped" Tag="{Binding Symbol}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Favorite Star -->
                                    <Button Grid.Column="0" Background="Transparent" Padding="4"
                                            Click="ToggleFavorite_Click" Tag="{Binding Symbol}">
                                        <FontIcon Glyph="&#xE735;" FontSize="16"
                                                  Foreground="{StaticResource WarningColorBrush}" />
                                    </Button>

                                    <!-- Symbol -->
                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="{Binding Symbol}" FontWeight="Bold" FontSize="16" />
                                        <TextBlock Text="{Binding Notes}" FontSize="11"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                                   TextTrimming="CharacterEllipsis" MaxWidth="90" />
                                    </StackPanel>

                                    <!-- Status -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6">
                                        <Ellipse Width="8" Height="8" Fill="{Binding StatusColor}" VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding StatusText}" FontSize="12" VerticalAlignment="Center" />
                                    </StackPanel>

                                    <!-- Event Rate -->
                                    <StackPanel Grid.Column="3">
                                        <TextBlock Text="{Binding EventRateText}" FontWeight="SemiBold"
                                                   Foreground="{ThemeResource SystemAccentColor}" />
                                        <TextBlock Text="events/s" FontSize="10"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    </StackPanel>

                                    <!-- Health -->
                                    <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="{Binding HealthText}" FontWeight="SemiBold"
                                                   Foreground="{Binding HealthColor}" />
                                        <FontIcon Glyph="{Binding HealthIcon}" FontSize="12"
                                                  Foreground="{Binding HealthColor}" />
                                    </StackPanel>

                                    <!-- Last Event -->
                                    <TextBlock Grid.Column="5" Text="{Binding LastEventText}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}"
                                               VerticalAlignment="Center" FontSize="12" />

                                    <!-- Actions -->
                                    <StackPanel Grid.Column="6" Orientation="Horizontal" Spacing="4">
                                        <Button Background="Transparent" Padding="8,4"
                                                Click="ViewDetails_Click" Tag="{Binding Symbol}"
                                                ToolTipService.ToolTip="View details">
                                            <FontIcon Glyph="&#xE8A5;" FontSize="14" />
                                        </Button>
                                        <Button Background="Transparent" Padding="8,4"
                                                Click="RemoveSymbol_Click" Tag="{Binding Symbol}"
                                                ToolTipService.ToolTip="Remove from watchlist">
                                            <FontIcon Glyph="&#xE74D;" FontSize="14" Foreground="{StaticResource ErrorColorBrush}" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- All Symbols Section -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8FD;" FontSize="16" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="All Symbols" FontWeight="SemiBold" />
                        </StackPanel>

                        <!-- View Toggle -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                            <RadioButton x:Name="ListViewButton" GroupName="ViewMode" IsChecked="True"
                                         Click="ViewMode_Click" Tag="List" Padding="8,4">
                                <FontIcon Glyph="&#xE8FD;" FontSize="14" />
                            </RadioButton>
                            <RadioButton x:Name="GridViewButton" GroupName="ViewMode"
                                         Click="ViewMode_Click" Tag="Grid" Padding="8,4">
                                <FontIcon Glyph="&#xF0E2;" FontSize="14" />
                            </RadioButton>
                        </StackPanel>
                    </Grid>

                    <!-- List View -->
                    <ListView x:Name="AllSymbolsList" SelectionMode="None" IsItemClickEnabled="True" ItemClick="Symbol_ItemClick"
                              RightTapped="SymbolItem_RightTapped">
                        <ListView.HeaderTemplate>
                            <DataTemplate>
                                <Grid Padding="8,8" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Width="36" />
                                    <TextBlock Grid.Column="1" Text="Symbol" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="Status" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="3" Text="Rate" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="4" Text="Health" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="5" Text="Last Event" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="6" Text="Actions" FontWeight="SemiBold" />
                                </Grid>
                            </DataTemplate>
                        </ListView.HeaderTemplate>
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8,12" ColumnSpacing="16" RightTapped="SymbolItem_RightTapped" Tag="{Binding Symbol}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Favorite Star -->
                                    <Button Grid.Column="0" Background="Transparent" Padding="4"
                                            Click="ToggleFavorite_Click" Tag="{Binding Symbol}">
                                        <FontIcon Glyph="{Binding FavoriteIcon}" FontSize="16"
                                                  Foreground="{Binding FavoriteColor}" />
                                    </Button>

                                    <!-- Symbol -->
                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="{Binding Symbol}" FontWeight="Bold" FontSize="16" />
                                        <TextBlock Text="{Binding Notes}" FontSize="11"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                                   TextTrimming="CharacterEllipsis" MaxWidth="90" />
                                    </StackPanel>

                                    <!-- Status -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6">
                                        <Ellipse Width="8" Height="8" Fill="{Binding StatusColor}" VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding StatusText}" FontSize="12" VerticalAlignment="Center" />
                                    </StackPanel>

                                    <!-- Event Rate -->
                                    <StackPanel Grid.Column="3">
                                        <TextBlock Text="{Binding EventRateText}" FontWeight="SemiBold"
                                                   Foreground="{ThemeResource SystemAccentColor}" />
                                        <TextBlock Text="events/s" FontSize="10"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    </StackPanel>

                                    <!-- Health -->
                                    <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="{Binding HealthText}" FontWeight="SemiBold"
                                                   Foreground="{Binding HealthColor}" />
                                        <FontIcon Glyph="{Binding HealthIcon}" FontSize="12"
                                                  Foreground="{Binding HealthColor}" />
                                    </StackPanel>

                                    <!-- Last Event -->
                                    <TextBlock Grid.Column="5" Text="{Binding LastEventText}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}"
                                               VerticalAlignment="Center" FontSize="12" />

                                    <!-- Actions -->
                                    <StackPanel Grid.Column="6" Orientation="Horizontal" Spacing="4">
                                        <Button Background="Transparent" Padding="8,4"
                                                Click="ViewDetails_Click" Tag="{Binding Symbol}"
                                                ToolTipService.ToolTip="View details">
                                            <FontIcon Glyph="&#xE8A5;" FontSize="14" />
                                        </Button>
                                        <Button Background="Transparent" Padding="8,4"
                                                Click="RemoveSymbol_Click" Tag="{Binding Symbol}"
                                                ToolTipService.ToolTip="Remove from watchlist">
                                            <FontIcon Glyph="&#xE74D;" FontSize="14" Foreground="{StaticResource ErrorColorBrush}" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Grid View (Alternative) -->
                    <GridView x:Name="AllSymbolsGrid" Visibility="Collapsed" SelectionMode="None"
                              RightTapped="SymbolItem_RightTapped">
                        <GridView.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource CardStyle}" Width="200" Margin="4" Padding="16"
                                        RightTapped="SymbolItem_RightTapped" Tag="{Binding Symbol}">
                                    <StackPanel Spacing="12">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Symbol}" FontWeight="Bold" FontSize="20" />
                                            <Button Grid.Column="1" Background="Transparent" Padding="4"
                                                    Click="ToggleFavorite_Click" Tag="{Binding Symbol}">
                                                <FontIcon Glyph="{Binding FavoriteIcon}" FontSize="16"
                                                          Foreground="{Binding FavoriteColor}" />
                                            </Button>
                                        </Grid>

                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <Ellipse Width="8" Height="8" Fill="{Binding StatusColor}" />
                                            <TextBlock Text="{Binding StatusText}" FontSize="12" />
                                        </StackPanel>

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="Rate" FontSize="10" Foreground="{ThemeResource SystemBaseMediumColor}" />
                                                <TextBlock Text="{Binding EventRateText}" FontWeight="SemiBold" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="Health" FontSize="10" Foreground="{ThemeResource SystemBaseMediumColor}" />
                                                <TextBlock Text="{Binding HealthText}" FontWeight="SemiBold" Foreground="{Binding HealthColor}" />
                                            </StackPanel>
                                        </Grid>

                                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                                            <Button Background="Transparent" Padding="8,4"
                                                    Click="ViewDetails_Click" Tag="{Binding Symbol}">
                                                <FontIcon Glyph="&#xE8A5;" FontSize="14" />
                                            </Button>
                                            <Button Background="Transparent" Padding="8,4"
                                                    Click="RemoveSymbol_Click" Tag="{Binding Symbol}">
                                                <FontIcon Glyph="&#xE74D;" FontSize="14" Foreground="{StaticResource ErrorColorBrush}" />
                                            </Button>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </GridView.ItemTemplate>
                    </GridView>

                    <!-- Empty State -->
                    <StackPanel x:Name="EmptyState" Visibility="Collapsed" HorizontalAlignment="Center" Spacing="16" Padding="48">
                        <FontIcon Glyph="&#xE728;" FontSize="48" Foreground="{ThemeResource SystemBaseMediumColor}" />
                        <TextBlock Text="Your watchlist is empty" Style="{StaticResource SubtitleTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}" HorizontalAlignment="Center" />
                        <TextBlock Text="Add symbols above to start tracking them"
                                   Foreground="{ThemeResource SystemBaseMediumColor}" HorizontalAlignment="Center" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <InfoBar x:Name="WatchlistInfoBar" IsOpen="False" IsClosable="True" />
        </StackPanel>
    </ScrollViewer>
</Page>
