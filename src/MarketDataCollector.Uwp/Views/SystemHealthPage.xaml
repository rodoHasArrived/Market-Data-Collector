<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.SystemHealthPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="24">
            <!-- Header -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <FontIcon Glyph="&#xE770;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                    <StackPanel>
                        <TextBlock Text="System Health" Style="{StaticResource TitleTextBlockStyle}" />
                        <TextBlock Text="Monitor connection health, diagnostics, and system resources"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Click="Refresh_Click" Style="{StaticResource IconButtonStyle}"
                            ToolTipService.ToolTip="Refresh (F5)">
                        <FontIcon Glyph="&#xE72C;" FontSize="16" />
                    </Button>
                    <Button Click="GenerateDiagnostics_Click">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE9D9;" FontSize="14" />
                            <TextBlock Text="Generate Diagnostics" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Overall Status Banner -->
            <Border x:Name="StatusBanner" CornerRadius="8" Padding="20">
                <Grid ColumnSpacing="24">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                        <FontIcon x:Name="StatusIcon" Glyph="&#xE73E;" FontSize="32" Foreground="White" />
                        <StackPanel>
                            <TextBlock x:Name="StatusText" Text="System Healthy" FontSize="20" FontWeight="Bold" Foreground="White" />
                            <TextBlock x:Name="StatusDescription" Text="All systems operational" Foreground="White" Opacity="0.9" />
                        </StackPanel>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="24">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock x:Name="UptimeText" Text="0d 0h 0m" FontWeight="Bold" Foreground="White" />
                            <TextBlock Text="Uptime" FontSize="11" Foreground="White" Opacity="0.8" />
                        </StackPanel>
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock x:Name="EventsText" Text="0" FontWeight="Bold" Foreground="White" />
                            <TextBlock Text="Events/s" FontSize="11" Foreground="White" Opacity="0.8" />
                        </StackPanel>
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock x:Name="LatencyText" Text="0ms" FontWeight="Bold" Foreground="White" />
                            <TextBlock Text="Avg Latency" FontSize="11" Foreground="White" Opacity="0.8" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Quick Stats Row -->
            <Grid ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Style="{StaticResource CardStyle}" Padding="16">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE703;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Connections" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="ConnectionsHealthyText" Text="0/0" FontSize="24" FontWeight="Bold" />
                            <TextBlock x:Name="ConnectionsStatusText" Grid.Column="1" Text="Healthy" VerticalAlignment="Bottom"
                                       Foreground="{StaticResource SuccessColorBrush}" FontWeight="SemiBold" />
                        </Grid>
                    </StackPanel>
                </Border>

                <Border Grid.Column="1" Style="{StaticResource CardStyle}" Padding="16">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8B7;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Storage" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>
                        <StackPanel Spacing="4">
                            <TextBlock x:Name="StorageUsedText" Text="0%" FontSize="24" FontWeight="Bold" />
                            <ProgressBar x:Name="StorageProgressBar" Value="0" Maximum="100" Height="4" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <Border Grid.Column="2" Style="{StaticResource CardStyle}" Padding="16">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE950;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Memory" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>
                        <StackPanel Spacing="4">
                            <TextBlock x:Name="MemoryUsedText" Text="0%" FontSize="24" FontWeight="Bold" />
                            <ProgressBar x:Name="MemoryProgressBar" Value="0" Maximum="100" Height="4" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <Border Grid.Column="3" Style="{StaticResource CardStyle}" Padding="16">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7BA;" Foreground="{StaticResource WarningColorBrush}" />
                            <TextBlock Text="Alerts" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="ActiveAlertsText" Text="0" FontSize="24" FontWeight="Bold" />
                            <Button Grid.Column="1" Content="View" Click="ViewAlerts_Click" Padding="8,4"
                                    VerticalAlignment="Bottom" />
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Provider Health Section -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE703;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Provider Health" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <!-- Provider List -->
                    <ListView x:Name="ProviderHealthList" SelectionMode="None">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="12" Margin="0,4"
                                        Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                        CornerRadius="4">
                                    <Grid ColumnSpacing="16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="80" />
                                            <ColumnDefinition Width="80" />
                                            <ColumnDefinition Width="100" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Status indicator -->
                                        <Ellipse Grid.Column="0" Width="12" Height="12">
                                            <Ellipse.Fill>
                                                <SolidColorBrush Color="{Binding StatusColor}" />
                                            </Ellipse.Fill>
                                        </Ellipse>

                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
                                            <TextBlock Text="{Binding Provider}" FontSize="11"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                        </StackPanel>

                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="Status" Style="{StaticResource CaptionTextBlockStyle}" />
                                            <TextBlock Text="{Binding Status}" FontWeight="SemiBold" />
                                        </StackPanel>

                                        <StackPanel Grid.Column="3">
                                            <TextBlock Text="Latency" Style="{StaticResource CaptionTextBlockStyle}" />
                                            <TextBlock Text="{Binding LatencyText}" FontWeight="SemiBold" />
                                        </StackPanel>

                                        <StackPanel Grid.Column="4">
                                            <TextBlock Text="Events/s" Style="{StaticResource CaptionTextBlockStyle}" />
                                            <TextBlock Text="{Binding EventsPerSecond}" FontWeight="SemiBold" />
                                        </StackPanel>

                                        <StackPanel Grid.Column="5">
                                            <TextBlock Text="Last Event" Style="{StaticResource CaptionTextBlockStyle}" />
                                            <TextBlock Text="{Binding LastEventText}"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                        </StackPanel>

                                        <StackPanel Grid.Column="6" Orientation="Horizontal" Spacing="4">
                                            <Button Click="TestConnection_Click" Tag="{Binding Provider}"
                                                    Padding="8,4" ToolTipService.ToolTip="Test connection">
                                                <FontIcon Glyph="&#xE768;" FontSize="12" />
                                            </Button>
                                            <Button Click="ViewDiagnostics_Click" Tag="{Binding Provider}"
                                                    Padding="8,4" ToolTipService.ToolTip="View diagnostics">
                                                <FontIcon Glyph="&#xE946;" FontSize="12" />
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <TextBlock x:Name="NoProvidersText" Text="No providers configured"
                               Foreground="{ThemeResource SystemBaseMediumColor}"
                               FontStyle="Italic" HorizontalAlignment="Center" Visibility="Collapsed" />
                </StackPanel>
            </Border>

            <!-- Two Column Layout: Events & Storage -->
            <Grid ColumnSpacing="24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="400" />
                </Grid.ColumnDefinitions>

                <!-- Recent Events -->
                <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE81C;" Foreground="{ThemeResource SystemAccentColor}" />
                                <TextBlock Text="Recent Events" Style="{StaticResource SubtitleTextBlockStyle}" />
                            </StackPanel>

                            <ComboBox x:Name="EventFilterCombo" Grid.Column="1" SelectedIndex="0"
                                      SelectionChanged="EventFilter_Changed" MinWidth="100">
                                <ComboBoxItem Content="All" Tag="All" />
                                <ComboBoxItem Content="Errors" Tag="Error" />
                                <ComboBoxItem Content="Warnings" Tag="Warning" />
                                <ComboBoxItem Content="Info" Tag="Info" />
                            </ComboBox>
                        </Grid>

                        <ListView x:Name="EventsList" MaxHeight="350" SelectionMode="None">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8,10" ColumnSpacing="12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="80" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="100" />
                                        </Grid.ColumnDefinitions>

                                        <Border Grid.Column="0" Width="4" CornerRadius="2" VerticalAlignment="Stretch">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Style.Setters>
                                                        <Setter Property="Background" Value="{StaticResource InfoColorBrush}" />
                                                    </Style.Setters>
                                                </Style>
                                            </Border.Style>
                                        </Border>

                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding EventType}" FontWeight="SemiBold" FontSize="12" />
                                            <TextBlock Text="{Binding Source}" FontSize="11"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                        </StackPanel>

                                        <TextBlock Grid.Column="2" Text="{Binding Message}" TextWrapping="Wrap"
                                                   VerticalAlignment="Center" />

                                        <TextBlock Grid.Column="3" Text="{Binding Timestamp}" FontSize="11"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                                   VerticalAlignment="Center" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>

                        <TextBlock x:Name="NoEventsText" Text="No recent events"
                                   Foreground="{ThemeResource SystemBaseMediumColor}"
                                   FontStyle="Italic" HorizontalAlignment="Center" Visibility="Collapsed" />
                    </StackPanel>
                </Border>

                <!-- Storage Health -->
                <Border Grid.Column="1" Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8B7;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Storage Health" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <!-- Storage Usage -->
                        <Border Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="8" Padding="16">
                            <StackPanel Spacing="12">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Disk Usage" FontWeight="SemiBold" />
                                    <TextBlock x:Name="StoragePercentText" Grid.Column="1" Text="0%" FontWeight="Bold" />
                                </Grid>

                                <ProgressBar x:Name="StorageBar" Value="0" Maximum="100" Height="8" />

                                <Grid ColumnSpacing="16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Used" Style="{StaticResource CaptionTextBlockStyle}" />
                                        <TextBlock x:Name="StorageUsedBytesText" Text="0 GB" FontWeight="SemiBold" />
                                    </StackPanel>

                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="Available" Style="{StaticResource CaptionTextBlockStyle}" />
                                        <TextBlock x:Name="StorageAvailableText" Text="0 GB" FontWeight="SemiBold" />
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- File Stats -->
                        <Grid ColumnSpacing="16" RowSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Grid.Column="0">
                                <TextBlock Text="Total Files" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="TotalFilesText" Text="0" FontWeight="Bold" FontSize="18" />
                            </StackPanel>

                            <StackPanel Grid.Row="0" Grid.Column="1">
                                <TextBlock Text="Last Check" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="LastStorageCheckText" Text="--" FontWeight="SemiBold" />
                            </StackPanel>

                            <StackPanel Grid.Row="1" Grid.Column="0">
                                <TextBlock Text="Corrupted" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="CorruptedFilesText" Text="0" FontWeight="Bold"
                                           Foreground="{StaticResource ErrorColorBrush}" />
                            </StackPanel>

                            <StackPanel Grid.Row="1" Grid.Column="1">
                                <TextBlock Text="Orphaned" Style="{StaticResource CaptionTextBlockStyle}" />
                                <TextBlock x:Name="OrphanedFilesText" Text="0" FontWeight="Bold"
                                           Foreground="{StaticResource WarningColorBrush}" />
                            </StackPanel>
                        </Grid>

                        <!-- Storage Issues -->
                        <StackPanel x:Name="StorageIssuesPanel" Spacing="8" Visibility="Collapsed">
                            <TextBlock Text="Issues" FontWeight="SemiBold" />
                            <ItemsControl x:Name="StorageIssuesList">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#1AF56565" CornerRadius="4" Padding="8" Margin="0,2">
                                            <TextBlock Text="{Binding}" TextWrapping="Wrap" FontSize="12" />
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <Button Content="Run Storage Check" Click="RunStorageCheck_Click"
                                HorizontalAlignment="Stretch" />
                    </StackPanel>
                </Border>
            </Grid>

            <!-- System Resources -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE950;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="System Resources" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="4" Padding="12">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="CpuUsageText" Text="0%" FontSize="20" FontWeight="Bold"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="CPU" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="1" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="4" Padding="12">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="MemoryDetailText" Text="0 MB" FontSize="20" FontWeight="Bold"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="Memory" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="2" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="4" Padding="12">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="ThreadCountText" Text="0" FontSize="20" FontWeight="Bold"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="Threads" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="3" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="4" Padding="12">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="EventRateText" Text="0/s" FontSize="20" FontWeight="Bold"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="Events" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="4" Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}"
                                CornerRadius="4" Padding="12">
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <TextBlock x:Name="PendingOpsText" Text="0" FontSize="20" FontWeight="Bold"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="Pending Ops" Style="{StaticResource CaptionTextBlockStyle}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Loading Overlay -->
            <ProgressRing x:Name="LoadingRing" IsActive="False" Width="48" Height="48"
                          HorizontalAlignment="Center" Visibility="Collapsed" />

            <InfoBar x:Name="PageInfoBar" IsOpen="False" IsClosable="True" />
        </StackPanel>
    </ScrollViewer>
</Page>
