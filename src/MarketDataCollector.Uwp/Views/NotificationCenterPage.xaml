<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.NotificationCenterPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MarketDataCollector.Uwp.Views"
    xmlns:services="using:MarketDataCollector.Uwp.Services"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <!-- Notification Type to Color Converter -->
        <local:NotificationTypeToColorConverter x:Key="NotificationTypeToColor" />
        <local:NotificationTypeToIconConverter x:Key="NotificationTypeToIcon" />
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="24" Padding="0,0,24,24">
            <!-- Page Header -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Notification Center" Style="{StaticResource TitleTextBlockStyle}" />
                    <TextBlock Text="View notification history, incidents, and manage alert preferences"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button x:Name="ClearAllButton" Content="Clear All" Click="ClearAll_Click" />
                    <Button x:Name="RefreshButton" Click="Refresh_Click">
                        <FontIcon Glyph="&#xE72C;" FontSize="14" />
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Filter Bar -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="12">
                    <TextBlock Text="Filters" FontWeight="SemiBold" />
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <ComboBox x:Name="SeverityFilter" Header="Severity" Width="150"
                                  SelectionChanged="SeverityFilter_SelectionChanged">
                            <ComboBoxItem Content="All" Tag="All" IsSelected="True" />
                            <ComboBoxItem Content="Errors" Tag="Error" />
                            <ComboBoxItem Content="Warnings" Tag="Warning" />
                            <ComboBoxItem Content="Info" Tag="Info" />
                            <ComboBoxItem Content="Success" Tag="Success" />
                        </ComboBox>

                        <ComboBox x:Name="SourceFilter" Header="Source" Width="180"
                                  SelectionChanged="SourceFilter_SelectionChanged">
                            <ComboBoxItem Content="All Sources" Tag="All" IsSelected="True" />
                            <ComboBoxItem Content="Connection" Tag="connection" />
                            <ComboBoxItem Content="Backfill" Tag="backfill" />
                            <ComboBoxItem Content="Storage" Tag="storage" />
                            <ComboBoxItem Content="Data Quality" Tag="datagap" />
                            <ComboBoxItem Content="Scheduled Jobs" Tag="schedule" />
                        </ComboBox>

                        <ComboBox x:Name="TimeRangeFilter" Header="Time Range" Width="150"
                                  SelectionChanged="TimeRangeFilter_SelectionChanged">
                            <ComboBoxItem Content="All Time" Tag="all" IsSelected="True" />
                            <ComboBoxItem Content="Last Hour" Tag="hour" />
                            <ComboBoxItem Content="Last 24 Hours" Tag="day" />
                            <ComboBoxItem Content="Last 7 Days" Tag="week" />
                        </ComboBox>

                        <CheckBox x:Name="ShowAcknowledgedCheck" Content="Show Acknowledged"
                                  IsChecked="True" Checked="FilterChanged" Unchecked="FilterChanged" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Summary Cards -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Error Count -->
                <Border Grid.Column="0" Style="{StaticResource CardStyle}" Margin="0,0,8,0">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xEA39;" Foreground="#F56565" />
                            <TextBlock Text="Errors" FontWeight="SemiBold" />
                        </StackPanel>
                        <TextBlock x:Name="ErrorCountText" Text="0"
                                   Style="{StaticResource SubheaderTextBlockStyle}"
                                   Foreground="#F56565" />
                    </StackPanel>
                </Border>

                <!-- Warning Count -->
                <Border Grid.Column="1" Style="{StaticResource CardStyle}" Margin="4,0">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7BA;" Foreground="#ED8936" />
                            <TextBlock Text="Warnings" FontWeight="SemiBold" />
                        </StackPanel>
                        <TextBlock x:Name="WarningCountText" Text="0"
                                   Style="{StaticResource SubheaderTextBlockStyle}"
                                   Foreground="#ED8936" />
                    </StackPanel>
                </Border>

                <!-- Info Count -->
                <Border Grid.Column="2" Style="{StaticResource CardStyle}" Margin="4,0">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE946;" Foreground="#4299E1" />
                            <TextBlock Text="Info" FontWeight="SemiBold" />
                        </StackPanel>
                        <TextBlock x:Name="InfoCountText" Text="0"
                                   Style="{StaticResource SubheaderTextBlockStyle}"
                                   Foreground="#4299E1" />
                    </StackPanel>
                </Border>

                <!-- Active Incidents -->
                <Border Grid.Column="3" Style="{StaticResource CardStyle}" Margin="8,0,0,0">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE783;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Active Incidents" FontWeight="SemiBold" />
                        </StackPanel>
                        <TextBlock x:Name="ActiveIncidentCountText" Text="0"
                                   Style="{StaticResource SubheaderTextBlockStyle}"
                                   Foreground="{ThemeResource SystemAccentColor}" />
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Active Incidents Section -->
            <Border Style="{StaticResource CardStyle}" x:Name="ActiveIncidentsSection">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE783;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Active Incidents" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <TextBlock x:Name="NoActiveIncidentsText" Text="No active incidents"
                               Foreground="{ThemeResource SystemBaseMediumColor}"
                               Visibility="Visible" />

                    <ListView x:Name="ActiveIncidentsList" SelectionMode="None"
                              Visibility="Collapsed" MaxHeight="300">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{ThemeResource SystemFillColorCriticalBackgroundBrush}"
                                        CornerRadius="4" Padding="12" Margin="0,4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <FontIcon Grid.Column="0" Glyph="{Binding Icon}"
                                                  FontSize="20" Margin="0,0,12,0"
                                                  VerticalAlignment="Top" />

                                        <StackPanel Grid.Column="1" Spacing="4">
                                            <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                                            <TextBlock Text="{Binding Description}" TextWrapping="Wrap"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                            <StackPanel Orientation="Horizontal" Spacing="16">
                                                <TextBlock Text="{Binding StartedAt}"
                                                           Style="{StaticResource CaptionTextBlockStyle}" />
                                                <TextBlock Text="{Binding Duration}"
                                                           Style="{StaticResource CaptionTextBlockStyle}" />
                                                <TextBlock Text="{Binding RelatedEvents}"
                                                           Style="{StaticResource CaptionTextBlockStyle}" />
                                            </StackPanel>
                                        </StackPanel>

                                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                            <Button Content="View" Click="ViewIncident_Click"
                                                    Tag="{Binding Id}" />
                                            <Button Content="Acknowledge" Click="AcknowledgeIncident_Click"
                                                    Tag="{Binding Id}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Incident Timeline Section -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8F1;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Incident Timeline" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <Button Grid.Column="1" Content="Export Timeline" Click="ExportTimeline_Click" />
                    </Grid>

                    <TextBlock Text="Related events are grouped into incidents showing the full lifecycle: trigger → impact → resolution"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <ListView x:Name="IncidentTimelineList" SelectionMode="None" MaxHeight="400">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border CornerRadius="4" Padding="12" Margin="0,4"
                                        Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="8" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Timeline Connector -->
                                        <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                            <Ellipse Width="12" Height="12" Fill="{Binding StatusColor}" />
                                            <Rectangle Width="2" Height="40" Fill="{ThemeResource SystemBaseMediumColor}"
                                                       HorizontalAlignment="Center" Margin="0,4,0,0"
                                                       Visibility="{Binding ShowConnector}" />
                                        </StackPanel>

                                        <!-- Content -->
                                        <StackPanel Grid.Column="2" Spacing="4">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                                                <Border Background="{Binding TypeBackground}" CornerRadius="4"
                                                        Padding="6,2">
                                                    <TextBlock Text="{Binding TypeLabel}" FontSize="11" />
                                                </Border>
                                            </StackPanel>
                                            <TextBlock Text="{Binding Description}" TextWrapping="Wrap"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                            <StackPanel Orientation="Horizontal" Spacing="16">
                                                <TextBlock Text="{Binding Timestamp}"
                                                           Style="{StaticResource CaptionTextBlockStyle}" />
                                                <TextBlock Text="{Binding Source}"
                                                           Style="{StaticResource CaptionTextBlockStyle}" />
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Actions -->
                                        <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="4"
                                                    VerticalAlignment="Top">
                                            <Button Padding="8" Background="Transparent" BorderThickness="0"
                                                    ToolTipService.ToolTip="View Details"
                                                    Click="ViewIncidentDetails_Click" Tag="{Binding Id}">
                                                <FontIcon Glyph="&#xE8A5;" FontSize="14" />
                                            </Button>
                                            <Button Padding="8" Background="Transparent" BorderThickness="0"
                                                    ToolTipService.ToolTip="Navigate to Related Page"
                                                    Click="NavigateToSource_Click" Tag="{Binding NavigationTarget}">
                                                <FontIcon Glyph="&#xE72A;" FontSize="14" />
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Notification History Section -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7E7;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Notification History" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <TextBlock x:Name="NotificationCountText" Text="(0)"
                                       Foreground="{ThemeResource SystemBaseMediumColor}"
                                       VerticalAlignment="Center" />
                        </StackPanel>

                        <Button Grid.Column="1" Content="Export" Click="ExportNotifications_Click" />
                    </Grid>

                    <TextBlock x:Name="NoNotificationsText" Text="No notifications"
                               Foreground="{ThemeResource SystemBaseMediumColor}"
                               Visibility="Collapsed" />

                    <ListView x:Name="NotificationHistoryList" SelectionMode="None" MaxHeight="600">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="services:NotificationHistoryItem">
                                <Border CornerRadius="4" Padding="12" Margin="0,4"
                                        Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <Border Grid.Column="0" Width="4" CornerRadius="2"
                                                Background="{Binding Type, Converter={StaticResource NotificationTypeToColor}}"
                                                Margin="0,0,12,0" />

                                        <StackPanel Grid.Column="1" Spacing="4">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="{Binding Type, Converter={StaticResource NotificationTypeToIcon}}"
                                                          FontSize="14"
                                                          Foreground="{Binding Type, Converter={StaticResource NotificationTypeToColor}}" />
                                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                                            </StackPanel>
                                            <TextBlock Text="{Binding Message}" TextWrapping="Wrap"
                                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                                            <StackPanel Orientation="Horizontal" Spacing="16">
                                                <TextBlock Text="{Binding Timestamp}"
                                                           Style="{StaticResource CaptionTextBlockStyle}" />
                                                <TextBlock Text="{Binding Tag}"
                                                           Style="{StaticResource CaptionTextBlockStyle}"
                                                           Foreground="{ThemeResource SystemBaseMediumColor}" />
                                            </StackPanel>
                                        </StackPanel>

                                        <Button Grid.Column="2" Padding="8" Background="Transparent"
                                                BorderThickness="0" VerticalAlignment="Top"
                                                ToolTipService.ToolTip="Dismiss"
                                                Click="DismissNotification_Click" Tag="{Binding}">
                                            <FontIcon Glyph="&#xE711;" FontSize="12" />
                                        </Button>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Snooze Rules Section -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE823;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Snooze Rules" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <TextBlock Text="Temporarily suppress notifications for noisy alert sources"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource SystemBaseMediumColor}" />

                    <ListView x:Name="SnoozeRulesList" SelectionMode="None">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8" ColumnSpacing="16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="{Binding Source}" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="{Binding ExpiresIn}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    <TextBlock Grid.Column="2" Text="{Binding Reason}"
                                               Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    <Button Grid.Column="3" Content="Remove" Click="RemoveSnooze_Click"
                                            Tag="{Binding Id}" />
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <ComboBox x:Name="SnoozeSourceCombo" Header="Source" Width="150">
                            <ComboBoxItem Content="Connection" Tag="connection" />
                            <ComboBoxItem Content="Backfill" Tag="backfill" />
                            <ComboBoxItem Content="Storage" Tag="storage" />
                            <ComboBoxItem Content="Data Quality" Tag="datagap" />
                        </ComboBox>
                        <ComboBox x:Name="SnoozeDurationCombo" Header="Duration" Width="150">
                            <ComboBoxItem Content="15 minutes" Tag="15" />
                            <ComboBoxItem Content="1 hour" Tag="60" IsSelected="True" />
                            <ComboBoxItem Content="4 hours" Tag="240" />
                            <ComboBoxItem Content="24 hours" Tag="1440" />
                        </ComboBox>
                        <Button Content="Add Snooze Rule" Click="AddSnoozeRule_Click"
                                VerticalAlignment="Bottom" Margin="0,0,0,0" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Quick Actions -->
            <Border Style="{StaticResource CardStyle}">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE768;" Foreground="{ThemeResource SystemAccentColor}" />
                        <TextBlock Text="Quick Actions" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button Content="Test Notification" Click="TestNotification_Click" />
                        <Button Content="Acknowledge All" Click="AcknowledgeAll_Click" />
                        <Button Content="Notification Settings" Click="OpenSettings_Click" />
                        <Button Content="Create Support Bundle" Click="CreateSupportBundle_Click" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</Page>
