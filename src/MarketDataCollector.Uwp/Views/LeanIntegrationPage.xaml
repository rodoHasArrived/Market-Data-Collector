<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MarketDataCollector.Uwp.Views.LeanIntegrationPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="380" />
        </Grid.ColumnDefinitions>

        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Padding="24">
            <StackPanel Spacing="24" MaxWidth="900">
                <!-- Header -->
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <FontIcon Glyph="&#xE9F5;" FontSize="28" Foreground="{ThemeResource SystemAccentColor}" />
                    <TextBlock Text="QuantConnect Lean Integration" Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center" />
                </StackPanel>

                <TextBlock Text="Connect your collected data to QuantConnect Lean for backtesting algorithms."
                           Style="{StaticResource BodyTextBlockStyle}"
                           Foreground="{ThemeResource SystemBaseMediumColor}" />

                <!-- Status Card -->
                <Border Style="{StaticResource CardStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Ellipse x:Name="StatusIndicator" Width="12" Height="12" Fill="#48BB78" />
                                <TextBlock x:Name="StatusText" Text="Lean Integration Active"
                                           Style="{StaticResource SubtitleTextBlockStyle}" />
                            </StackPanel>
                            <TextBlock x:Name="StatusDetailsText"
                                       Text="Last sync: Never | Symbols synced: 0"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource SystemBaseMediumColor}" />
                        </StackPanel>

                        <Button Grid.Column="1" Content="Verify Installation" Click="VerifyInstallation_Click" />
                    </Grid>
                </Border>

                <!-- Configuration -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <TextBlock Text="Configuration" Style="{StaticResource SubtitleTextBlockStyle}" />

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBox x:Name="LeanPathBox" Header="Lean Installation Path"
                                     PlaceholderText="C:\Lean" />
                            <Button Grid.Column="1" Content="Browse..." VerticalAlignment="Bottom"
                                    Click="BrowseLeanPath_Click" />
                        </Grid>

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBox x:Name="DataPathBox" Header="Lean Data Path"
                                     PlaceholderText="C:\Lean\Data" />
                            <Button Grid.Column="1" Content="Browse..." VerticalAlignment="Bottom"
                                    Click="BrowseDataPath_Click" />
                        </Grid>

                        <ToggleSwitch x:Name="AutoSyncToggle" Header="Auto-sync Data"
                                      OffContent="Manual sync only"
                                      OnContent="Sync after collection" />

                        <Button Content="Save Configuration" Style="{StaticResource AccentButtonStyle}"
                                Click="SaveConfig_Click" />
                    </StackPanel>
                </Border>

                <!-- Data Sync -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE895;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Data Synchronization" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <TextBlock Text="Convert collected data to Lean format for backtesting."
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}" />

                        <AutoSuggestBox x:Name="SyncSymbolsBox"
                                        Header="Symbols to Sync (comma-separated, empty for all)"
                                        PlaceholderText="AAPL,MSFT,TSLA" />

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <CalendarDatePicker x:Name="SyncFromDate" Header="From Date" HorizontalAlignment="Stretch" />
                            <CalendarDatePicker x:Name="SyncToDate" Header="To Date" HorizontalAlignment="Stretch" />
                        </Grid>

                        <ComboBox x:Name="ResolutionCombo" Header="Resolution" SelectedIndex="2" HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Tick" Tag="Tick" />
                            <ComboBoxItem Content="Second" Tag="Second" />
                            <ComboBoxItem Content="Minute" Tag="Minute" />
                            <ComboBoxItem Content="Hour" Tag="Hour" />
                            <ComboBoxItem Content="Daily" Tag="Daily" />
                        </ComboBox>

                        <CheckBox x:Name="OverwriteSyncCheck" Content="Overwrite existing Lean data" />

                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <Button x:Name="SyncDataButton"
                                    Content="Sync Data"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="SyncData_Click" />
                            <ProgressRing x:Name="SyncProgress" IsActive="False" Width="24" Height="24" />
                            <TextBlock x:Name="SyncStatusText" VerticalAlignment="Center"
                                       Style="{StaticResource CaptionTextBlockStyle}" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Backtest Runner -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE768;" Foreground="{ThemeResource SystemAccentColor}" />
                            <TextBlock Text="Run Backtest" Style="{StaticResource SubtitleTextBlockStyle}" />
                        </StackPanel>

                        <ComboBox x:Name="AlgorithmCombo" Header="Algorithm" HorizontalAlignment="Stretch"
                                  PlaceholderText="Select an algorithm..." />

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <CalendarDatePicker x:Name="BacktestStartDate" Header="Start Date" HorizontalAlignment="Stretch" />
                            <CalendarDatePicker x:Name="BacktestEndDate" Header="End Date" HorizontalAlignment="Stretch" />
                        </Grid>

                        <NumberBox x:Name="InitialCapitalBox" Header="Initial Capital ($)"
                                   Value="100000" Minimum="1000" Maximum="100000000"
                                   SpinButtonPlacementMode="Compact" />

                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <Button x:Name="RunBacktestButton"
                                    Content="Run Backtest"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="RunBacktest_Click" />
                            <Button x:Name="StopBacktestButton"
                                    Content="Stop"
                                    Visibility="Collapsed"
                                    Click="StopBacktest_Click" />
                            <ProgressRing x:Name="BacktestProgress" IsActive="False" Width="24" Height="24" />
                        </StackPanel>

                        <!-- Backtest Progress -->
                        <StackPanel x:Name="BacktestProgressPanel" Visibility="Collapsed" Spacing="8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBlock x:Name="BacktestProgressText" Text="Processing..." />
                                <TextBlock x:Name="BacktestProgressPercent" Grid.Column="1" Text="0%" />
                            </Grid>
                            <ProgressBar x:Name="BacktestProgressBar" Minimum="0" Maximum="100" Value="0" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Results -->
                <Border x:Name="ResultsCard" Style="{StaticResource CardStyle}" Visibility="Collapsed">
                    <StackPanel Spacing="16">
                        <TextBlock Text="Backtest Results" Style="{StaticResource SubtitleTextBlockStyle}" />

                        <Grid ColumnSpacing="24">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock x:Name="TotalReturnText" Text="+12.5%"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#48BB78" />
                                <TextBlock Text="Total Return" Style="{StaticResource CaptionTextBlockStyle}" />
                            </StackPanel>

                            <StackPanel Grid.Column="1">
                                <TextBlock x:Name="SharpeRatioText" Text="1.45"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="{ThemeResource SystemAccentColor}" />
                                <TextBlock Text="Sharpe Ratio" Style="{StaticResource CaptionTextBlockStyle}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock x:Name="MaxDrawdownText" Text="-8.2%"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="#F56565" />
                                <TextBlock Text="Max Drawdown" Style="{StaticResource CaptionTextBlockStyle}" />
                            </StackPanel>

                            <StackPanel Grid.Column="3">
                                <TextBlock x:Name="TotalTradesText" Text="156"
                                           Style="{StaticResource SubheaderTextBlockStyle}"
                                           Foreground="{ThemeResource SystemAccentColor}" />
                                <TextBlock Text="Total Trades" Style="{StaticResource CaptionTextBlockStyle}" />
                            </StackPanel>
                        </Grid>

                        <Button Content="View Full Results" Click="ViewResults_Click" />
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Right Panel -->
        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" Padding="12,24,24,24">
            <StackPanel Spacing="16">
                <!-- Quick Actions -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Quick Actions" Style="{StaticResource BodyStrongTextBlockStyle}" />

                        <Button Content="Open Lean Folder" HorizontalAlignment="Stretch"
                                Click="OpenLeanFolder_Click" />
                        <Button Content="Refresh Algorithms" HorizontalAlignment="Stretch"
                                Click="RefreshAlgorithms_Click" />
                        <Button Content="View Lean Docs" HorizontalAlignment="Stretch"
                                Click="ViewDocs_Click" />
                    </StackPanel>
                </Border>

                <!-- Recent Backtests -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Recent Backtests" Style="{StaticResource BodyStrongTextBlockStyle}" />

                        <ListView x:Name="RecentBacktestsList" SelectionMode="None" MaxHeight="250">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="4" ColumnSpacing="8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="{Binding AlgorithmName}"
                                                   FontWeight="SemiBold" />
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ReturnText}"
                                                   Foreground="{Binding ReturnColor}" />

                                        <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                   Text="{Binding DateText}"
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>

                        <TextBlock x:Name="NoBacktestsText" Text="No recent backtests"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource SystemBaseMediumColor}" />
                    </StackPanel>
                </Border>

                <!-- Sync Stats -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Data Sync Stats" Style="{StaticResource BodyStrongTextBlockStyle}" />

                        <Grid RowSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Symbols Synced" />
                            <TextBlock x:Name="SymbolsSyncedText" Grid.Row="0" Grid.Column="1" Text="0"
                                       FontWeight="SemiBold" />

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Total Data Files" />
                            <TextBlock x:Name="DataFilesText" Grid.Row="1" Grid.Column="1" Text="0"
                                       FontWeight="SemiBold" />

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Last Sync" />
                            <TextBlock x:Name="LastSyncText" Grid.Row="2" Grid.Column="1" Text="Never"
                                       FontWeight="SemiBold" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Info -->
                <Border Style="{StaticResource CardStyle}"
                        Background="{ThemeResource SystemFillColorNeutralBackgroundBrush}">
                    <StackPanel Spacing="8">
                        <TextBlock Text="About Lean" Style="{StaticResource BodyStrongTextBlockStyle}" />

                        <TextBlock Text="QuantConnect Lean is an open-source algorithmic trading engine for backtesting and live trading."
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   TextWrapping="Wrap" />

                        <HyperlinkButton Content="Learn More" NavigateUri="https://www.quantconnect.com/lean" />
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
