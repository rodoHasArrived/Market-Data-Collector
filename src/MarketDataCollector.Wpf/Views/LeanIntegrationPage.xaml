<Page x:Class="MarketDataCollector.Wpf.Views.LeanIntegrationPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Background="{DynamicResource ConsoleBackgroundDarkBrush}"
      Loaded="OnPageLoaded">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="340" />
        </Grid.ColumnDefinitions>

        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Padding="24">
            <StackPanel MaxWidth="900">
                <!-- Header -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                    <TextBlock Text="&#xE943;" FontFamily="{StaticResource SymbolThemeFontFamily}"
                               FontSize="28" Foreground="{StaticResource InfoColorBrush}" VerticalAlignment="Center" />
                    <TextBlock Text="QuantConnect Lean Integration" Style="{StaticResource PageTitleStyle}" Margin="12,0,0,0" VerticalAlignment="Center" />
                </StackPanel>
                <TextBlock Text="Connect your collected data to QuantConnect Lean for backtesting algorithms."
                           Style="{StaticResource PageSubtitleStyle}" Margin="0,0,0,20" />

                <!-- Status Card -->
                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <Ellipse x:Name="StatusIndicator" Width="12" Height="12" Fill="#48BB78" VerticalAlignment="Center" />
                                <TextBlock x:Name="StatusText" Text="Not Configured" Style="{StaticResource CardHeaderStyle}" Margin="8,0,0,0" />
                            </StackPanel>
                            <TextBlock x:Name="StatusDetailsText" Text="Last sync: Never | Symbols synced: 0"
                                       Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="12" />
                        </StackPanel>
                        <Button Grid.Column="1" Content="Verify Installation" Click="VerifyInstallation_Click" Style="{StaticResource FormButtonStyle}" />
                    </Grid>
                </Border>

                <!-- Configuration -->
                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Configuration" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,16" />
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <StackPanel>
                                <TextBlock Text="Lean Installation Path" Style="{StaticResource FormLabelStyle}" />
                                <TextBox x:Name="LeanPathBox" Style="{StaticResource FormTextBoxStyle}" />
                            </StackPanel>
                            <Button Grid.Column="1" Content="Browse..." VerticalAlignment="Bottom" Click="BrowseLeanPath_Click" Style="{StaticResource FormButtonStyle}" Margin="8,0,0,0" />
                        </Grid>
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <StackPanel>
                                <TextBlock Text="Lean Data Path" Style="{StaticResource FormLabelStyle}" />
                                <TextBox x:Name="DataPathBox" Style="{StaticResource FormTextBoxStyle}" />
                            </StackPanel>
                            <Button Grid.Column="1" Content="Browse..." VerticalAlignment="Bottom" Click="BrowseDataPath_Click" Style="{StaticResource FormButtonStyle}" Margin="8,0,0,0" />
                        </Grid>
                        <CheckBox x:Name="AutoSyncToggle" Content="Auto-sync data after collection" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,0,0,12" />
                        <Button Content="Save Configuration" Click="SaveConfig_Click" Style="{StaticResource FormButtonStyle}" />
                    </StackPanel>
                </Border>

                <!-- Data Sync -->
                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Data Synchronization" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,4" />
                        <TextBlock Text="Convert collected data to Lean format for backtesting." Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="12" Margin="0,0,0,16" />

                        <TextBlock Text="Symbols (comma-separated, empty for all)" Style="{StaticResource FormLabelStyle}" />
                        <TextBox x:Name="SyncSymbolsBox" Style="{StaticResource FormTextBoxStyle}" Margin="0,0,0,8" />

                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Margin="0,0,8,0">
                                <TextBlock Text="From Date" Style="{StaticResource FormLabelStyle}" />
                                <DatePicker x:Name="SyncFromDate" />
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                <TextBlock Text="To Date" Style="{StaticResource FormLabelStyle}" />
                                <DatePicker x:Name="SyncToDate" />
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Resolution" Style="{StaticResource FormLabelStyle}" />
                        <ComboBox x:Name="ResolutionCombo" Style="{StaticResource FormComboBoxStyle}" SelectedIndex="2" Margin="0,0,0,8">
                            <ComboBoxItem Content="Tick" Tag="Tick" />
                            <ComboBoxItem Content="Second" Tag="Second" />
                            <ComboBoxItem Content="Minute" Tag="Minute" />
                            <ComboBoxItem Content="Hour" Tag="Hour" />
                            <ComboBoxItem Content="Daily" Tag="Daily" />
                        </ComboBox>

                        <CheckBox x:Name="OverwriteSyncCheck" Content="Overwrite existing Lean data" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,0,0,12" />

                        <StackPanel Orientation="Horizontal">
                            <Button x:Name="SyncDataButton" Content="Sync Data" Click="SyncData_Click" Style="{StaticResource FormButtonStyle}" />
                            <TextBlock x:Name="SyncStatusText" VerticalAlignment="Center" Margin="12,0,0,0" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="12" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Backtest Runner -->
                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Run Backtest" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,16" />

                        <TextBlock Text="Algorithm" Style="{StaticResource FormLabelStyle}" />
                        <ComboBox x:Name="AlgorithmCombo" Style="{StaticResource FormComboBoxStyle}" Margin="0,0,0,8" />

                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Margin="0,0,8,0">
                                <TextBlock Text="Start Date" Style="{StaticResource FormLabelStyle}" />
                                <DatePicker x:Name="BacktestStartDate" />
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                <TextBlock Text="End Date" Style="{StaticResource FormLabelStyle}" />
                                <DatePicker x:Name="BacktestEndDate" />
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Initial Capital ($)" Style="{StaticResource FormLabelStyle}" />
                        <TextBox x:Name="InitialCapitalBox" Style="{StaticResource FormTextBoxStyle}" Text="100000" Margin="0,0,0,12" />

                        <StackPanel Orientation="Horizontal">
                            <Button x:Name="RunBacktestButton" Content="Run Backtest" Click="RunBacktest_Click" Style="{StaticResource FormButtonStyle}" />
                            <Button x:Name="StopBacktestButton" Content="Stop" Visibility="Collapsed" Click="StopBacktest_Click" Style="{StaticResource FormButtonStyle}" Margin="8,0,0,0" />
                            <TextBlock x:Name="BacktestStatusText" VerticalAlignment="Center" Margin="12,0,0,0" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="12" />
                        </StackPanel>

                        <!-- Progress -->
                        <StackPanel x:Name="BacktestProgressPanel" Visibility="Collapsed" Margin="0,12,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock x:Name="BacktestProgressText" Text="Processing..." Foreground="{DynamicResource ConsoleTextBrush}" />
                                <TextBlock x:Name="BacktestProgressPercent" Grid.Column="1" Text="0%" Foreground="{DynamicResource ConsoleTextBrush}" />
                            </Grid>
                            <ProgressBar x:Name="BacktestProgressBar" Minimum="0" Maximum="100" Value="0" Margin="0,4,0,0" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Results -->
                <Border x:Name="ResultsCard" Style="{StaticResource CardStyle}" Visibility="Collapsed" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Backtest Results" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,16" />
                        <UniformGrid Columns="4" Margin="0,0,0,12">
                            <StackPanel>
                                <TextBlock x:Name="TotalReturnText" Text="+12.5%" FontSize="20" FontWeight="Bold" Foreground="{StaticResource SuccessColorBrush}" />
                                <TextBlock Text="Total Return" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="11" />
                            </StackPanel>
                            <StackPanel>
                                <TextBlock x:Name="SharpeRatioText" Text="1.45" FontSize="20" FontWeight="Bold" Foreground="{StaticResource InfoColorBrush}" />
                                <TextBlock Text="Sharpe Ratio" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="11" />
                            </StackPanel>
                            <StackPanel>
                                <TextBlock x:Name="MaxDrawdownText" Text="-8.2%" FontSize="20" FontWeight="Bold" Foreground="{StaticResource ErrorColorBrush}" />
                                <TextBlock Text="Max Drawdown" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="11" />
                            </StackPanel>
                            <StackPanel>
                                <TextBlock x:Name="TotalTradesText" Text="156" FontSize="20" FontWeight="Bold" Foreground="{StaticResource InfoColorBrush}" />
                                <TextBlock Text="Total Trades" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="11" />
                            </StackPanel>
                        </UniformGrid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Right Panel -->
        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" Padding="12,24,24,24">
            <StackPanel>
                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Quick Actions" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,12" />
                        <Button Content="Refresh Algorithms" Click="RefreshAlgorithms_Click" Style="{StaticResource FormButtonStyle}" HorizontalAlignment="Stretch" Margin="0,0,0,8" />
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Recent Backtests" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,12" />
                        <ItemsControl x:Name="RecentBacktestsList" MaxHeight="250">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="4" Margin="0,0,0,4">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="{Binding AlgorithmName}" FontWeight="SemiBold" Foreground="{DynamicResource ConsoleTextBrush}" />
                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ReturnText}" Foreground="{Binding ReturnBrush}" />
                                            <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Text="{Binding DateText}" FontSize="11" Foreground="{StaticResource ConsoleTextMutedBrush}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        <TextBlock x:Name="NoBacktestsText" Text="No recent backtests" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="12" />
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Data Sync Stats" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,12" />
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Symbols Synced" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,2" />
                            <TextBlock Grid.Row="0" Grid.Column="1" x:Name="SymbolsSyncedText" Text="0" FontWeight="SemiBold" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,2" />
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Total Data Files" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,2" />
                            <TextBlock Grid.Row="1" Grid.Column="1" x:Name="DataFilesText" Text="0" FontWeight="SemiBold" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,2" />
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Last Sync" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,2" />
                            <TextBlock Grid.Row="2" Grid.Column="1" x:Name="LastSyncText" Text="Never" FontWeight="SemiBold" Foreground="{DynamicResource ConsoleTextBrush}" Margin="0,2" />
                        </Grid>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="About Lean" Style="{StaticResource CardHeaderStyle}" Margin="0,0,0,8" />
                        <TextBlock Text="QuantConnect Lean is an open-source algorithmic trading engine for backtesting and live trading." TextWrapping="Wrap" Foreground="{StaticResource ConsoleTextMutedBrush}" FontSize="12" />
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
