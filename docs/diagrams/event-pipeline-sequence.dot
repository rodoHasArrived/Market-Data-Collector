// Event Pipeline Sequence Diagram
// Market Data Collector v1.6.1
// Last Updated: 2026-02-21
//
// This diagram shows the sequence of event processing through the pipeline,
// from data source to storage and optional distributed messaging.
//
// Generate: dot -Tpng event-pipeline-sequence.dot -o event-pipeline-sequence.png
//           dot -Tsvg event-pipeline-sequence.dot -o event-pipeline-sequence.svg

digraph EventPipelineSequence {
  rankdir=LR;
  graph [fontname="Helvetica", fontsize=12, bgcolor="white", splines=ortho, pad=0.5];
  node  [fontname="Helvetica", fontsize=10, shape=box, style="rounded,filled"];
  edge  [fontname="Helvetica", fontsize=9, color="#4a5568"];

  // Title
  labelloc="t";
  label="Market Data Collector - Event Pipeline Sequence\nAsync Producer-Consumer Pattern | v1.6.1";

  // Phase 1: Data Source
  subgraph cluster_source {
    label="1. Data Source";
    color="#4a90d9";
    style="rounded";
    bgcolor="#f0f8ff";

    SOURCE [fillcolor="#bfdbfe",
            label="Data Provider\n(IB/Alpaca/NYSE)\n\nWebSocket connection\nRaw market data"];

    RAW_EVENT [shape=note, fillcolor="#dbeafe",
               label="Raw Events:\n• tickPrice\n• tickSize\n• updateMktDepth\n• historicalData"];
  }

  // Phase 2: Provider Client
  subgraph cluster_client {
    label="2. Provider Client";
    color="#2b6cb0";
    style="rounded";
    bgcolor="#dbeafe";

    CLIENT [fillcolor="#93c5fd",
            label="IMarketDataClient\n\nNormalize to domain\nValidate structure\nAdd metadata"];

    CALLBACK [fillcolor="#93c5fd",
              label="IBCallbackRouter /\nWebSocket Handler\n\nRoute by event type"];

    TRANSFORM [shape=note, fillcolor="#bfdbfe",
               label="Transforms:\n• Raw → MarketTradeUpdate\n• Raw → MarketQuoteUpdate\n• Raw → MarketDepthUpdate"];
  }

  // Phase 3: Domain Collectors
  subgraph cluster_collectors {
    label="3. Domain Collectors";
    color="#2c7a7b";
    style="rounded";
    bgcolor="#d1fae5";

    TRADE_COLL [fillcolor="#6ee7b7",
                label="TradeDataCollector\n\nSequence validation\nAggressor inference\nOrder flow stats"];

    QUOTE_COLL [fillcolor="#6ee7b7",
                label="QuoteCollector\n\nBBO state cache\nSpread calculation\nEmit BboQuote"];

    DEPTH_COLL [fillcolor="#6ee7b7",
                label="MarketDepthCollector\n\nL2 book state\nIntegrity checking\nSnapshot generation"];

    DOMAIN_EVENT [shape=note, fillcolor="#a7f3d0",
                  label="Domain Events:\n• Trade\n• BboQuote\n• LOBSnapshot\n• IntegrityEvent"];
  }

  // Phase 4: F# Validation
  subgraph cluster_validation {
    label="4. F# Validation";
    color="#2c7a7b";
    style="rounded";
    bgcolor="#e6fffa";

    FSHARP_VAL [fillcolor="#81e6d9",
                label="Railway-Oriented\nValidation\n\nType-safe checks\nError accumulation"];

    VAL_RULES [shape=note, fillcolor="#b2f5ea",
               label="Validation Rules:\n• Price > 0\n• Size > 0\n• Valid timestamp\n• Symbol format"];
  }

  // Phase 5: Event Pipeline
  subgraph cluster_pipeline {
    label="5. Event Pipeline (System.Threading.Channels)";
    color="#805ad5";
    style="rounded";
    bgcolor="#ede9fe";

    CHANNEL [fillcolor="#c4b5fd",
             label="BoundedChannel<MarketEvent>\n\nCapacity: 100,000\nDropOldest on full\nAsync write/read"];

    PIPELINE_READER [fillcolor="#c4b5fd",
                     label="Pipeline Reader\n\nBackground consumer\nBatch processing"];

    CHANNEL_STATS [shape=note, fillcolor="#ddd6fe",
                   label="Metrics:\n• Channel depth\n• Events/second\n• Drop count"];
  }

  // Phase 6: Composite Publisher
  subgraph cluster_publisher {
    label="6. Composite Publisher";
    color="#805ad5";
    style="rounded";
    bgcolor="#faf5ff";

    COMPOSITE [fillcolor="#ddd6fe",
               label="CompositePublisher\n\nFanout to sinks\nParallel dispatch"];

    subgraph cluster_sinks {
      label="Configured Sinks";
      style="dashed";
      color="#6b21a8";

      LOCAL_SINK [fillcolor="#e9d5ff",
                  label="PipelinePublisher\n(Local Storage)"];
      MT_SINK [fillcolor="#e9d5ff",
               label="MassTransitPublisher\n(Message Bus)"];
    }
  }

  // Phase 7a: Local Storage Path
  subgraph cluster_storage {
    label="7a. Local Storage Path";
    color="#c53030";
    style="rounded";
    bgcolor="#fee2e2";

    WAL [fillcolor="#fc8181", fontcolor="white",
         label="Write-Ahead Log\n\nJournal first\nCrash-safe"];

    JSONL [fillcolor="#fecaca",
           label="JSONL Sink\n\nAppend event\nFlush buffer"];

    STORAGE_RESULT [shape=note, fillcolor="#feb2b2",
                    label="Output:\n{symbol}_{type}_{date}.jsonl\n(optionally compressed)"];
  }

  // Phase 7b: Distributed Path
  subgraph cluster_messaging {
    label="7b. Distributed Messaging Path (Optional)";
    color="#e53e3e";
    style="dashed";
    bgcolor="#fff5f5";

    MASSTRANSIT [fillcolor="#fc8181", fontcolor="white",
                 label="MassTransit\n\nSerialize event\nPublish to bus"];

    EXCHANGE [fillcolor="#fecaca",
              label="RabbitMQ Exchange\n\nFanout to queues"];

    CONSUMERS [fillcolor="#fecaca",
               label="Microservice\nConsumers\n\n:5001-:5005"];
  }

  // Phase 8: Monitoring
  subgraph cluster_monitoring {
    label="8. Observability";
    color="#38a169";
    style="rounded";
    bgcolor="#f0fff4";

    METRICS [fillcolor="#9ae6b4",
             label="Metrics\n\nmdc_published++\nmdc_events_per_second"];

    TRACES [fillcolor="#9ae6b4",
            label="OpenTelemetry\n\nSpan per event\nDistributed context"];

    STATUS [fillcolor="#9ae6b4",
            label="StatusHttpServer\n\n/metrics, /status\n/health"];
  }

  // Data Flow
  SOURCE -> CLIENT [color="#4a90d9", penwidth=2, label="1"];
  RAW_EVENT -> CLIENT [style=dashed];
  CLIENT -> CALLBACK [color="#2b6cb0"];
  CALLBACK -> TRANSFORM [style=dashed];

  CALLBACK -> TRADE_COLL [color="#2c7a7b", penwidth=2, label="2a"];
  CALLBACK -> QUOTE_COLL [color="#2c7a7b", penwidth=2, label="2b"];
  CALLBACK -> DEPTH_COLL [color="#2c7a7b", penwidth=2, label="2c"];

  TRADE_COLL -> DOMAIN_EVENT [style=dashed];
  QUOTE_COLL -> DOMAIN_EVENT [style=dashed];
  DEPTH_COLL -> DOMAIN_EVENT [style=dashed];

  TRADE_COLL -> FSHARP_VAL [color="#2c7a7b", label="3"];
  QUOTE_COLL -> FSHARP_VAL [color="#2c7a7b"];
  DEPTH_COLL -> FSHARP_VAL [color="#2c7a7b"];
  FSHARP_VAL -> VAL_RULES [style=dashed];

  FSHARP_VAL -> CHANNEL [color="#805ad5", penwidth=2, label="4\nasync write"];
  CHANNEL -> CHANNEL_STATS [style=dashed];
  CHANNEL -> PIPELINE_READER [color="#805ad5", label="5\nasync read"];
  PIPELINE_READER -> COMPOSITE [color="#805ad5", penwidth=2];

  COMPOSITE -> LOCAL_SINK [color="#805ad5", label="6a"];
  COMPOSITE -> MT_SINK [color="#805ad5", style=dashed, label="6b"];

  LOCAL_SINK -> WAL [color="#c53030", penwidth=2, label="7a"];
  WAL -> JSONL [color="#c53030", penwidth=2];
  JSONL -> STORAGE_RESULT [style=dashed];

  MT_SINK -> MASSTRANSIT [color="#e53e3e", style=dashed, label="7b"];
  MASSTRANSIT -> EXCHANGE [color="#e53e3e", style=dashed];
  EXCHANGE -> CONSUMERS [color="#e53e3e", style=dashed];

  // Monitoring connections
  PIPELINE_READER -> METRICS [style=dashed, color="#38a169"];
  COMPOSITE -> TRACES [style=dashed, color="#38a169"];
  METRICS -> STATUS [style=dashed, color="#38a169"];

  // Legend
  subgraph cluster_legend {
    label="Legend";
    style="rounded";
    color="#666666";
    bgcolor="#fafafa";

    LEG [shape=plaintext,
         label="━━ Synchronous flow\n─ ─ Async/Optional flow\n→ Data transformation point\n\nNumbers indicate processing order"];
  }
}
