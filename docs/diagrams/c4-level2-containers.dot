// C4 Level 2: Container Diagram
// Market Data Collector v1.6.1
// Last Updated: 2026-02-21
//
// This diagram shows the major deployable units within the system.
// It answers: "What are the major technology choices?"
//
// Generate: dot -Tpng c4-level2-containers.dot -o c4-level2-containers.png
//           dot -Tsvg c4-level2-containers.dot -o c4-level2-containers.svg

digraph C4_Containers {
  rankdir=TB;
  graph [fontname="Helvetica", fontsize=12, bgcolor="white", compound=true, pad=0.5];
  node  [fontname="Helvetica", fontsize=10, shape=box, style="rounded,filled"];
  edge  [fontname="Helvetica", fontsize=9, color="#4a5568"];

  // Title
  labelloc="t";
  label="Market Data Collector - Container Diagram (C4 Level 2)\nv1.6.1";

  // External Actors
  Operator [shape=oval, style="filled", fillcolor="#08427b", fontcolor="white",
            label="Operator\n[Person]"];
  Quant [shape=oval, style="filled", fillcolor="#08427b", fontcolor="white",
         label="Quant/Analyst\n[Person]"];

  // External Systems - Data Sources
  subgraph cluster_external {
    label="External Data Sources";
    color="#999999";
    style="dashed";
    bgcolor="#fafafa";

    IB [shape=box, style="rounded,filled", fillcolor="#4a90d9", fontcolor="white",
        label="Interactive Brokers\n[External]\n\nTWS/Gateway"];
    ALP [shape=box, style="rounded,filled", fillcolor="#4a90d9", fontcolor="white",
         label="Alpaca\n[External]\n\nWebSocket"];
    NYSE [shape=box, style="rounded,filled", fillcolor="#4a90d9", fontcolor="white",
          label="NYSE Direct\n[External]\n\nExchange Feed"];
    POL [shape=box, style="rounded,filled", fillcolor="#4a90d9", fontcolor="white",
         label="Polygon.io\n[External]\n\nWebSocket"];
    SS [shape=box, style="rounded,filled", fillcolor="#4a90d9", fontcolor="white",
        label="StockSharp\n[External]\n\nMulti-Exchange"];
    HIST_PROVIDERS [shape=box, style="rounded,filled", fillcolor="#38a169", fontcolor="white",
                    label="Historical APIs\n[External]\n\nYahoo, Tiingo, Finnhub\nPolygon, Stooq, IB, etc.\n(10 providers)"];
  }

  // System Boundary
  subgraph cluster_mdc {
    label="Market Data Collector System Boundary";
    color="#438dd5";
    style="rounded";
    bgcolor="#f0f8ff";

    // Presentation Layer
    subgraph cluster_presentation {
      label="Presentation Layer";
      color="#805ad5";
      style="rounded";
      bgcolor="#faf5ff";

      WPF [shape=box, style="rounded,filled", fillcolor="#805ad5", fontcolor="white",
           label="WPF Desktop App\n[.NET 9 / WPF]\n\n40+ pages: Dashboard, Config,\nBackfill, Export, Monitoring\nNative Windows experience"];

      WEB_UI [shape=box, style="rounded,filled", fillcolor="#805ad5", fontcolor="white",
              label="Web Dashboard\n[ASP.NET / HTML]\n\nBrowser-based monitoring\nReal-time status updates\n/status endpoint"];

      CLI [shape=box, style="rounded,filled", fillcolor="#805ad5", fontcolor="white",
           label="CLI Interface\n[.NET Console]\n\nCommand-line operation\n24+ flags: --wizard, --auto-config\n--backfill, --ui, --dry-run"];
    }

    // Onboarding & Diagnostics Layer
    subgraph cluster_onboarding {
      label="Onboarding & Diagnostics Layer";
      color="#ed8936";
      style="rounded";
      bgcolor="#fffaf0";

      WIZARD [shape=box, style="rounded,filled", fillcolor="#ed8936", fontcolor="white",
              label="Configuration Wizard\n[Interactive Setup]\n\n8-step guided setup\nProvider detection\nTemplate generation"];

      AUTO_CONFIG [shape=box, style="rounded,filled", fillcolor="#fbd38d",
                   label="Auto-Configuration\n[Service]\n\nEnv var detection\nUse case presets\nSelf-healing config"];

      DIAGNOSTICS [shape=box, style="rounded,filled", fillcolor="#fbd38d",
                   label="Diagnostic Services\n[8 Services]\n\nConnectivity testing\nCredential validation\nFirst-run detection"];

      ERROR_FMT [shape=box, style="rounded,filled", fillcolor="#fbd38d",
                 label="Error Formatter\n[UX Service]\n\n24 error codes\nFriendly messages\nTroubleshooting tips"];
    }

    // Core Collector Service
    CORE [shape=box, style="rounded,filled", fillcolor="#438dd5", fontcolor="white", width=3.5,
          label="Market Data Collector Core\n[.NET 9 Console App | C# 13]\n\nEvent pipeline with 100K bounded channel\nCollectors: Trade, Quote, OrderBook\nStreaming + Historical data processing\nPrometheus metrics, health endpoints"];

    // F# Domain Library
    FSHARP [shape=box, style="rounded,filled", fillcolor="#2c7a7b", fontcolor="white",
            label="F# Domain Library\n[.NET Library | F# 8]\n\nType-safe domain models\nRailway-oriented validation\nPure functional calculations\nDiscriminated unions"];

    // Contracts Library
    CONTRACTS [shape=box, style="rounded,filled", fillcolor="#718096", fontcolor="white",
               label="Contracts Library\n[.NET Library]\n\nShared DTOs\nEvent interfaces\nMassTransit contracts"];

    // Microservices (Optional)
    subgraph cluster_microservices {
      label="Microservices (Optional Distributed Deployment)";
      color="#2c7a7b";
      style="dashed";
      bgcolor="#e6fffa";

      GATEWAY [shape=box, style="rounded,filled", fillcolor="#2c7a7b", fontcolor="white",
               label="API Gateway\n[ASP.NET Core]\n:5000\n\nRouting, Rate Limiting\nAuth, Health Aggregation"];

      TRADE_SVC [shape=box, style="rounded,filled", fillcolor="#319795", fontcolor="white",
                 label="Trade Ingestion\n[.NET Worker]\n:5001\n\nHigh-throughput\nSequence validation"];

      ORDERBOOK_SVC [shape=box, style="rounded,filled", fillcolor="#319795", fontcolor="white",
                     label="OrderBook Ingestion\n[.NET Worker]\n:5002\n\nL2 depth processing\nIntegrity checking"];

      QUOTE_SVC [shape=box, style="rounded,filled", fillcolor="#319795", fontcolor="white",
                 label="Quote Ingestion\n[.NET Worker]\n:5003\n\nBBO/NBBO processing\nSpread calculation"];

      HIST_SVC [shape=box, style="rounded,filled", fillcolor="#319795", fontcolor="white",
                label="Historical Ingestion\n[.NET Worker]\n:5004\n\nBackfill coordination\nGap repair"];

      VAL_SVC [shape=box, style="rounded,filled", fillcolor="#319795", fontcolor="white",
               label="Data Validation\n[.NET Worker]\n:5005\n\nQuality checks\nAnomaly detection"];
    }

    // HTTP Monitoring Server
    HTTP [shape=box, style="rounded,filled", fillcolor="#ed8936", fontcolor="white",
          label="Status HTTP Server\n[HttpListener]\n\n/status - JSON metrics\n/metrics - Prometheus\n/health, /ready, /live"];
  }

  // Message Bus
  subgraph cluster_messaging {
    label="Message Bus";
    color="#ff6b6b";
    style="rounded";
    bgcolor="#fff5f5";

    RABBITMQ [shape=box, style="rounded,filled", fillcolor="#e53e3e", fontcolor="white",
              label="RabbitMQ / Azure Service Bus\n[Message Broker]\n\nMassTransit messaging\nTrade/Quote/Depth exchanges\nEvent distribution"];
  }

  // Storage
  subgraph cluster_storage {
    label="Storage Layer (Tiered)";
    color="#c53030";
    style="rounded";
    bgcolor="#fff5f5";

    WAL [shape=cylinder, style="filled", fillcolor="#fc8181", fontcolor="white",
         label="Write-Ahead Log\n[Durability]\n\nCrash-safe journaling\nSHA256 checksums\nTransaction semantics"];

    JSONL [shape=cylinder, style="filled", fillcolor="#feb2b2", fontcolor="black",
           label="JSONL Files\n[Hot Storage]\n\nReal-time append\nLZ4 compression\nDaily partitioning"];

    PARQUET [shape=cylinder, style="filled", fillcolor="#fecaca", fontcolor="black",
             label="Parquet Files\n[Archive Storage]\n\nColumnar format\nZSTD compression\n10-20x compression ratio"];

    CLOUD [shape=cylinder, style="filled", fillcolor="#feebc8", fontcolor="black",
           label="Cloud Storage\n[Cold Tier]\n\nS3, Azure Blob\nGlacier archive"];
  }

  // Monitoring
  subgraph cluster_monitoring {
    label="Observability";
    color="#38a169";
    style="dashed";
    bgcolor="#f0fff4";

    PROM [shape=box, style="rounded,filled", fillcolor="#38a169", fontcolor="white",
          label="Prometheus\n[Metrics]\n\nScrapes /metrics"];
    GRAFANA [shape=box, style="rounded,filled", fillcolor="#38a169", fontcolor="white",
             label="Grafana\n[Dashboards]\n\nVisualization"];
    JAEGER [shape=box, style="rounded,filled", fillcolor="#38a169", fontcolor="white",
            label="Jaeger/Tempo\n[Tracing]\n\nOpenTelemetry"];
  }

  // Relationships - Users
  Operator -> WPF [label="Configures"];
  Operator -> WEB_UI [label="Monitors"];
  Operator -> CLI [label="Operates"];
  Quant -> PARQUET [label="Analyzes\ndata"];

  // Relationships - Presentation to Core
  WPF -> CORE [label="HTTP/Status API"];
  WEB_UI -> HTTP [label="Status polling"];
  CLI -> CORE [label="In-process"];

  // Relationships - CLI to Onboarding
  CLI -> WIZARD [label="--wizard", style=dashed, color="#ed8936"];
  CLI -> AUTO_CONFIG [label="--auto-config", style=dashed, color="#ed8936"];
  CLI -> DIAGNOSTICS [label="--test-connectivity\n--validate-credentials", style=dashed, color="#ed8936"];
  WIZARD -> AUTO_CONFIG [style=dashed];
  AUTO_CONFIG -> CORE [label="Generates config", style=dashed, color="#ed8936"];
  DIAGNOSTICS -> CORE [label="Pre-flight checks", style=dashed, color="#ed8936"];
  ERROR_FMT -> CLI [label="Formats errors", style=dashed, color="#ed8936"];

  // Relationships - External to Core
  IB -> CORE [label="WebSocket\nL1/L2 streaming", color="#2b6cb0"];
  ALP -> CORE [label="WebSocket\nreal-time", color="#2b6cb0"];
  NYSE -> CORE [label="Exchange feed", color="#2b6cb0"];
  POL -> CORE [label="WebSocket\nstreaming", color="#2b6cb0"];
  SS -> CORE [label="Multi-exchange\nadapter", color="#2b6cb0"];
  HIST_PROVIDERS -> CORE [label="REST API\nbackfill", color="#2c7a7b"];

  // Relationships - Internal
  CORE -> FSHARP [label="Uses domain\ntypes"];
  CORE -> CONTRACTS [label="Uses"];
  CORE -> RABBITMQ [label="Publishes\nevents"];
  CORE -> HTTP [label="Exposes\nendpoints"];

  // Microservices relationships
  RABBITMQ -> GATEWAY [label="Consumes", style=dashed];
  GATEWAY -> TRADE_SVC [style=dashed];
  GATEWAY -> ORDERBOOK_SVC [style=dashed];
  GATEWAY -> QUOTE_SVC [style=dashed];
  GATEWAY -> HIST_SVC [style=dashed];
  GATEWAY -> VAL_SVC [style=dashed];
  TRADE_SVC -> CONTRACTS [style=dashed];
  QUOTE_SVC -> CONTRACTS [style=dashed];

  // Storage relationships
  CORE -> WAL [label="1. Journal", color="#c53030"];
  WAL -> JSONL [label="2. Persist", color="#c53030"];
  JSONL -> PARQUET [label="3. Archive", color="#c53030"];
  PARQUET -> CLOUD [label="4. Tier", style=dashed, color="#c53030"];

  // Monitoring relationships
  HTTP -> PROM [label="Scrapes"];
  PROM -> GRAFANA;
  CORE -> JAEGER [label="Traces", style=dashed];

  // Legend
  subgraph cluster_legend {
    label="Legend";
    style="rounded";
    color="#666666";
    bgcolor="#fafafa";

    L1 [shape=oval, style="filled", fillcolor="#08427b", fontcolor="white", label="Person"];
    L2 [shape=box, style="rounded,filled", fillcolor="#438dd5", fontcolor="white", label="Core Container"];
    L3 [shape=box, style="rounded,filled", fillcolor="#805ad5", fontcolor="white", label="UI Container"];
    L4 [shape=box, style="rounded,filled", fillcolor="#ed8936", fontcolor="white", label="Onboarding/UX"];
    L5 [shape=box, style="rounded,filled", fillcolor="#2c7a7b", fontcolor="white", label="Microservice"];
    L6 [shape=cylinder, style="filled", fillcolor="#fc8181", fontcolor="white", label="Storage"];
    L7 [shape=box, style="rounded,filled", fillcolor="#38a169", fontcolor="white", label="Monitoring"];
  }
}
