using MarketDataCollector.Wpf.Services;
using MarketDataCollector.Ui.Services;

namespace MarketDataCollector.Wpf.Tests.Services;

/// <summary>
/// Tests for <see cref="WorkspaceService"/> — workspace CRUD operations,
/// default workspaces, session management, and import/export.
/// </summary>
public sealed class WorkspaceServiceTests
{
    private static WorkspaceService CreateService() => WorkspaceService.Instance;

    // ── Singleton ────────────────────────────────────────────────────

    [Fact]
    public void Instance_ShouldReturnSingleton()
    {
        var a = WorkspaceService.Instance;
        var b = WorkspaceService.Instance;
        a.Should().BeSameAs(b);
    }

    // ── Default Workspaces ───────────────────────────────────────────

    [Fact]
    public void Workspaces_ShouldContainDefaults()
    {
        var svc = CreateService();
        svc.Workspaces.Should().NotBeEmpty();
        svc.Workspaces.Count.Should().BeGreaterOrEqualTo(4);
    }

    [Fact]
    public void DefaultWorkspaces_ShouldContainMonitoring()
    {
        var svc = CreateService();
        svc.Workspaces.Should().Contain(w => w.Name == "Monitoring");
    }

    [Fact]
    public void DefaultWorkspaces_ShouldContainBackfillOperations()
    {
        var svc = CreateService();
        svc.Workspaces.Should().Contain(w => w.Name == "Backfill Operations");
    }

    [Fact]
    public void DefaultWorkspaces_ShouldContainStorageAdmin()
    {
        var svc = CreateService();
        svc.Workspaces.Should().Contain(w => w.Name == "Storage Admin");
    }

    [Fact]
    public void DefaultWorkspaces_ShouldContainAnalysisExport()
    {
        var svc = CreateService();
        svc.Workspaces.Should().Contain(w => w.Name == "Analysis & Export");
    }

    [Fact]
    public void DefaultWorkspaces_ShouldBeBuiltIn()
    {
        var svc = CreateService();
        var builtIn = svc.Workspaces.Where(w => w.IsBuiltIn).ToList();
        builtIn.Should().HaveCountGreaterOrEqualTo(4);
    }

    [Fact]
    public void DefaultWorkspaces_ShouldHavePages()
    {
        var svc = CreateService();
        foreach (var workspace in svc.Workspaces.Where(w => w.IsBuiltIn))
        {
            workspace.Pages.Should().NotBeNullOrEmpty(
                $"Workspace '{workspace.Name}' should have pages");
        }
    }

    // ── CreateWorkspaceAsync ─────────────────────────────────────────

    [Fact]
    public async Task CreateWorkspaceAsync_ShouldAddWorkspace()
    {
        var svc = CreateService();
        var initialCount = svc.Workspaces.Count;
        var name = "TestWorkspace-" + Guid.NewGuid().ToString("N")[..8];

        var workspace = await svc.CreateWorkspaceAsync(
            name, "Test description", WorkspaceCategory.Custom);

        workspace.Should().NotBeNull();
        workspace.Name.Should().Be(name);
        workspace.Id.Should().NotBeNullOrEmpty();
        svc.Workspaces.Count.Should().BeGreaterThan(initialCount);

        // Clean up
        await svc.DeleteWorkspaceAsync(workspace.Id);
    }

    [Fact]
    public async Task CreateWorkspaceAsync_ShouldAssignUniqueId()
    {
        var svc = CreateService();

        var ws1 = await svc.CreateWorkspaceAsync("Test1-" + Guid.NewGuid(), "desc", WorkspaceCategory.Custom);
        var ws2 = await svc.CreateWorkspaceAsync("Test2-" + Guid.NewGuid(), "desc", WorkspaceCategory.Custom);

        ws1.Id.Should().NotBe(ws2.Id);

        // Clean up
        await svc.DeleteWorkspaceAsync(ws1.Id);
        await svc.DeleteWorkspaceAsync(ws2.Id);
    }

    [Fact]
    public async Task CreateWorkspaceAsync_ShouldRaiseEvent()
    {
        var svc = CreateService();
        WorkspaceEventArgs? receivedArgs = null;
        svc.WorkspaceCreated += (_, args) => receivedArgs = args;

        var workspace = await svc.CreateWorkspaceAsync(
            "EventTest-" + Guid.NewGuid(), "desc", WorkspaceCategory.Custom);

        receivedArgs.Should().NotBeNull();
        receivedArgs!.Workspace.Should().NotBeNull();
        receivedArgs.Workspace.Name.Should().Be(workspace.Name);

        // Clean up
        await svc.DeleteWorkspaceAsync(workspace.Id);
    }

    // ── DeleteWorkspaceAsync ─────────────────────────────────────────

    [Fact]
    public async Task DeleteWorkspaceAsync_ShouldRemoveWorkspace()
    {
        var svc = CreateService();
        var workspace = await svc.CreateWorkspaceAsync(
            "DeleteTest-" + Guid.NewGuid(), "desc", WorkspaceCategory.Custom);

        await svc.DeleteWorkspaceAsync(workspace.Id);

        svc.Workspaces.Should().NotContain(w => w.Id == workspace.Id);
    }

    [Fact]
    public async Task DeleteWorkspaceAsync_BuiltIn_ShouldNotDelete()
    {
        var svc = CreateService();
        var builtIn = svc.Workspaces.First(w => w.IsBuiltIn);
        var initialCount = svc.Workspaces.Count;

        await svc.DeleteWorkspaceAsync(builtIn.Id);

        svc.Workspaces.Count.Should().Be(initialCount);
    }

    [Fact]
    public async Task DeleteWorkspaceAsync_ShouldRaiseEvent()
    {
        var svc = CreateService();
        var workspace = await svc.CreateWorkspaceAsync(
            "DeleteEvt-" + Guid.NewGuid(), "desc", WorkspaceCategory.Custom);
        WorkspaceEventArgs? receivedArgs = null;
        svc.WorkspaceDeleted += (_, args) => receivedArgs = args;

        await svc.DeleteWorkspaceAsync(workspace.Id);

        receivedArgs.Should().NotBeNull();
    }

    // ── ActivateWorkspaceAsync ───────────────────────────────────────

    [Fact]
    public async Task ActivateWorkspaceAsync_ShouldSetActiveWorkspace()
    {
        var svc = CreateService();
        var workspace = svc.Workspaces.First();

        await svc.ActivateWorkspaceAsync(workspace.Id);

        svc.ActiveWorkspace.Should().NotBeNull();
        svc.ActiveWorkspace!.Id.Should().Be(workspace.Id);
    }

    [Fact]
    public async Task ActivateWorkspaceAsync_ShouldRaiseEvent()
    {
        var svc = CreateService();
        var workspace = svc.Workspaces.First();
        WorkspaceEventArgs? receivedArgs = null;
        svc.WorkspaceActivated += (_, args) => receivedArgs = args;

        await svc.ActivateWorkspaceAsync(workspace.Id);

        receivedArgs.Should().NotBeNull();
        receivedArgs!.Workspace.Id.Should().Be(workspace.Id);
    }

    // ── UpdateWorkspaceAsync ─────────────────────────────────────────

    [Fact]
    public async Task UpdateWorkspaceAsync_ShouldUpdateExisting()
    {
        var svc = CreateService();
        var workspace = await svc.CreateWorkspaceAsync(
            "UpdateTest-" + Guid.NewGuid(), "original", WorkspaceCategory.Custom);

        workspace.Description = "updated description";
        await svc.UpdateWorkspaceAsync(workspace);

        var updated = svc.Workspaces.First(w => w.Id == workspace.Id);
        updated.Description.Should().Be("updated description");

        // Clean up
        await svc.DeleteWorkspaceAsync(workspace.Id);
    }

    [Fact]
    public async Task UpdateWorkspaceAsync_ShouldRaiseEvent()
    {
        var svc = CreateService();
        var workspace = await svc.CreateWorkspaceAsync(
            "UpdateEvt-" + Guid.NewGuid(), "desc", WorkspaceCategory.Custom);
        WorkspaceEventArgs? receivedArgs = null;
        svc.WorkspaceUpdated += (_, args) => receivedArgs = args;

        workspace.Description = "new desc";
        await svc.UpdateWorkspaceAsync(workspace);

        receivedArgs.Should().NotBeNull();

        // Clean up
        await svc.DeleteWorkspaceAsync(workspace.Id);
    }

    // ── Session State ────────────────────────────────────────────────

    [Fact]
    public async Task SaveSessionStateAsync_ShouldPersistState()
    {
        var svc = CreateService();
        var state = new SessionState
        {
            OpenPages = new List<WorkspacePage>
            {
                new() { PageTag = "Dashboard", Title = "Dashboard" }
            },
            ActiveFilters = new Dictionary<string, string> { ["symbol"] = "SPY" }
        };

        await svc.SaveSessionStateAsync(state);

        var retrieved = svc.GetLastSessionState();
        retrieved.Should().NotBeNull();
        retrieved!.OpenPages.Should().NotBeEmpty();
        retrieved.SavedAt.Should().BeOnOrAfter(DateTime.UtcNow.AddSeconds(-5));
    }

    [Fact]
    public void GetLastSessionState_InitialState_MayBeNullOrPreviouslySaved()
    {
        var svc = CreateService();
        // LastSession may be null initially or restored from previous tests
        var act = () => svc.GetLastSessionState();
        act.Should().NotThrow();
    }

    [Fact]
    public async Task SaveSessionStateAsync_WithActivePageTag_ShouldRoundTripPage()
    {
        var svc = CreateService();

        // Act — save state with non-default page (mirrors MainWindow.SaveSessionState)
        var state = new SessionState
        {
            ActivePageTag = "Backfill",
            OpenPages = new List<WorkspacePage>
            {
                new() { PageTag = "Backfill", Title = "Backfill", IsDefault = true }
            },
            WindowBounds = new WindowBounds
            {
                X = 100, Y = 200, Width = 1200, Height = 800, IsMaximized = false
            },
            SavedAt = DateTime.UtcNow
        };
        await svc.SaveSessionStateAsync(state);

        // Act — retrieve (mirrors MainWindow.RestoreSessionState)
        var retrieved = svc.GetLastSessionState();

        // Assert
        retrieved.Should().NotBeNull();
        retrieved!.ActivePageTag.Should().Be("Backfill");
        retrieved.WindowBounds.Should().NotBeNull();
        retrieved.WindowBounds!.Width.Should().Be(1200);
    }

    [Fact]
    public async Task SaveSessionStateAsync_WithActiveWorkspaceId_ShouldRoundTrip()
    {
        var svc = CreateService();
        var firstWorkspace = svc.Workspaces.FirstOrDefault();
        firstWorkspace.Should().NotBeNull("There should be at least one default workspace");

        var state = new SessionState
        {
            ActivePageTag = "Dashboard",
            ActiveWorkspaceId = firstWorkspace!.Id,
            SavedAt = DateTime.UtcNow
        };
        await svc.SaveSessionStateAsync(state);

        var retrieved = svc.GetLastSessionState();
        retrieved.Should().NotBeNull();
        retrieved!.ActiveWorkspaceId.Should().Be(firstWorkspace.Id);
    }

    // ── CaptureCurrentStateAsync ─────────────────────────────────────

    [Fact]
    public async Task CaptureCurrentStateAsync_ShouldCreateWorkspace()
    {
        var svc = CreateService();
        var name = "CapturedState-" + Guid.NewGuid().ToString("N")[..8];

        var workspace = await svc.CaptureCurrentStateAsync(name, "Captured");

        workspace.Should().NotBeNull();
        workspace.Name.Should().Be(name);
        workspace.Category.Should().Be(WorkspaceCategory.Custom);

        // Clean up
        await svc.DeleteWorkspaceAsync(workspace.Id);
    }

    // ── Export/Import ────────────────────────────────────────────────

    [Fact]
    public async Task ExportWorkspaceAsync_ExistingWorkspace_ShouldReturnJson()
    {
        var svc = CreateService();
        var workspace = svc.Workspaces.First();

        var json = await svc.ExportWorkspaceAsync(workspace.Id);

        json.Should().NotBeNullOrEmpty();
        json.Should().Contain(workspace.Name);
    }

    [Fact]
    public async Task ExportWorkspaceAsync_NonExistentId_ShouldReturnEmpty()
    {
        var svc = CreateService();

        var json = await svc.ExportWorkspaceAsync("nonexistent-" + Guid.NewGuid());

        json.Should().BeEmpty();
    }

    [Fact]
    public async Task ImportWorkspaceAsync_ValidJson_ShouldCreateWorkspace()
    {
        var svc = CreateService();
        var json = """
        {
            "Id": "temp-id",
            "Name": "Imported Workspace",
            "Description": "From import",
            "Category": 0,
            "IsBuiltIn": true,
            "Pages": []
        }
        """;

        var imported = await svc.ImportWorkspaceAsync(json);

        imported.Should().NotBeNull();
        imported!.Name.Should().Be("Imported Workspace");
        imported.Id.Should().NotBe("temp-id"); // New ID assigned
        imported.IsBuiltIn.Should().BeFalse(); // Forced to false on import

        // Clean up
        await svc.DeleteWorkspaceAsync(imported.Id);
    }

    [Fact]
    public async Task ImportWorkspaceAsync_InvalidJson_ShouldReturnNull()
    {
        var svc = CreateService();

        var imported = await svc.ImportWorkspaceAsync("not valid json");

        imported.Should().BeNull();
    }

    // ── Data Model: WorkspaceTemplate ────────────────────────────────

    [Fact]
    public void WorkspaceTemplate_ShouldHaveDefaults()
    {
        var template = new WorkspaceTemplate();
        template.Id.Should().BeEmpty();
        template.Name.Should().BeEmpty();
        template.Description.Should().BeEmpty();
        template.IsBuiltIn.Should().BeFalse();
    }

    // ── Data Model: WorkspacePage ────────────────────────────────────

    [Fact]
    public void WorkspacePage_ShouldHaveDefaults()
    {
        var page = new WorkspacePage();
        page.PageTag.Should().BeEmpty();
        page.Title.Should().BeEmpty();
        page.IsDefault.Should().BeFalse();
    }

    // ── Data Model: WorkspaceCategory Enum ───────────────────────────

    [Theory]
    [InlineData(WorkspaceCategory.Monitoring)]
    [InlineData(WorkspaceCategory.Backfill)]
    [InlineData(WorkspaceCategory.Storage)]
    [InlineData(WorkspaceCategory.Analysis)]
    [InlineData(WorkspaceCategory.Custom)]
    public void WorkspaceCategory_AllValues_ShouldBeDefined(WorkspaceCategory category)
    {
        Enum.IsDefined(typeof(WorkspaceCategory), category).Should().BeTrue();
    }
}
