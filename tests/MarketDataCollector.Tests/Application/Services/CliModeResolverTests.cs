using FluentAssertions;
using MarketDataCollector.Application.Services;
using Xunit;

namespace MarketDataCollector.Tests;

public sealed class CliModeResolverTests
{
    [Fact]
    public void TranslateLegacyFlags_WithNoFlags_ShouldReturnNull()
    {
        // Arrange
        var args = Array.Empty<string>();

        // Act
        var result = CliModeResolver.TranslateLegacyFlags(args);

        // Assert
        result.Should().BeNull();
    }

    [Fact]
    public void TranslateLegacyFlags_WithExplicitMode_ShouldReturnMode()
    {
        // Arrange
        var args = new[] { "--mode", "web" };

        // Act
        var result = CliModeResolver.TranslateLegacyFlags(args);

        // Assert
        result.Should().Be("web");
    }

    [Theory]
    [InlineData("--ui")]
    [InlineData("--UI")]
    [InlineData("--Ui")]
    public void TranslateLegacyFlags_WithUiFlag_ShouldReturnWeb(string flag)
    {
        // Arrange
        var args = new[] { flag };

        // Act
        var result = CliModeResolver.TranslateLegacyFlags(args);

        // Assert
        result.Should().Be("web");
    }

    [Fact]
    public void TranslateLegacyFlags_ExplicitModeTakesPrecedence()
    {
        // Arrange
        var args = new[] { "--ui", "--mode", "desktop" };

        // Act
        var result = CliModeResolver.TranslateLegacyFlags(args);

        // Assert
        result.Should().Be("desktop");
    }

    [Fact]
    public void Resolve_WithNoArgs_ShouldReturnHeadless()
    {
        // Arrange
        var args = Array.Empty<string>();

        // Act
        var result = CliModeResolver.Resolve(args);

        // Assert
        result.Should().Be(CliModeResolver.RunMode.Headless);
    }

    [Theory]
    [InlineData("web", CliModeResolver.RunMode.Web)]
    [InlineData("WEB", CliModeResolver.RunMode.Web)]
    [InlineData("Web", CliModeResolver.RunMode.Web)]
    [InlineData("desktop", CliModeResolver.RunMode.Desktop)]
    [InlineData("DESKTOP", CliModeResolver.RunMode.Desktop)]
    [InlineData("headless", CliModeResolver.RunMode.Headless)]
    [InlineData("HEADLESS", CliModeResolver.RunMode.Headless)]
    public void Resolve_WithExplicitMode_ShouldReturnCorrectMode(string modeArg, CliModeResolver.RunMode expected)
    {
        // Arrange
        var args = new[] { "--mode", modeArg };

        // Act
        var result = CliModeResolver.Resolve(args);

        // Assert
        result.Should().Be(expected);
    }

    [Fact]
    public void Resolve_WithLegacyUiFlag_ShouldReturnWeb()
    {
        // Arrange
        var args = new[] { "--ui" };

        // Act
        var result = CliModeResolver.Resolve(args);

        // Assert
        result.Should().Be(CliModeResolver.RunMode.Web);
    }

    [Fact]
    public void ResolveWithError_WithValidMode_ShouldHaveNoError()
    {
        // Arrange
        var args = new[] { "--mode", "web" };

        // Act
        var (mode, error) = CliModeResolver.ResolveWithError(args);

        // Assert
        mode.Should().Be(CliModeResolver.RunMode.Web);
        error.Should().BeNull();
    }

    [Fact]
    public void ResolveWithError_WithUnknownMode_ShouldReturnError()
    {
        // Arrange
        var args = new[] { "--mode", "unknown" };

        // Act
        var (mode, error) = CliModeResolver.ResolveWithError(args);

        // Assert
        mode.Should().Be(CliModeResolver.RunMode.Headless); // Default fallback
        error.Should().NotBeNullOrEmpty();
        error.Should().Contain("unknown");
        error.Should().Contain("web");
        error.Should().Contain("desktop");
        error.Should().Contain("headless");
    }

    [Fact]
    public void HasFlag_WithPresentFlag_ShouldReturnTrue()
    {
        // Arrange
        var args = new[] { "--foo", "--bar", "value" };

        // Act
        var result = CliModeResolver.HasFlag(args, "--foo");

        // Assert
        result.Should().BeTrue();
    }

    [Fact]
    public void HasFlag_WithMissingFlag_ShouldReturnFalse()
    {
        // Arrange
        var args = new[] { "--foo", "--bar", "value" };

        // Act
        var result = CliModeResolver.HasFlag(args, "--baz");

        // Assert
        result.Should().BeFalse();
    }

    [Theory]
    [InlineData("--Flag")]
    [InlineData("--FLAG")]
    [InlineData("--flag")]
    public void HasFlag_IsCaseInsensitive(string flagVariant)
    {
        // Arrange
        var args = new[] { "--flag" };

        // Act
        var result = CliModeResolver.HasFlag(args, flagVariant);

        // Assert
        result.Should().BeTrue();
    }

    [Fact]
    public void GetArgValue_WithExistingKey_ShouldReturnValue()
    {
        // Arrange
        var args = new[] { "--key", "value", "--other", "stuff" };

        // Act
        var result = CliModeResolver.GetArgValue(args, "--key");

        // Assert
        result.Should().Be("value");
    }

    [Fact]
    public void GetArgValue_WithMissingKey_ShouldReturnNull()
    {
        // Arrange
        var args = new[] { "--key", "value" };

        // Act
        var result = CliModeResolver.GetArgValue(args, "--missing");

        // Assert
        result.Should().BeNull();
    }

    [Fact]
    public void GetArgValue_WithKeyAtEnd_ShouldReturnNull()
    {
        // Arrange - key is last element, no value follows
        var args = new[] { "--key" };

        // Act
        var result = CliModeResolver.GetArgValue(args, "--key");

        // Assert
        result.Should().BeNull();
    }

    [Fact]
    public void GetArgValue_IsCaseInsensitive()
    {
        // Arrange
        var args = new[] { "--KEY", "value" };

        // Act
        var result = CliModeResolver.GetArgValue(args, "--key");

        // Assert
        result.Should().Be("value");
    }

    [Fact]
    public void LegacyFlagTranslation_MultipleFlags_WorksTogether()
    {
        // Arrange - mixed legacy and new flags
        var args = new[] { "--ui", "--http-port", "9000", "--watch-config" };

        // Act
        var mode = CliModeResolver.Resolve(args);
        var port = CliModeResolver.GetArgValue(args, "--http-port");
        var hasWatch = CliModeResolver.HasFlag(args, "--watch-config");

        // Assert
        mode.Should().Be(CliModeResolver.RunMode.Web);
        port.Should().Be("9000");
        hasWatch.Should().BeTrue();
    }
}
