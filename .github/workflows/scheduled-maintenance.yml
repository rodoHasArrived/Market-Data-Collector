# Scheduled Maintenance Workflow
# Runs periodic maintenance tasks including full test suite, dependency checks, and health reports

name: Scheduled Maintenance

on:
  schedule:
    # Run weekly on Sunday at 2:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full test suite'
        required: false
        default: 'true'
        type: boolean
      run_dependency_check:
        description: 'Run dependency health check'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.run_full_tests == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj', 'Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Build
        run: |
          dotnet build MarketDataCollector.sln \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true

      - name: Run all unit tests
        run: |
          dotnet test tests/MarketDataCollector.Tests/MarketDataCollector.Tests.csproj \
            -c Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger "trx;LogFileName=weekly-test-results.trx"

      - name: Run F# tests
        run: |
          dotnet test tests/MarketDataCollector.FSharp.Tests/MarketDataCollector.FSharp.Tests.fsproj \
            -c Release \
            --no-build \
            --verbosity normal \
            --results-directory ./TestResults \
            /p:EnableWindowsTargeting=true
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-test-results
          path: ./TestResults/
          retention-days: 14

      - name: Generate test summary
        if: always()
        run: |
          echo "## Weekly Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  dependency-health:
    name: Dependency Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.run_dependency_check == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj', 'Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Check for outdated packages
        run: |
          echo "## Dependency Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          dotnet list MarketDataCollector.sln package --outdated 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for deprecated packages
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deprecated Packages" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          dotnet list MarketDataCollector.sln package --deprecated 2>&1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for vulnerable packages
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vulnerable Packages" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          dotnet list MarketDataCollector.sln package --vulnerable --include-transitive 2>&1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  maintenance-summary:
    name: Maintenance Summary
    runs-on: ubuntu-latest
    needs: [full-test-suite, dependency-health]
    if: always()

    steps:
      - name: Generate maintenance report
        run: |
          echo "# Weekly Maintenance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Full Test Suite | ${{ needs.full-test-suite.result == 'success' && 'Passed' || needs.full-test-suite.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Health | ${{ needs.dependency-health.result == 'success' && 'Passed' || needs.dependency-health.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
