# GitHub Action: TODO Automation and Documentation
# This workflow scans the codebase for TODO/FIXME/HACK/NOTE comments,
# generates documentation, and optionally creates GitHub issues for tracking.
#
# Triggers:
#   - Push to main (src/** or tests/**)
#   - Weekly schedule (Monday 4 AM UTC)
#   - Manual dispatch with options
#
# Features:
#   - Scans source files for TODO markers
#   - Generates docs/status/TODO.md with all tracked items
#   - Links existing GitHub issues to TODO comments
#   - Can create issues for untracked TODOs (manual trigger only)
#   - Categorizes by priority, type, and file location

name: TODO Automation

on:
  push:
    branches: ["main"]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'benchmarks/**'
      - 'build/**/*.py'
  schedule:
    # Run weekly on Monday at 4 AM UTC
    - cron: '0 4 * * 1'
  workflow_dispatch:
    inputs:
      create_issues:
        description: 'Create GitHub issues for untracked TODOs'
        type: boolean
        default: false
        required: false
      dry_run:
        description: 'Dry run - generate report without committing'
        type: boolean
        default: false
        required: false
      include_notes:
        description: 'Include NOTE comments in documentation'
        type: boolean
        default: true
        required: false
      use_copilot:
        description: 'Use Copilot/AI to generate TODO triage recommendations'
        type: boolean
        default: true
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  models: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  scan-todos:
    name: Scan and Document TODOs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      total_count: ${{ steps.scan.outputs.total_count }}
      new_todos: ${{ steps.scan.outputs.new_todos }}
      has_changes: ${{ steps.check-changes.outputs.has_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Scan codebase for TODOs
        id: scan
        run: |
          python3 build/scripts/docs/scan-todos.py \
            --output docs/status/TODO.md \
            --format markdown \
            --include-notes ${{ github.event.inputs.include_notes || 'true' }} \
            --json-output todo-scan-results.json

          # Extract metrics for workflow outputs
          if [ -f todo-scan-results.json ]; then
            TOTAL=$(python3 -c "import json; data=json.load(open('todo-scan-results.json')); print(data.get('total_count', 0))")
            NEW=$(python3 -c "import json; data=json.load(open('todo-scan-results.json')); print(len([t for t in data.get('todos', []) if not t.get('has_issue', False)]))")
            SCAN_JSON=$(python3 -c "import json; data=json.load(open('todo-scan-results.json')); print(json.dumps(data, separators=(',', ':')))")
            echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
            echo "new_todos=$NEW" >> $GITHUB_OUTPUT
            echo "scan_json=$SCAN_JSON" >> $GITHUB_OUTPUT
          else
            echo "total_count=0" >> $GITHUB_OUTPUT
            echo "new_todos=0" >> $GITHUB_OUTPUT
            echo 'scan_json={"total_count":0,"todos":[]}' >> $GITHUB_OUTPUT
          fi


      - name: Generate Copilot triage recommendations
        id: copilot
        if: github.event.inputs.use_copilot != 'false'
        continue-on-error: true
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4.1-mini
          max-tokens: 1800
          prompt: |
            You are an engineering assistant helping triage TODO comments in a repository.
            Produce a concise markdown report with these sections:
            1) Highest-priority TODOs (max 5)
            2) Recommended issue labels
            3) Immediate risk items
            4) Suggested batching plan

            Keep the output under 300 words.
            Use this scan JSON:
            ${{ steps.scan.outputs.scan_json }}

      - name: Build fallback triage report
        if: always()
        run: |
          set -euo pipefail

          python3 << 'EOF'
          import json
          from pathlib import Path

          scan_path = Path('todo-scan-results.json')
          report_path = Path('todo-triage.md')

          if not scan_path.exists():
              report_path.write_text('# TODO Triage\n\nNo scan results were found.\n', encoding='utf-8')
              raise SystemExit(0)

          data = json.loads(scan_path.read_text(encoding='utf-8'))
          todos = data.get('todos', [])
          untracked = [t for t in todos if not t.get('has_issue', False)]

          lines = [
              '# TODO Triage Recommendations',
              '',
              '_Generated by TODO Automation workflow. Copilot output is appended when available; otherwise this deterministic fallback is produced._',
              '',
              f"- Total TODOs: **{data.get('total_count', 0)}**",
              f"- Untracked TODOs: **{len(untracked)}**",
              '',
              '## Highest-priority TODOs (fallback)',
              ''
          ]

          for i, todo in enumerate(untracked[:5], 1):
              todo_type = todo.get('type', 'TODO')
              text = todo.get('text', 'No description')
              file_path = todo.get('file', 'unknown')
              line = todo.get('line', 0)
              lines.append(f"{i}. **[{todo_type}]** `{file_path}:{line}` â€” {text}")

          if not untracked:
              lines.append('- No untracked TODO items found.')

          lines.extend([
              '',
              '## Suggested labels',
              '',
              '- `todo-automation` for all imported TODO items',
              '- `bug` for FIXME items',
              '- `tech-debt` for HACK items',
              '',
              '## Suggested batching plan',
              '',
              '1. Resolve untracked FIXME items first.',
              '2. Group TODO/HACK items by directory owner.',
              '3. Convert remaining high-value TODOs into tracked issues.'
          ])

          report_path.write_text('\n'.join(lines) + '\n', encoding='utf-8')
          EOF

      - name: Append Copilot triage output to report
        if: always() && steps.copilot.outputs.response != ''
        run: |
          {
            echo ""
            echo "## Copilot Recommendations"
            echo ""
            echo "${{ steps.copilot.outputs.response }}"
          } >> todo-triage.md
      - name: Check for changes
        id: check-changes
        run: |
          git add docs/status/TODO.md
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to TODO documentation"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in TODO documentation"
          fi

      - name: Generate summary
        run: |
          echo "## TODO Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f todo-scan-results.json ]; then
            python3 << 'EOF'
          import json
          import os

          with open('todo-scan-results.json', 'r') as f:
              data = json.load(f)

          summary = []
          summary.append(f"**Total TODOs:** {data.get('total_count', 0)}")
          summary.append(f"**Linked to Issues:** {len([t for t in data.get('todos', []) if t.get('has_issue', False)])}")
          summary.append(f"**Untracked:** {len([t for t in data.get('todos', []) if not t.get('has_issue', False)])}")
          summary.append("")

          # By type
          by_type = {}
          for todo in data.get('todos', []):
              t = todo.get('type', 'TODO')
              by_type[t] = by_type.get(t, 0) + 1

          if by_type:
              summary.append("### By Type")
              summary.append("| Type | Count |")
              summary.append("|------|-------|")
              for t, count in sorted(by_type.items()):
                  summary.append(f"| {t} | {count} |")
              summary.append("")

          # By directory
          by_dir = {}
          for todo in data.get('todos', []):
              path = todo.get('file', '')
              parts = path.split('/')
              if len(parts) > 1:
                  dir_name = parts[0] if parts[0] != '.' else parts[1] if len(parts) > 1 else 'root'
              else:
                  dir_name = 'root'
              by_dir[dir_name] = by_dir.get(dir_name, 0) + 1

          if by_dir:
              summary.append("### By Directory")
              summary.append("| Directory | Count |")
              summary.append("|-----------|-------|")
              for d, count in sorted(by_dir.items(), key=lambda x: -x[1]):
                  summary.append(f"| `{d}/` | {count} |")

          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write('\n'.join(summary))
          EOF
          else
            echo "No TODO scan results found." >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f todo-triage.md ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Triage Recommendations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat todo-triage.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: todo-scan-results
          path: |
            todo-scan-results.json
            docs/status/TODO.md
            todo-triage.md
          retention-days: 30

      - name: Commit changes
        if: |
          steps.check-changes.outputs.has_changes == 'true' &&
          github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/status/TODO.md
          git commit -m "docs: update TODO documentation [skip ci]

          Auto-generated TODO tracking documentation.

          - Total TODOs: ${{ steps.scan.outputs.total_count }}
          - Untracked: ${{ steps.scan.outputs.new_todos }}

          Generated by TODO Automation workflow."

          git push

  create-issues:
    name: Create Issues for Untracked TODOs
    needs: scan-todos
    if: |
      github.event.inputs.create_issues == 'true' &&
      needs.scan-todos.outputs.new_todos > 0
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download scan results
        uses: actions/download-artifact@v4
        with:
          name: todo-scan-results

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create issues for untracked TODOs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import json
          import subprocess
          import os

          with open('todo-scan-results.json', 'r') as f:
              data = json.load(f)

          created_count = 0
          max_issues = 5  # Limit to prevent spam

          for todo in data.get('todos', []):
              if created_count >= max_issues:
                  print(f"Reached maximum issue limit ({max_issues})")
                  break

              if todo.get('has_issue', False):
                  continue

              todo_type = todo.get('type', 'TODO')
              file_path = todo.get('file', 'unknown')
              line = todo.get('line', 0)
              text = todo.get('text', 'No description')

              # Determine labels
              labels = ['todo-automation']
              if todo_type == 'FIXME':
                  labels.append('bug')
              elif todo_type == 'HACK':
                  labels.append('tech-debt')

              title = f"[{todo_type}] {text[:60]}{'...' if len(text) > 60 else ''}"

              body = f"""## TODO Item

          **Type:** {todo_type}
          **File:** `{file_path}`
          **Line:** {line}

          ### Description

          {text}

          ### Context

          ```
          {todo.get('context', 'No context available')}
          ```

          ---
          *This issue was automatically created by the TODO Automation workflow.*
          """

              try:
                  result = subprocess.run([
                      'gh', 'issue', 'create',
                      '--title', title,
                      '--body', body,
                      '--label', ','.join(labels)
                  ], capture_output=True, text=True, check=True)

                  print(f"Created issue: {result.stdout.strip()}")
                  created_count += 1
              except subprocess.CalledProcessError as e:
                  print(f"Failed to create issue: {e.stderr}")

          print(f"\nCreated {created_count} issues")

          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write(f"\n\n## Issues Created\n\nCreated **{created_count}** new issues for untracked TODOs.\n")
          EOF

  notify:
    name: Send Notification
    needs: [scan-todos, create-issues]
    if: always() && needs.scan-todos.outputs.total_count > 0
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Summary notification
        run: |
          echo "## TODO Automation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Status:** ${{ needs.scan-todos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total TODOs:** ${{ needs.scan-todos.outputs.total_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Untracked:** ${{ needs.scan-todos.outputs.new_todos }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation Updated:** ${{ needs.scan-todos.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.create_issues }}" == "true" ]; then
            echo "- **Issue Creation:** ${{ needs.create-issues.result }}" >> $GITHUB_STEP_SUMMARY
          fi
