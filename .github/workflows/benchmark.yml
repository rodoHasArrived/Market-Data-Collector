# Performance Benchmark Workflow
# Runs benchmarks and tracks performance over time

name: Benchmarks

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'benchmarks/**'
      - '**/*.csproj'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'benchmarks/**'
      - '**/*.csproj'
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      baseline_ref:
        description: 'Git ref to compare against (branch/tag/commit)'
        required: false
        default: 'main'

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore /p:EnableWindowsTargeting=true

      - name: Build benchmark project
        run: dotnet build benchmarks/MarketDataCollector.Benchmarks -c Release --no-restore

      - name: Run benchmarks
        run: |
          mkdir -p benchmark-results

          dotnet run \
            --project benchmarks/MarketDataCollector.Benchmarks \
            -c Release \
            --no-build \
            -- \
            --exporters json markdown html \
            --artifacts benchmark-results \
            --filter '*' \
            --job short

      - name: Generate benchmark summary
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find and include markdown results
          if [ -f "benchmark-results/results/MarketDataCollector.Benchmarks-report.md" ]; then
            cat benchmark-results/results/MarketDataCollector.Benchmarks-report.md >> $GITHUB_STEP_SUMMARY
          else
            # Try to find any markdown report
            REPORT=$(find benchmark-results -name "*.md" -type f | head -1)
            if [ -n "$REPORT" ]; then
              cat "$REPORT" >> $GITHUB_STEP_SUMMARY
            else
              echo "No benchmark report found" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: benchmark-results/
          retention-days: 90

      - name: Store benchmark result for tracking
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: benchmark-results/
          key: benchmark-${{ github.sha }}

  compare-benchmarks:
    name: Compare Against Baseline
    runs-on: ubuntu-latest
    needs: benchmark
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download current benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: current-results

      - name: Try to restore baseline benchmarks
        id: restore-baseline
        uses: actions/cache/restore@v4
        with:
          path: baseline-results/
          key: benchmark-${{ github.event.pull_request.base.sha }}
          restore-keys: |
            benchmark-

      - name: Compare benchmarks
        if: steps.restore-baseline.outputs.cache-hit == 'true'
        run: |
          echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Comparing against baseline: ${{ github.event.pull_request.base.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Simple comparison script
          if [ -f "baseline-results/results/MarketDataCollector.Benchmarks-report.json" ] && \
             [ -f "current-results/results/MarketDataCollector.Benchmarks-report.json" ]; then
            echo "### Performance Changes" >> $GITHUB_STEP_SUMMARY
            echo "Benchmark comparison is available in the artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "Baseline results not available for comparison." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = '## ðŸ“Š Benchmark Results\n\n';
            report += `**Commit:** \`${{ github.sha }}\`\n\n`;

            // Try to read the markdown report
            try {
              const files = fs.readdirSync('current-results/results');
              const mdFile = files.find(f => f.endsWith('-report.md'));
              if (mdFile) {
                const content = fs.readFileSync(`current-results/results/${mdFile}`, 'utf8');
                // Truncate if too long
                report += content.length > 60000 ? content.substring(0, 60000) + '\n\n*Report truncated*' : content;
              } else {
                report += 'No detailed benchmark report available.';
              }
            } catch (e) {
              report += `Could not read benchmark results: ${e.message}`;
            }

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('ðŸ“Š Benchmark Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

  memory-profile:
    name: Memory Profiling
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore /p:EnableWindowsTargeting=true

      - name: Build with memory diagnostics
        run: |
          dotnet build benchmarks/MarketDataCollector.Benchmarks \
            -c Release \
            /p:EnableWindowsTargeting=true \
            --no-restore

      - name: Run memory benchmarks
        run: |
          mkdir -p memory-results

          dotnet run \
            --project benchmarks/MarketDataCollector.Benchmarks \
            -c Release \
            --no-build \
            -- \
            --filter '*Memory*' \
            --memory \
            --exporters json \
            --artifacts memory-results \
            --job dry || echo "No memory-specific benchmarks found"

      - name: Generate memory report
        run: |
          echo "## Memory Profile" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "memory-results/results" ]; then
            for file in memory-results/results/*.json; do
              if [ -f "$file" ]; then
                echo "Memory benchmark results available in artifacts" >> $GITHUB_STEP_SUMMARY
                break
              fi
            done
          else
            echo "No memory benchmarks executed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload memory results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: memory-profile-${{ github.sha }}
          path: memory-results/
          retention-days: 30
