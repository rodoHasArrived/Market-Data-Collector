name: Cache Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Cache action to perform'
        required: true
        default: 'list'
        type: choice
        options:
          - list
          - clean-old
          - clean-all
  schedule:
    # Clean old caches every Sunday at 10:30 AM UTC (distributed from maintenance at 8 AM)
    - cron: '30 10 * * 0'

jobs:
  manage-cache:
    name: Manage GitHub Actions Cache
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: List caches
      if: github.event.inputs.action == 'list' || github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const caches = await github.rest.actions.getActionsCacheList({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          console.log(`Total caches: ${caches.data.total_count}`);
          console.log('Cache list:');
          caches.data.actions_caches.forEach(cache => {
            console.log(`- ${cache.key} (${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB, last accessed: ${cache.last_accessed_at})`);
          });

    - name: Clean old caches
      if: github.event.inputs.action == 'clean-old' || github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const caches = await github.rest.actions.getActionsCacheList({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          let deletedCount = 0;
          for (const cache of caches.data.actions_caches) {
            const lastAccessed = new Date(cache.last_accessed_at);
            if (lastAccessed < thirtyDaysAgo) {
              console.log(`Deleting old cache: ${cache.key}`);
              await github.rest.actions.deleteActionsCacheById({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id,
              });
              deletedCount++;
            }
          }
          console.log(`Deleted ${deletedCount} old caches`);

    - name: Clean all caches
      if: github.event.inputs.action == 'clean-all'
      uses: actions/github-script@v7
      with:
        script: |
          const caches = await github.rest.actions.getActionsCacheList({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          for (const cache of caches.data.actions_caches) {
            console.log(`Deleting cache: ${cache.key}`);
            await github.rest.actions.deleteActionsCacheById({
              owner: context.repo.owner,
              repo: context.repo.repo,
              cache_id: cache.id,
            });
          }
          console.log(`Deleted all ${caches.data.total_count} caches`);
