# Configurable Ticker Data Collection Workflow
# Fetches historical data from Yahoo Finance for user-specified ticker symbols
# and uploads the results as a downloadable artifact.
#
# Usage: Run manually from Actions tab, specify comma-separated ticker symbols.

name: Ticker Data Collection

run-name: >-
  Ticker Collection (${{ github.event.inputs.symbols || 'SPY,AAPL' }})

on:
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated ticker symbols (e.g., SPY,AAPL,MSFT)'
        required: true
        default: 'SPY,AAPL'
        type: string
      date_from:
        description: 'Start date (YYYY-MM-DD) or leave empty for all history'
        required: false
        default: ''
        type: string
      date_to:
        description: 'End date (YYYY-MM-DD) or leave empty for latest'
        required: false
        default: ''
        type: string
      retention_days:
        description: 'Artifact retention (days)'
        required: false
        default: '30'
        type: choice
        options:
          - '7'
          - '14'
          - '30'
          - '90'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  collect-data:
    name: Fetch Yahoo Finance Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache-suffix: ticker-data

      - name: Validate and normalize workflow inputs
        id: normalize-inputs
        run: |
          set -euo pipefail

          symbols_input='${{ github.event.inputs.symbols }}'
          date_from='${{ github.event.inputs.date_from }}'
          date_to='${{ github.event.inputs.date_to }}'

          # Normalize symbols: uppercase, trim, dedupe, and keep comma-separated format.
          normalized_symbols=$(printf '%s' "$symbols_input" \
            | tr ',' '\n' \
            | sed 's/^\s*//;s/\s*$//' \
            | awk 'NF { print toupper($0) }' \
            | awk '!seen[$0]++' \
            | paste -sd, -)

          if [ -z "$normalized_symbols" ]; then
            echo "Input validation failed: symbols list is empty after normalization."
            exit 1
          fi

          if printf '%s' "$normalized_symbols" | tr ',' '\n' | grep -qEv '^[A-Z0-9.\-^=]+$'; then
            echo "Input validation failed: one or more symbols contain unsupported characters."
            echo "Allowed pattern per symbol: [A-Z0-9.\-^=]+"
            exit 1
          fi

          validate_date() {
            local label=$1
            local value=$2
            if [ -n "$value" ] && ! date -d "$value" '+%Y-%m-%d' >/dev/null 2>&1; then
              echo "Input validation failed: $label must be YYYY-MM-DD (received '$value')."
              exit 1
            fi
          }

          validate_date "date_from" "$date_from"
          validate_date "date_to" "$date_to"

          if [ -n "$date_from" ] && [ -n "$date_to" ]; then
            if [ "$(date -d "$date_from" '+%s')" -gt "$(date -d "$date_to" '+%s')" ]; then
              echo "Input validation failed: date_from must be less than or equal to date_to."
              exit 1
            fi
          fi

          echo "normalized_symbols=$normalized_symbols" >> "$GITHUB_OUTPUT"
          echo "validated_date_from=$date_from" >> "$GITHUB_OUTPUT"
          echo "validated_date_to=$date_to" >> "$GITHUB_OUTPUT"

          echo "Normalized symbols: $normalized_symbols"
          echo "date_from: ${date_from:-<empty>}"
          echo "date_to: ${date_to:-<empty>}"

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Build
        run: |
          dotnet build MarketDataCollector.sln \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true

      - name: Fetch ticker data
        env:
          YAHOO_TICKER_SYMBOLS: ${{ steps.normalize-inputs.outputs.normalized_symbols }}
          YAHOO_TICKER_DATE_FROM: ${{ steps.normalize-inputs.outputs.validated_date_from }}
          YAHOO_TICKER_DATE_TO: ${{ steps.normalize-inputs.outputs.validated_date_to }}
        run: |
          echo "Fetching data for symbols: $YAHOO_TICKER_SYMBOLS"
          echo ""

          dotnet test tests/MarketDataCollector.Tests/MarketDataCollector.Tests.csproj \
            -c Release \
            --no-build \
            --verbosity normal \
            --filter "Category=TickerArtifact" \
            --logger "trx;LogFileName=ticker-data-results.trx" \
            --results-directory ./TestResults

      - name: Locate artifact output
        if: always()
        id: find-output
        run: |
          # The test writes to ArtifactOutput relative to the test binary output dir
          OUTPUT_DIR=$(find . -type d -name "ArtifactOutput" 2>/dev/null | head -1)

          if [ -n "$OUTPUT_DIR" ]; then
            echo "output_dir=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"
            echo "Found output directory: $OUTPUT_DIR"
            echo ""
            echo "Files collected:"
            ls -lh "$OUTPUT_DIR"
            echo ""
            if [ -f "$OUTPUT_DIR/collection_summary.txt" ]; then
              echo "--- Collection Summary ---"
              cat "$OUTPUT_DIR/collection_summary.txt"
            fi
          else
            echo "No ArtifactOutput directory found"
            echo "output_dir=" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload ticker data artifact
        if: always() && steps.find-output.outputs.output_dir != ''
        uses: actions/upload-artifact@v4
        with:
          name: ticker-data-${{ github.run_number }}-${{ github.sha }}
          path: ${{ steps.find-output.outputs.output_dir }}/
          retention-days: ${{ github.event.inputs.retention_days || '30' }}
          if-no-files-found: error

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ticker-test-results-${{ github.run_number }}
          path: ./TestResults/
          retention-days: 7
          if-no-files-found: warn

      - name: Generate job summary
        if: always()
        run: |
          echo "## Ticker Data Collection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Symbols:** \`${{ steps.normalize-inputs.outputs.normalized_symbols }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date range:** \`${{ steps.normalize-inputs.outputs.validated_date_from || 'all history' }} → ${{ steps.normalize-inputs.outputs.validated_date_to || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }} | **Commit:** \`${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          OUTPUT_DIR="${{ steps.find-output.outputs.output_dir }}"
          if [ -n "$OUTPUT_DIR" ] && [ -f "$OUTPUT_DIR/collection_summary.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "$OUTPUT_DIR/collection_summary.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> No collection summary available." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **ticker-data-${{ github.run_number }}-${GITHUB_SHA}** — JSON files with historical bar data" >> $GITHUB_STEP_SUMMARY
          echo "- **ticker-test-results-${{ github.run_number }}** — Test result (.trx) file" >> $GITHUB_STEP_SUMMARY
