# Configurable Ticker Data Collection Workflow
# Fetches historical data from Yahoo Finance for user-specified ticker symbols
# and uploads the results as a downloadable artifact.
#
# Usage: Run manually from Actions tab, specify comma-separated ticker symbols.

name: Ticker Data Collection

on:
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated ticker symbols (e.g., SPY,AAPL,MSFT)'
        required: true
        default: 'SPY,AAPL'
        type: string
      date_from:
        description: 'Start date (YYYY-MM-DD) or leave empty for all history'
        required: false
        default: ''
        type: string
      date_to:
        description: 'End date (YYYY-MM-DD) or leave empty for latest'
        required: false
        default: ''
        type: string
      retention_days:
        description: 'Artifact retention (days)'
        required: false
        default: '30'
        type: choice
        options:
          - '7'
          - '14'
          - '30'
          - '90'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  collect-data:
    name: Fetch Yahoo Finance Data
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache-suffix: ticker-data

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Build
        shell: bash
        run: |
          dotnet build MarketDataCollector.sln \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true

      - name: Fetch ticker data
        shell: bash
        env:
          YAHOO_TICKER_SYMBOLS: ${{ github.event.inputs.symbols }}
        run: |
          echo "Fetching data for symbols: $YAHOO_TICKER_SYMBOLS"
          echo ""

          dotnet test tests/MarketDataCollector.Tests/MarketDataCollector.Tests.csproj \
            -c Release \
            --no-build \
            --verbosity normal \
            --filter "Category=TickerArtifact" \
            --logger "trx;LogFileName=ticker-data-results.trx" \
            --results-directory ./TestResults

      - name: Locate artifact output
        if: always()
        id: find-output
        shell: bash
        run: |
          # The test writes to ArtifactOutput relative to the test binary output dir
          OUTPUT_DIR=$(find . -type d -name "ArtifactOutput" 2>/dev/null | head -1)

          if [ -n "$OUTPUT_DIR" ]; then
            echo "output_dir=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"
            echo "Found output directory: $OUTPUT_DIR"
            echo ""
            echo "Files collected:"
            ls -lh "$OUTPUT_DIR"
            echo ""
            if [ -f "$OUTPUT_DIR/collection_summary.txt" ]; then
              echo "--- Collection Summary ---"
              cat "$OUTPUT_DIR/collection_summary.txt"
            fi
          else
            echo "No ArtifactOutput directory found"
            echo "output_dir=" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload ticker data artifact
        if: always() && steps.find-output.outputs.output_dir != ''
        uses: actions/upload-artifact@v4
        with:
          name: ticker-data-${{ github.run_number }}-${{ github.sha }}
          path: ${{ steps.find-output.outputs.output_dir }}/
          retention-days: ${{ github.event.inputs.retention_days || '30' }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ticker-test-results-${{ github.run_number }}
          path: ./TestResults/
          retention-days: 7

      - name: Generate job summary
        if: always()
        shell: bash
        run: |
          echo "## Ticker Data Collection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Symbols:** \`${{ github.event.inputs.symbols }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }} | **Commit:** \`${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          OUTPUT_DIR="${{ steps.find-output.outputs.output_dir }}"
          if [ -n "$OUTPUT_DIR" ] && [ -f "$OUTPUT_DIR/collection_summary.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "$OUTPUT_DIR/collection_summary.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> No collection summary available." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **ticker-data-${{ github.run_number }}-${GITHUB_SHA}** — JSON files with historical bar data" >> $GITHUB_STEP_SUMMARY
          echo "- **ticker-test-results-${{ github.run_number }}** — Test result (.trx) file" >> $GITHUB_STEP_SUMMARY
