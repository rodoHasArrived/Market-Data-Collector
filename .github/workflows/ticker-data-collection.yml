# Configurable Ticker Data Collection Workflow
# Fetches historical data from Yahoo Finance for user-specified ticker symbols
# and uploads the results as a downloadable artifact.
#
# Usage: Run manually from Actions tab, specify comma-separated ticker symbols.

name: Ticker Data Collection

run-name: >-
  Ticker Collection (${{ github.event.inputs.symbols || 'SPY,AAPL' }})

on:
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated ticker symbols (e.g., SPY,AAPL,PCG-PA,BRK.B)'
        required: true
        default: 'SPY,AAPL'
        type: string
      date_from:
        description: 'Start date (YYYY-MM-DD) or leave empty for all history'
        required: false
        default: ''
        type: string
      date_to:
        description: 'End date (YYYY-MM-DD) or leave empty for latest'
        required: false
        default: ''
        type: string
      retention_days:
        description: 'Artifact retention (days)'
        required: false
        default: '30'
        type: choice
        options:
          - '7'
          - '14'
          - '30'
          - '90'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  collect-data:
    name: Fetch Yahoo Finance Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache-suffix: ticker-data

      - name: Validate and normalize workflow inputs
        id: normalize-inputs
        env:
          INPUT_SYMBOLS: ${{ github.event.inputs.symbols }}
          INPUT_DATE_FROM: ${{ github.event.inputs.date_from }}
          INPUT_DATE_TO: ${{ github.event.inputs.date_to }}
        run: |
          set -euo pipefail

          # Normalize symbols: uppercase, trim, dedupe, and keep comma-separated format.
          # Preferred share tickers may contain dots (BRK.B), hyphens (PCG-PA),
          # carets (^GSPC), or equals signs (=SPX).
          normalized_symbols=$(printf '%s' "$INPUT_SYMBOLS" \
            | tr ',' '\n' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
            | awk 'NF { print toupper($0) }' \
            | awk '!seen[$0]++' \
            | paste -sd, -)

          if [ -z "$normalized_symbols" ]; then
            echo "Input validation failed: symbols list is empty after normalization."
            exit 1
          fi

          # Validate each symbol against allowed characters.
          # Hyphen MUST be at end of character class to be literal; placing it
          # in the middle (e.g. [\-^]) creates an unintended range that excludes
          # the literal hyphen — see AI-20260220-regex-hyphen-character-class.
          invalid_symbols=$(printf '%s' "$normalized_symbols" \
            | tr ',' '\n' \
            | grep -Ev '^[A-Z0-9.^/=_-]+$' \
            | paste -sd, -)
          if [ -n "$invalid_symbols" ]; then
            echo "Input validation failed: one or more symbols contain unsupported characters."
            echo "Invalid symbols: $invalid_symbols"
            echo "Allowed pattern per symbol: [A-Z0-9.^/=_-]+"
            exit 1
          fi

          validate_date() {
            local label=$1
            local value=$2
            if [ -n "$value" ] && ! date -d "$value" '+%Y-%m-%d' >/dev/null 2>&1; then
              echo "Input validation failed: $label must be YYYY-MM-DD (received '$value')."
              exit 1
            fi
          }

          validate_date "date_from" "$INPUT_DATE_FROM"
          validate_date "date_to" "$INPUT_DATE_TO"

          if [ -n "$INPUT_DATE_FROM" ] && [ -n "$INPUT_DATE_TO" ]; then
            if [ "$(date -d "$INPUT_DATE_FROM" '+%s')" -gt "$(date -d "$INPUT_DATE_TO" '+%s')" ]; then
              echo "Input validation failed: date_from must be less than or equal to date_to."
              exit 1
            fi
          fi

          # Use heredoc delimiters for outputs to safely handle special characters
          # in symbol names (dots, hyphens, carets, slashes).
          {
            echo "normalized_symbols<<SYMBOLS_EOF"
            echo "$normalized_symbols"
            echo "SYMBOLS_EOF"
          } >> "$GITHUB_OUTPUT"
          echo "validated_date_from=$INPUT_DATE_FROM" >> "$GITHUB_OUTPUT"
          echo "validated_date_to=$INPUT_DATE_TO" >> "$GITHUB_OUTPUT"

          echo "Normalized symbols: $normalized_symbols"
          echo "date_from: ${INPUT_DATE_FROM:-<empty>}"
          echo "date_to: ${INPUT_DATE_TO:-<empty>}"

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Build
        run: |
          dotnet build MarketDataCollector.sln -c Release --no-restore /p:EnableWindowsTargeting=true

      - name: Fetch ticker data
        env:
          YAHOO_TICKER_SYMBOLS: ${{ steps.normalize-inputs.outputs.normalized_symbols }}
          YAHOO_TICKER_DATE_FROM: ${{ steps.normalize-inputs.outputs.validated_date_from }}
          YAHOO_TICKER_DATE_TO: ${{ steps.normalize-inputs.outputs.validated_date_to }}
        run: |
          echo "Fetching data for symbols: $YAHOO_TICKER_SYMBOLS"
          echo ""

          dotnet test tests/MarketDataCollector.Tests/MarketDataCollector.Tests.csproj \
            -c Release \
            --no-build \
            --verbosity normal \
            --filter "Category=TickerArtifact" \
            --logger "trx;LogFileName=ticker-data-results.trx" \
            --results-directory ./TestResults

      - name: Locate artifact output
        if: always()
        id: find-output
        run: |
          # The test writes to ArtifactOutput relative to the test binary output dir
          OUTPUT_DIR=$(find . -type d -name "ArtifactOutput" 2>/dev/null | head -1)

          if [ -n "$OUTPUT_DIR" ]; then
            echo "output_dir=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"
            echo "Found output directory: $OUTPUT_DIR"
            echo ""
            echo "Files collected:"
            ls -lh "$OUTPUT_DIR"
            echo ""
            if [ -f "$OUTPUT_DIR/collection_summary.txt" ]; then
              echo "--- Collection Summary ---"
              cat "$OUTPUT_DIR/collection_summary.txt"
            fi
          else
            echo "No ArtifactOutput directory found"
            echo "output_dir=" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload ticker data artifact
        if: always() && steps.find-output.outputs.output_dir != ''
        uses: actions/upload-artifact@v4
        with:
          name: ticker-data-${{ github.run_number }}-${{ github.sha }}
          path: ${{ steps.find-output.outputs.output_dir }}/
          retention-days: ${{ github.event.inputs.retention_days || '30' }}
          if-no-files-found: error

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ticker-test-results-${{ github.run_number }}
          path: ./TestResults/
          retention-days: 7
          if-no-files-found: warn

      - name: Generate job summary
        if: always()
        env:
          SUMMARY_SYMBOLS: ${{ steps.normalize-inputs.outputs.normalized_symbols }}
          SUMMARY_DATE_FROM: ${{ steps.normalize-inputs.outputs.validated_date_from || 'all history' }}
          SUMMARY_DATE_TO: ${{ steps.normalize-inputs.outputs.validated_date_to || 'latest' }}
          SUMMARY_RUN_NUMBER: ${{ github.run_number }}
          SUMMARY_OUTPUT_DIR: ${{ steps.find-output.outputs.output_dir }}
        run: |
          echo "## Ticker Data Collection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Symbols:** \`${SUMMARY_SYMBOLS}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date range:** \`${SUMMARY_DATE_FROM} → ${SUMMARY_DATE_TO}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${SUMMARY_RUN_NUMBER} | **Commit:** \`${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$SUMMARY_OUTPUT_DIR" ] && [ -f "$SUMMARY_OUTPUT_DIR/collection_summary.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "$SUMMARY_OUTPUT_DIR/collection_summary.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> No collection summary available." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **ticker-data-${SUMMARY_RUN_NUMBER}-${GITHUB_SHA}** — JSON files with historical bar data" >> $GITHUB_STEP_SUMMARY
          echo "- **ticker-test-results-${SUMMARY_RUN_NUMBER}** — Test result (.trx) file" >> $GITHUB_STEP_SUMMARY
