# Documentation Structure Sync Workflow
# Automatically updates documentation when repository structure changes
# Detects new directories, providers, interfaces, and features

name: Docs Structure Sync

on:
  # push trigger disabled
  # push:
  #   branches: [main]
  #   paths:
  #     - 'src/**'
  #     - 'docs/**'
  #     - 'scripts/**'
  #     - 'tools/**'
  #     - 'tests/**'
  #     - 'benchmarks/**'
  #     - '.github/workflows/**'
  # pull_request trigger disabled
  # pull_request:
  #   branches: [main]
  #   paths:
  #     - 'src/**'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force regenerate all structure documentation'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry run - show changes without committing'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: docs-structure-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  detect-changes:
    name: Detect Structure Changes
    runs-on: ubuntu-latest
    outputs:
      src_changed: ${{ steps.changes.outputs.src }}
      providers_changed: ${{ steps.changes.outputs.providers }}
      docs_changed: ${{ steps.changes.outputs.docs }}
      workflows_changed: ${{ steps.changes.outputs.workflows }}
      structure_changed: ${{ steps.changes.outputs.structure }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            src:
              - 'src/**/*.cs'
              - 'src/**/*.fs'
            providers:
              - 'src/MarketDataCollector/Infrastructure/Providers/**'
            docs:
              - 'docs/**/*.md'
              - 'CLAUDE.md'
              - 'README.md'
            workflows:
              - '.github/workflows/**'
            structure:
              - added|deleted: 'src/**'
              - added|deleted: 'docs/**'
              - added|deleted: 'scripts/**'
              - added|deleted: 'tools/**'

  generate-structure-docs:
    name: Generate Structure Documentation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.structure_changed == 'true' ||
      needs.detect-changes.outputs.src_changed == 'true' ||
      github.event.inputs.force_update == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Generate repository structure
        id: gen-structure
        run: |
          python3 scripts/docs/generate-structure-docs.py \
            --output docs/generated/repository-structure.md \
            --format markdown

          if [ -f docs/generated/repository-structure.md ]; then
            echo "structure_generated=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate provider registry
        id: gen-providers
        run: |
          python3 scripts/docs/generate-structure-docs.py \
            --output docs/generated/provider-registry.md \
            --providers-only

          if [ -f docs/generated/provider-registry.md ]; then
            echo "providers_generated=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate workflow documentation
        id: gen-workflows
        run: |
          python3 scripts/docs/generate-structure-docs.py \
            --output docs/generated/workflows-overview.md \
            --workflows-only

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain docs/generated/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "::notice::Documentation changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::No documentation changes needed"
          fi

      - name: Generate summary
        run: |
          echo "## Structure Documentation Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Document | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository Structure | ${{ steps.gen-structure.outputs.structure_generated && '✅ Generated' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Provider Registry | ${{ steps.gen-providers.outputs.providers_generated && '✅ Generated' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflows Overview | ✅ Generated |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes detected:** ${{ steps.check-changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY

      - name: Commit documentation updates
        if: |
          steps.check-changes.outputs.has_changes == 'true' &&
          github.event_name == 'push' &&
          github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/generated/
          git commit -m "docs: auto-update structure documentation

          - Updated repository structure
          - Updated provider registry
          - Updated workflows overview

          [skip ci]"

          git push

  sync-provider-docs:
    name: Sync Provider Documentation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.providers_changed == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build to extract metadata
        run: |
          dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true
          dotnet build src/MarketDataCollector/MarketDataCollector.csproj \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true \
            /p:GenerateDocumentationFile=true
        continue-on-error: true

      - name: Extract provider information
        run: |
          python3 scripts/docs/generate-structure-docs.py \
            --output docs/generated/provider-registry.md \
            --providers-only \
            --extract-attributes

      - name: Check for provider doc changes
        id: check-providers
        run: |
          if [ -n "$(git status --porcelain docs/generated/provider-registry.md)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit provider documentation
        if: |
          steps.check-providers.outputs.has_changes == 'true' &&
          github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/generated/provider-registry.md
          git commit -m "docs: auto-update provider registry

          Provider changes detected and documentation synchronized.

          [skip ci]"

          git push

  update-claude-md:
    name: Update CLAUDE.md Structure
    runs-on: ubuntu-latest
    needs: [detect-changes, generate-structure-docs]
    if: |
      always() &&
      needs.detect-changes.outputs.structure_changed == 'true' &&
      github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Update CLAUDE.md repository structure section
        run: |
          python3 scripts/docs/update-claude-md.py \
            --claude-md CLAUDE.md \
            --structure-source docs/generated/repository-structure.md

      - name: Check for CLAUDE.md changes
        id: check-claude
        run: |
          if [ -n "$(git status --porcelain CLAUDE.md)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit CLAUDE.md updates
        if: steps.check-claude.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CLAUDE.md
          git commit -m "docs: auto-update CLAUDE.md repository structure

          Repository structure section updated to reflect current layout.

          [skip ci]"

          git push

  documentation-report:
    name: Documentation Report
    runs-on: ubuntu-latest
    needs: [detect-changes, generate-structure-docs, sync-provider-docs, update-claude-md]
    if: always()

    steps:
      - name: Generate workflow report
        run: |
          echo "# Documentation Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "| Area | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source Code | ${{ needs.detect-changes.outputs.src_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Providers | ${{ needs.detect-changes.outputs.providers_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.detect-changes.outputs.docs_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure | ${{ needs.detect-changes.outputs.structure_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflows | ${{ needs.detect-changes.outputs.workflows_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Generate Structure Docs | ${{ needs.generate-structure-docs.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sync Provider Docs | ${{ needs.sync-provider-docs.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Update CLAUDE.md | ${{ needs.update-claude-md.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
