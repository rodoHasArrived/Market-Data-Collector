name: Dependency Review

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: Review Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Log PR context
        run: |
          echo "=== Pull Request Context ==="
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"
          echo "Base Ref: ${{ github.base_ref }}"
          echo "Head Ref: ${{ github.head_ref }}"
          echo ""
          echo "=== Changed Files ==="
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} || echo "Could not get diff"
          echo ""
          echo "=== Dependency Files Changed ==="
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E '\.(csproj|fsproj|props|targets|json|lock)$' || echo "No dependency files changed"

      - name: Dependency Review
        id: dependency-review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          warn-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0
          comment-summary-in-pr: always
          base-ref: ${{ github.event.pull_request.base.sha }}
          head-ref: ${{ github.event.pull_request.head.sha }}

      - name: Log review outcome
        if: always()
        run: |
          echo "=== Dependency Review Complete ==="
          echo "Job Status: ${{ job.status }}"
          echo "Review Step Outcome: ${{ steps.dependency-review.outcome }}"
          echo "Review Step Conclusion: ${{ steps.dependency-review.conclusion }}"
          if [ "${{ steps.dependency-review.outcome }}" == "failure" ]; then
            echo ""
            echo "Review failed. Common causes:"
            echo "  - Dependencies with high severity vulnerabilities"
            echo "  - Dependencies with denied licenses (GPL-2.0, GPL-3.0)"
            echo "  - Unable to resolve dependency graph"
            echo ""
            echo "Check the PR comment for detailed vulnerability information."
          fi
