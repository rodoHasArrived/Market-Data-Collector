# Code Quality Workflow
# Runs code formatting checks and static analysis on every PR and push to main

name: Code Quality

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'benchmarks/**'
      - '*.props'
      - '*.targets'
      - '**/*.csproj'
      - '**/*.fsproj'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'benchmarks/**'
      - '*.props'
      - '*.targets'
      - '**/*.csproj'
      - '**/*.fsproj'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  format-check:
    name: Code Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj', 'Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Check code formatting
        run: dotnet format MarketDataCollector.sln --verify-no-changes --verbosity diagnostic
        continue-on-error: true
        id: format-check

      - name: Report formatting issues
        if: steps.format-check.outcome == 'failure'
        run: |
          echo "::warning::Code formatting issues detected. Run 'dotnet format' locally to fix."

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj', 'Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Build with analysis
        run: |
          dotnet build MarketDataCollector.sln \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true \
            /p:TreatWarningsAsErrors=false \
            /p:AnalysisLevel=latest \
            /p:EnforceCodeStyleInBuild=true \
            /p:RunAnalyzersDuringBuild=true

      - name: Check for nullable reference warnings
        run: |
          dotnet build MarketDataCollector.sln \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true \
            /warnaserror:nullable 2>&1 | tee build.log || true

          NULLABLE_WARNINGS=$(grep -c "warning CS86" build.log || true)
          if [ "$NULLABLE_WARNINGS" -gt 0 ]; then
            echo "::warning::Found $NULLABLE_WARNINGS nullable reference warnings"
          fi

  xml-documentation:
    name: XML Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj', 'Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Build with XML documentation
        run: |
          dotnet build MarketDataCollector.sln \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true \
            /p:GenerateDocumentationFile=true \
            /p:NoWarn=1591

      - name: Validate XML documentation exists
        run: |
          echo "## XML Documentation Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find . -name "*.xml" -path "*/bin/Release/*" | while read xmlfile; do
            if [ -s "$xmlfile" ]; then
              echo "- $(basename $xmlfile)" >> $GITHUB_STEP_SUMMARY
            fi
          done
