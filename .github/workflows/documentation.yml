# Documentation Validation Workflow
# Validates documentation, generates project context, verifies ADR links,
# and ingests AI known-error issues into docs/ai-known-errors.md.

name: Documentation

on:
  push:
    branches: [ "main" ]
    paths:
      - 'docs/**'
      - '*.md'
      - 'build/dotnet/DocGenerator/**'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'docs/**'
      - '*.md'
  issues:
    types: [opened, edited, labeled, reopened]
  workflow_dispatch:
    inputs:
      regenerate:
        description: 'Force regenerate all documentation'
        required: false
        default: 'false'
        type: boolean
      issue_number:
        description: 'Optional issue number to ingest into docs/ai-known-errors.md'
        required: false
        type: string

permissions:
  contents: write
  issues: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  ai-known-errors-intake:
    name: AI Known Errors Intake
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-known-error')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve issue payload for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        id: fetch_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = Number(core.getInput('issue_number'));
            if (!issue_number) {
              core.setFailed('workflow_dispatch requires a numeric issue_number input for intake.');
              return;
            }

            const { data } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
            });

            core.setOutput('number', String(data.number));
            core.setOutput('title', data.title || '');
            core.setOutput('body', data.body || '');

      - name: Update docs/ai-known-errors.md from issue
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          DISPATCH_ISSUE_NUMBER: ${{ steps.fetch_issue.outputs.number }}
          DISPATCH_ISSUE_TITLE: ${{ steps.fetch_issue.outputs.title }}
          DISPATCH_ISSUE_BODY: ${{ steps.fetch_issue.outputs.body }}
        run: |
          python3 - <<'PY'
          import datetime
          import os
          import pathlib
          import re

          def text(name: str) -> str:
              return os.environ.get(name, "") or ""

          event_name = text("EVENT_NAME")
          if event_name == "workflow_dispatch":
              number = text("DISPATCH_ISSUE_NUMBER")
              title = text("DISPATCH_ISSUE_TITLE")
              body = text("DISPATCH_ISSUE_BODY")
          else:
              number = text("ISSUE_NUMBER")
              title = text("ISSUE_TITLE")
              body = text("ISSUE_BODY")

          if not number:
              raise SystemExit("No issue number found.")

          doc = pathlib.Path("docs/ai-known-errors.md")
          current = doc.read_text(encoding="utf-8")
          marker = f"#${number}"
          if marker in current:
              print(f"Entry already exists for issue {number}; skipping")
              raise SystemExit(0)

          def section(name: str, fallback: str) -> str:
              m = re.search(rf"(?ims)^##\s*{re.escape(name)}\s*$\n(.*?)(?=^##\s+|\Z)", body)
              if not m:
                  return fallback
              value = m.group(1).strip()
              return value if value else fallback

          def normalize_lines(value: str) -> str:
              lines = [ln.rstrip() for ln in value.splitlines() if ln.strip()]
              return "\n".join(lines) if lines else "Not provided."

          def checkbox_lines(value: str) -> str:
              items = []
              for ln in value.splitlines():
                  s = ln.strip()
                  if not s:
                      continue
                  s = re.sub(r"^[-*]\s*", "", s)
                  s = re.sub(r"^\[[ xX]\]\s*", "", s)
                  items.append(f"  - [ ] {s}")
              if not items:
                  items = ["  - [ ] Add prevention checks from the linked issue."]
              return "\n".join(items)

          def command_lines(value: str) -> str:
              cmds = []
              in_code = False
              for ln in value.splitlines():
                  if ln.strip().startswith("```"):
                      in_code = not in_code
                      continue
                  s = ln.strip()
                  if not s:
                      continue
                  if in_code:
                      cmds.append(f"  - `{s}`")
                  elif s.startswith("-"):
                      cmds.append(f"  - `{s.lstrip('- ').strip('`')}`")
                  elif re.match(r"^[A-Za-z0-9_.\-/]+", s):
                      cmds.append(f"  - `{s.strip('`')}`")
              if not cmds:
                  cmds = ["  - `# add verification commands`"]
              return "\n".join(cmds)

          area = normalize_lines(section("Area", "process"))
          symptoms = normalize_lines(section("Symptoms", title or "Issue description not provided."))
          root = normalize_lines(section("Root cause", "Root cause not yet documented."))
          prevention = checkbox_lines(section("Prevention checklist", ""))
          verification = command_lines(section("Verification commands", ""))

          date_tag = datetime.datetime.utcnow().strftime("%Y%m%d")
          slug = re.sub(r"[^a-z0-9]+", "-", (title or "issue").lower()).strip("-")[:40] or "issue"
          entry_id = f"AI-{date_tag}-{slug}"

          entry = (
              f"\n### {entry_id}\n"
              f"- **Area**: {area}\n"
              f"- **Symptoms**: {symptoms}\n"
              f"- **Root cause**: {root}\n"
              f"- **Prevention checklist**:\n{prevention}\n"
              f"- **Verification commands**:\n{verification}\n"
              f"- **Source issue**: #{number}\n"
              f"- **Status**: open\n"
          )

          if "## Known issues" in current:
              updated = current.rstrip() + entry + "\n"
          else:
              updated = current.rstrip() + "\n\n## Known issues\n" + entry + "\n"

          doc.write_text(updated, encoding="utf-8")
          print(f"Added {entry_id} from issue #{number}")
          PY

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet -- docs/ai-known-errors.md; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR with known-error update
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: ingest ai-known-error issue into registry"
          title: "docs: ingest ai-known-error issue into registry"
          body: |
            ## Summary
            - ingest a labeled AI issue into `docs/ai-known-errors.md`
            - preserve source issue reference for traceability

            ## Trigger
            - `${{ github.event_name }}` event
          branch: automation/ai-known-errors-intake
          delete-branch: true
          labels: |
            documentation
            automation

  markdown-lint:
    name: Markdown Lint
    if: github.event_name != 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v22.0.0
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/bin/**
            !**/obj/**
        continue-on-error: true

  link-validation:
    name: Link Validation
    if: github.event_name != 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check links in documentation
        uses: gaurav-nelson/github-action-markdown-link-check@1.0.17
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          folder-path: 'docs/'
          max-depth: 5
        continue-on-error: true

  adr-verification:
    name: ADR Verification
    if: github.event_name != 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore and build DocGenerator
        run: |
          if [ -d "build/dotnet/DocGenerator" ]; then
            dotnet restore build/dotnet/DocGenerator/DocGenerator.csproj
            dotnet build build/dotnet/DocGenerator/DocGenerator.csproj -c Release --no-restore
          fi
        continue-on-error: true

      - name: Verify ADR implementation links
        run: |
          echo "## ADR Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ADR_COUNT=$(find docs -path "*/adr/*.md" -o -path "*/decisions/*.md" 2>/dev/null | wc -l)
          echo "Found $ADR_COUNT ADR files" >> $GITHUB_STEP_SUMMARY

  project-context-generation:
    name: Project Context Generation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.regenerate == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

      - name: Build with XML docs
        run: |
          dotnet build src/MarketDataCollector/MarketDataCollector.csproj \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true \
            /p:GenerateDocumentationFile=true

      - name: Generate documentation summary
        run: |
          echo "## Documentation Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          md_count=$(find docs -name "*.md" | wc -l)
          echo "- **Documentation files:** $md_count" >> $GITHUB_STEP_SUMMARY

  documentation-summary:
    name: Documentation Summary
    if: github.event_name != 'issues' && always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [markdown-lint, link-validation, adr-verification]

    steps:
      - name: Generate documentation report
        run: |
          echo "# Documentation Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown Lint | ${{ needs.markdown-lint.result == 'success' && '✅ Passed' || (needs.markdown-lint.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Link Validation | ${{ needs.link-validation.result == 'success' && '✅ Passed' || (needs.link-validation.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ADR Verification | ${{ needs.adr-verification.result == 'success' && '✅ Passed' || (needs.adr-verification.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.markdown-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.link-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.adr-verification.result }}" == "failure" ]]; then
            echo "### ❌ Some documentation checks failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ All documentation checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
