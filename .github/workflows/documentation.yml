# Consolidated Documentation & AI Instruction Automation
#
# Replaces and combines:
#   - docs-comprehensive.yml (Documentation & Workflow Automation)
#   - docs-auto-update.yml (Docs Auto-Update)
#   - docs-structure-sync.yml (Docs Structure Sync)
#   - ai-instructions-sync.yml (AI Instructions Sync)
#
# All documentation generation, validation, AI instruction sync, and
# known-error intake functionality is unified here. No functionality removed.

name: Documentation Automation

on:
  push:
    branches: ["main"]
    paths:
      - 'docs/**'
      - '*.md'
      - 'CLAUDE.md'
      - '.github/workflows/**'
      - '.github/agents/**'
      - 'build/scripts/docs/**'
      - 'build/dotnet/DocGenerator/**'
      - 'src/**'
      - 'tests/**'
      - 'benchmarks/**'
      - 'config/appsettings.sample.json'
  pull_request:
    branches: ["main"]
    paths:
      - 'docs/**'
      - '*.md'
      - 'CLAUDE.md'
      - '.github/workflows/**'
      - '.github/agents/**'
      - 'build/scripts/docs/**'
      - 'build/dotnet/DocGenerator/**'
      - 'src/**'
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      regenerate:
        description: 'Force regenerate generated docs and AI instruction files'
        required: false
        default: 'false'
        type: boolean
      update_all:
        description: 'Update all auto-generated documentation outputs'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Show changes without committing'
        required: false
        default: 'true'
        type: boolean
      create_pr:
        description: 'Create PR for generated updates (manual runs only)'
        required: false
        default: 'false'
        type: boolean
      issue_number:
        description: 'Optional issue number to ingest into docs/ai-known-errors.md'
        required: false
        type: string
      update_all:
        description: 'Update all auto-generated documentation (providers, ADRs, config)'
        required: false
        default: 'false'
        type: boolean
      force_update:
        description: 'Force regenerate all structure documentation'
        required: false
        default: 'false'
        type: boolean
  issues:
    types: [opened, edited, labeled, reopened]

permissions:
  contents: write
  issues: read
  pull-requests: write
  models: read

concurrency:
  group: documentation-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  DOTNET_VERSION: '9.0.x'
  PYTHON_VERSION: '3.11'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # ─── AI Known Errors Intake (from docs-comprehensive) ──────────────────
  ai-known-errors-intake:
    name: AI Known Errors Intake
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-known-error')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '' && github.event.inputs.issue_number != null)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve issue payload for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        id: fetch_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = Number(core.getInput('issue_number'));
            if (!issue_number) {
              core.setFailed('workflow_dispatch requires a numeric issue_number input for intake.');
              return;
            }

            const { data } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
            });

            core.setOutput('number', String(data.number));
            core.setOutput('title', data.title || '');
            core.setOutput('body', data.body || '');

      - name: Update docs/ai-known-errors.md from issue
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          DISPATCH_ISSUE_NUMBER: ${{ steps.fetch_issue.outputs.number }}
          DISPATCH_ISSUE_TITLE: ${{ steps.fetch_issue.outputs.title }}
          DISPATCH_ISSUE_BODY: ${{ steps.fetch_issue.outputs.body }}
        run: |
          python3 - <<'PY'
          import datetime
          import os
          import pathlib
          import re

          def text(name: str) -> str:
              return os.environ.get(name, "") or ""

          event_name = text("EVENT_NAME")
          if event_name == "workflow_dispatch":
              number = text("DISPATCH_ISSUE_NUMBER")
              title = text("DISPATCH_ISSUE_TITLE")
              body = text("DISPATCH_ISSUE_BODY")
          else:
              number = text("ISSUE_NUMBER")
              title = text("ISSUE_TITLE")
              body = text("ISSUE_BODY")

          if not number:
              raise SystemExit("No issue number found.")

          doc = pathlib.Path("docs/ai-known-errors.md")
          current = doc.read_text(encoding="utf-8")
          marker = f"#${number}"
          if marker in current:
              print(f"Entry already exists for issue {number}; skipping")
              raise SystemExit(0)

          def section(name: str, fallback: str) -> str:
              m = re.search(rf"(?ims)^##\s*{re.escape(name)}\s*$\n(.*?)(?=^##\s+|\Z)", body)
              if not m:
                  return fallback
              value = m.group(1).strip()
              return value if value else fallback

          def normalize_lines(value: str) -> str:
              lines = [ln.rstrip() for ln in value.splitlines() if ln.strip()]
              return "\n".join(lines) if lines else "Not provided."

          def checkbox_lines(value: str) -> str:
              items = []
              for ln in value.splitlines():
                  s = ln.strip()
                  if not s:
                      continue
                  s = re.sub(r"^[-*]\s*", "", s)
                  s = re.sub(r"^\[[ xX]\]\s*", "", s)
                  items.append(f"  - [ ] {s}")
              if not items:
                  items = ["  - [ ] Add prevention checks from the linked issue."]
              return "\n".join(items)

          def command_lines(value: str) -> str:
              cmds = []
              in_code = False
              for ln in value.splitlines():
                  if ln.strip().startswith("```"):
                      in_code = not in_code
                      continue
                  s = ln.strip()
                  if not s:
                      continue
                  if in_code:
                      cmds.append(f"  - `{s}`")
                  elif s.startswith("-"):
                      cmds.append(f"  - `{s.lstrip('- ').strip('`')}`")
                  elif re.match(r"^[A-Za-z0-9_.\-/]+", s):
                      cmds.append(f"  - `{s.strip('`')}`")
              if not cmds:
                  cmds = ["  - `# add verification commands`"]
              return "\n".join(cmds)

          area = normalize_lines(section("Area", "process"))
          symptoms = normalize_lines(section("Symptoms", title or "Issue description not provided."))
          root = normalize_lines(section("Root cause", "Root cause not yet documented."))
          prevention = checkbox_lines(section("Prevention checklist", ""))
          verification = command_lines(section("Verification commands", ""))
          references = normalize_lines(section("References", f"- https://github.com/${{ github.repository }}/issues/{number}"))

          today = datetime.datetime.utcnow().date().isoformat()

          block = f"""
          ## [{today}] #{number} {title or 'Untitled issue'}
          - Area: {area}
          - Symptoms:
            {symptoms.replace(chr(10), chr(10) + '  ')}
          - Root cause:
            {root.replace(chr(10), chr(10) + '  ')}
          - Prevention checklist:
          {prevention}
          - Verification commands:
          {verification}
          - References:
            {references.replace(chr(10), chr(10) + '  ')}
          """.strip()

          updated = current.rstrip() + "\n\n" + block + "\n"
          doc.write_text(updated, encoding="utf-8")
          print(f"Appended issue {number} to {doc}")
          PY

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet -- docs/ai-known-errors.md; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR with known-error update
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: ingest ai-known-error issue into registry"
          title: "docs: ingest ai-known-error issue into registry"
          body: |
            ## Summary
            - ingest a labeled AI issue into `docs/ai-known-errors.md`
            - preserve source issue reference for traceability

            ## Trigger
            - `${{ github.event_name }}` event
          branch: automation/ai-known-errors-intake
          delete-branch: true
          labels: |
            documentation
            automation

  # ─── Change Detection (unified from all 4 workflows) ──────────────────
  detect-changes:
    name: Detect Documentation & Structure Changes
    if: github.event_name != 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      docs_changed: ${{ steps.filter.outputs.docs }}
      structure_changed: ${{ steps.filter.outputs.structure }}
      workflow_changed: ${{ steps.filter.outputs.workflows }}
      providers_changed: ${{ steps.filter.outputs.providers }}
      interfaces_changed: ${{ steps.filter.outputs.interfaces }}
      adrs_changed: ${{ steps.filter.outputs.adrs }}
      config_changed: ${{ steps.filter.outputs.config }}
      microservices_changed: ${{ steps.filter.outputs.microservices }}
      ai_files_changed: ${{ steps.filter.outputs.ai_files }}
      src_changed: ${{ steps.filter.outputs.src }}
      adrs_changed: ${{ steps.filter.outputs.adrs }}
      config_changed: ${{ steps.filter.outputs.config }}
      interfaces_changed: ${{ steps.filter.outputs.interfaces }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed areas
        id: filter
        uses: dorny/paths-filter@v3.0.2
        with:
          filters: |
            docs:
              - 'docs/**'
              - '*.md'
              - 'CLAUDE.md'
            workflows:
              - '.github/workflows/**'
            structure:
              - 'src/**'
              - 'tests/**'
              - 'benchmarks/**'
              - 'build/**'
              - added|deleted: 'src/**'
              - added|deleted: 'docs/**'
            providers:
              - 'src/MarketDataCollector/Infrastructure/Providers/**'
            interfaces:
              - 'src/MarketDataCollector/Infrastructure/IMarketDataClient.cs'
              - 'src/MarketDataCollector/Infrastructure/Providers/Backfill/IHistoricalDataProvider*.cs'
            adrs:
              - 'docs/adr/**'
            config:
              - 'config/appsettings.sample.json'
            microservices:
              - 'src/Microservices/**'
            ai_files:
              - 'docs/ai/**'
              - '.github/agents/**'
              - 'CLAUDE.md'
            src:
              - 'src/**/*.cs'
              - 'src/**/*.fs'
            adrs:
              - 'docs/adr/**'
            config:
              - 'config/appsettings.sample.json'
            interfaces:
              - 'src/MarketDataCollector/Infrastructure/IMarketDataClient.cs'
              - 'src/MarketDataCollector/Infrastructure/Providers/Backfill/IHistoricalDataProvider*.cs'

  # ─── Validate Documentation Quality ────────────────────────────────────
  validate-docs:
    name: Validate Documentation Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.docs_changed == 'true' ||
      needs.detect-changes.outputs.workflow_changed == 'true' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v22.0.0
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/bin/**
            !**/obj/**
        continue-on-error: true

      - name: Link validation
        uses: gaurav-nelson/github-action-markdown-link-check@1.0.17
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          folder-path: 'docs/'
          max-depth: 5
        continue-on-error: true

      - name: ADR inventory
        run: |
          set -euo pipefail
          echo "## ADR Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ADR_COUNT=$(find docs -path "*/adr/*.md" -o -path "*/decisions/*.md" 2>/dev/null | wc -l)
          echo "Found $ADR_COUNT ADR files" >> $GITHUB_STEP_SUMMARY

  # ─── Regenerate All Documentation (unified from all 4 workflows) ───────
  regenerate-docs:
    name: Regenerate Docs, Structure & AI Instructions
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.structure_changed == 'true' ||
      needs.detect-changes.outputs.docs_changed == 'true' ||
      needs.detect-changes.outputs.workflow_changed == 'true' ||
      needs.detect-changes.outputs.providers_changed == 'true' ||
      needs.detect-changes.outputs.interfaces_changed == 'true' ||
      needs.detect-changes.outputs.adrs_changed == 'true' ||
      needs.detect-changes.outputs.config_changed == 'true' ||
      needs.detect-changes.outputs.microservices_changed == 'true' ||
      needs.detect-changes.outputs.ai_files_changed == 'true' ||
      needs.detect-changes.outputs.src_changed == 'true' ||
      github.event.inputs.update_all == 'true' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule'
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup .NET with Cache
        uses: ./.github/actions/setup-dotnet-cache
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build project for metadata extraction
        run: |
          set -euo pipefail
          dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true
          dotnet build src/MarketDataCollector/MarketDataCollector.csproj \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true \
            /p:GenerateDocumentationFile=true
        continue-on-error: true

      # --- Structure docs (from docs-comprehensive + docs-structure-sync) ---
      - name: Generate structure and workflow docs
        run: |
          set -euo pipefail
          mkdir -p docs/generated
          python3 build/scripts/docs/generate-structure-docs.py --output docs/generated/repository-structure.md --format markdown
          python3 build/scripts/docs/generate-structure-docs.py --output docs/generated/workflows-overview.md --workflows-only

      # --- Provider docs (from docs-comprehensive + docs-auto-update + docs-structure-sync) ---
      - name: Generate provider registry
        if: |
          needs.detect-changes.outputs.providers_changed == 'true' ||
          needs.detect-changes.outputs.interfaces_changed == 'true' ||
          github.event.inputs.update_all == 'true' ||
          github.event.inputs.force_update == 'true' ||
          github.event_name == 'schedule'
        run: |
          set -euo pipefail
          python3 build/scripts/docs/generate-structure-docs.py \
            --output docs/generated/provider-registry.md \
            --providers-only \
            --extract-attributes

      - name: Generate ADR index
        run: |
          set -euo pipefail
          mkdir -p docs/generated
          echo "# Architecture Decision Records" > docs/generated/adr-index.md
          echo "" >> docs/generated/adr-index.md
          echo "> Auto-generated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> docs/generated/adr-index.md
          echo "" >> docs/generated/adr-index.md
          echo "| ADR | Title | Status |" >> docs/generated/adr-index.md
          echo "|-----|-------|--------|" >> docs/generated/adr-index.md

          for adr in docs/adr/*.md; do
            if [ -f "$adr" ]; then
              filename=$(basename "$adr")
              title=$(head -1 "$adr" | sed 's/^# //')
              status="Accepted"
              if grep -qi "status:.*superseded" "$adr"; then
                status="Superseded"
              elif grep -qi "status:.*deprecated" "$adr"; then
                status="Deprecated"
              fi
              echo "| [$filename](../adr/$filename) | $title | $status |" >> docs/generated/adr-index.md
            fi
          done

          echo "" >> docs/generated/adr-index.md
          echo "---" >> docs/generated/adr-index.md
          echo "*This file is auto-generated. Do not edit manually.*" >> docs/generated/adr-index.md

      - name: Generate configuration documentation
        run: |
          set -euo pipefail
          mkdir -p docs/generated

          cat > docs/generated/configuration-schema.md << 'EOD'
          # Configuration Schema

          > Auto-generated from `config/appsettings.sample.json`

          This document describes the configuration options available in the Market Data Collector.

          ## Configuration Sections

          EOD

          if [ -f "config/appsettings.sample.json" ]; then
            python3 -c "
          import json
          import sys

          try:
              with open('config/appsettings.sample.json', 'r') as f:
                  config = json.load(f)

              for section, value in config.items():
                  print(f'### {section}')
                  print('')
                  if isinstance(value, dict):
                      print('| Setting | Type | Description |')
                      print('|---------|------|-------------|')
                      for key, val in value.items():
                          val_type = type(val).__name__
                          print(f'| \`{key}\` | {val_type} | - |')
                  else:
                      print(f'Type: \`{type(value).__name__}\`')
                  print('')
          except Exception as e:
              print(f'Error parsing config: {e}', file=sys.stderr)
          " >> docs/generated/configuration-schema.md
          fi

          echo "---" >> docs/generated/configuration-schema.md
          echo "*This file is auto-generated. Do not edit manually.*" >> docs/generated/configuration-schema.md

      # --- Project context doc (from docs-comprehensive + docs-auto-update) ---
      - name: Generate project context doc (if tool exists)
        run: |
          set -euo pipefail
          if [ -d "build/dotnet/DocGenerator" ]; then
            dotnet restore build/dotnet/DocGenerator/DocGenerator.csproj
            dotnet build build/dotnet/DocGenerator/DocGenerator.csproj -c Release -v q || true
            dotnet run --project build/dotnet/DocGenerator/DocGenerator.csproj --no-build -c Release -- context --src src/MarketDataCollector --output docs/generated/project-context.md || true
          fi

      # --- ADR index (from docs-auto-update) ---
      - name: Generate ADR index
        if: |
          needs.detect-changes.outputs.adrs_changed == 'true' ||
          github.event.inputs.update_all == 'true' ||
          github.event_name == 'schedule'
        run: |
          set -euo pipefail
          if [ -d "build/dotnet/DocGenerator" ]; then
            dotnet run --project build/dotnet/DocGenerator/DocGenerator.csproj --no-build -c Release -- verify-adrs \
              --adr-dir docs/adr \
              --src-dir . || true
          fi

          echo "# Architecture Decision Records" > docs/generated/adr-index.md
          echo "" >> docs/generated/adr-index.md
          echo "> Auto-generated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> docs/generated/adr-index.md
          echo "" >> docs/generated/adr-index.md
          echo "| ADR | Title | Status |" >> docs/generated/adr-index.md
          echo "|-----|-------|--------|" >> docs/generated/adr-index.md

          for adr in docs/adr/*.md; do
            if [ -f "$adr" ]; then
              filename=$(basename "$adr")
              title=$(head -1 "$adr" | sed 's/^# //')
              status="Accepted"
              if grep -qi "status:.*superseded" "$adr"; then
                status="Superseded"
              elif grep -qi "status:.*deprecated" "$adr"; then
                status="Deprecated"
              fi
              echo "| [$filename](../adr/$filename) | $title | $status |" >> docs/generated/adr-index.md
            fi
          done

          echo "" >> docs/generated/adr-index.md
          echo "---" >> docs/generated/adr-index.md
          echo "*This file is auto-generated. Do not edit manually.*" >> docs/generated/adr-index.md

      # --- Configuration schema (from docs-auto-update) ---
      - name: Generate configuration schema
        if: |
          needs.detect-changes.outputs.config_changed == 'true' ||
          github.event.inputs.update_all == 'true' ||
          github.event_name == 'schedule'
        run: |
          set -euo pipefail
          mkdir -p docs/generated

          cat > docs/generated/configuration-schema.md << 'EOF'
          # Configuration Schema

          > Auto-generated from `config/appsettings.sample.json`

          This document describes the configuration options available in the Market Data Collector.

          ## Configuration Sections

          EOF

          if [ -f "config/appsettings.sample.json" ]; then
            python3 -c "
          import json
          import sys

          try:
              with open('config/appsettings.sample.json', 'r') as f:
                  config = json.load(f)

              for section, value in config.items():
                  print(f'### {section}')
                  print('')
                  if isinstance(value, dict):
                      print('| Setting | Type | Description |')
                      print('|---------|------|-------------|')
                      for key, val in value.items():
                          val_type = type(val).__name__
                          print(f'| \`{key}\` | {val_type} | - |')
                  else:
                      print(f'Type: \`{type(value).__name__}\`')
                  print('')
          except Exception as e:
              print(f'Error parsing config: {e}', file=sys.stderr)
          " >> docs/generated/configuration-schema.md
          fi

          echo "---" >> docs/generated/configuration-schema.md
          echo "*This file is auto-generated. Do not edit manually.*" >> docs/generated/configuration-schema.md

      # --- AI instruction sync (from docs-comprehensive + ai-instructions-sync) ---
      - name: Validate documentation automation inputs
        run: |
          set -euo pipefail
          required=(
            "build/scripts/docs/generate-structure-docs.py"
            "build/scripts/docs/update-claude-md.py"
            "docs/generated/repository-structure.md"
          )

          for path in "${required[@]}"; do
            if [ ! -e "$path" ]; then
              echo "Missing required file: $path" >&2
              exit 1
            fi
          done

      - name: Sync AI instruction files
        run: |
          set -euo pipefail
          files=(
            "CLAUDE.md"
            "docs/ai/copilot/instructions.md"
            ".github/agents/documentation-agent.md"
          )

          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              python3 build/scripts/docs/update-claude-md.py \
                --claude-md "$file" \
                --structure-source docs/generated/repository-structure.md
            else
              echo "Skipping missing AI instruction file: $file"
            fi
          done

      # --- AI-powered documentation quality review ---
      - name: AI documentation quality review
        id: ai-doc-review
        if: |
          github.event_name == 'schedule' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.regenerate == 'true')
        continue-on-error: true
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4.1-mini
          max-tokens: 1500
          prompt: |
            You are a documentation quality reviewer for a .NET market data collection project.
            Review the following generated documentation file list and provide:
            1) A brief quality assessment (completeness, consistency)
            2) Any gaps in documentation coverage
            3) Suggestions for improvement (max 3)

            Keep the response under 200 words in markdown format.

            Generated documentation files:
            - docs/generated/repository-structure.md
            - docs/generated/provider-registry.md
            - docs/generated/workflows-overview.md
            - docs/generated/project-context.md
            - docs/generated/adr-index.md
            - docs/generated/configuration-schema.md

            AI instruction files synced:
            - CLAUDE.md
            - docs/ai/copilot/instructions.md
            - .github/agents/documentation-agent.md

      # --- Check for changes ---
      - name: Check for generated changes
        id: changes
        run: |
          set -euo pipefail
          watched=(
            "docs/generated/"
            "docs/generated/adr-index.md"
            "docs/generated/configuration-schema.md"
            "CLAUDE.md"
            "docs/ai/copilot/instructions.md"
            ".github/agents/documentation-agent.md"
          )

          changed_files=$(git status --porcelain "${watched[@]}" | awk '{print $2}' | paste -sd ',' -)

          if [ -n "$(git status --porcelain "${watched[@]}")" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
            {
              echo "### Generated files changed"
              git status --short -- "${watched[@]}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_files=" >> $GITHUB_OUTPUT
            echo "No generated documentation changes detected." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Append AI review to summary
        if: always() && steps.ai-doc-review.outputs.response != ''
        run: |
          {
            echo ""
            echo "### AI Documentation Quality Review"
            echo ""
            echo "${{ steps.ai-doc-review.outputs.response }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Show dry-run diff
        if: |
          steps.changes.outputs.has_changes == 'true' &&
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.dry_run == 'true'
        run: |
          set -euo pipefail
          git --no-pager diff -- docs/generated/ CLAUDE.md docs/ai/copilot/instructions.md .github/agents/documentation-agent.md

      - name: Upload dry-run patch artifact
        if: |
          steps.changes.outputs.has_changes == 'true' &&
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.dry_run == 'true'
        run: |
          set -euo pipefail
          git --no-pager diff --binary -- docs/generated/ CLAUDE.md docs/ai/copilot/instructions.md .github/agents/documentation-agent.md > docs-automation.patch

      - name: Publish dry-run patch artifact
        if: |
          steps.changes.outputs.has_changes == 'true' &&
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.dry_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docs-automation-diff
          path: docs-automation.patch
          if-no-files-found: error

      - name: Commit direct updates
        if: |
          steps.changes.outputs.has_changes == 'true' &&
          (github.event_name == 'push' || github.event_name == 'schedule') &&
          github.actor != 'github-actions[bot]'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/generated/ CLAUDE.md docs/ai/copilot/instructions.md .github/agents/documentation-agent.md
          git commit -m "docs: consolidated documentation automation updates

          - Regenerated docs/generated artifacts
          - Synced AI instruction files
          - Updated provider registry, ADR index, config schema

          [skip ci]"
          git push

      - name: Create pull request for manual updates
        id: create-pr
        if: |
          steps.changes.outputs.has_changes == 'true' &&
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.create_pr == 'true' &&
          github.event.inputs.dry_run != 'true'
        continue-on-error: true
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: automation/docs-comprehensive-sync
          delete-branch: true
          commit-message: "docs: consolidated documentation automation updates"
          title: "docs: consolidated documentation automation updates"
          body: |
            ## Summary
            - Regenerated `docs/generated/*` artifacts.
            - Updated `docs/generated/adr-index.md` from ADR source files.
            - Updated `docs/generated/configuration-schema.md` from sample configuration.
            - Synced repository-structure sections in AI instruction files.
            - Updated provider registry, ADR index, configuration schema.
            - Consolidated all documentation automation outputs into one run.
          labels: |
            documentation
            automation

      - name: Fallback - Commit directly if PR creation failed
        if: |
          steps.changes.outputs.has_changes == 'true' &&
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.create_pr == 'true' &&
          github.event.inputs.dry_run != 'true' &&
          steps.create-pr.outcome == 'failure'
        run: |
          echo "::warning::PR creation failed. Falling back to direct commit."
          echo "::notice::To enable PR creation, go to Settings > Actions > General and enable 'Allow GitHub Actions to create and approve pull requests'"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/generated/ CLAUDE.md docs/ai/copilot/instructions.md .github/agents/documentation-agent.md
          git commit -m "docs: consolidated documentation automation updates

          Note: Committed directly because PR creation is disabled in repository settings.

          [skip ci]"

          git push

  # ─── Report (enhanced from all 4 workflows) ───────────────────────────
  report:
    name: Documentation Automation Report
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-changes, validate-docs, regenerate-docs]
    if: github.event_name != 'issues' && always()
    steps:
      - name: Publish summary
        run: |
          echo "# Documentation Automation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Area | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.detect-changes.outputs.docs_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflows | ${{ needs.detect-changes.outputs.workflow_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure | ${{ needs.detect-changes.outputs.structure_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Providers | ${{ needs.detect-changes.outputs.providers_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Interfaces | ${{ needs.detect-changes.outputs.interfaces_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ADRs | ${{ needs.detect-changes.outputs.adrs_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | ${{ needs.detect-changes.outputs.config_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Microservices | ${{ needs.detect-changes.outputs.microservices_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI files | ${{ needs.detect-changes.outputs.ai_files_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source code | ${{ needs.detect-changes.outputs.src_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ADRs | ${{ needs.detect-changes.outputs.adrs_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | ${{ needs.detect-changes.outputs.config_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Interfaces | ${{ needs.detect-changes.outputs.interfaces_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate docs | ${{ needs.validate-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Regenerate docs | ${{ needs.regenerate-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Generated Changes | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| has_changes | ${{ needs.regenerate-docs.outputs.has_changes || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| changed_files | ${{ needs.regenerate-docs.outputs.changed_files || 'none' }} |" >> $GITHUB_STEP_SUMMARY
