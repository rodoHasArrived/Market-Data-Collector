# Documentation Validation Workflow
# Validates documentation, generates project context, and verifies ADR links

name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**/*.cs'
      - 'src/**/*.fs'
      - 'tools/DocGenerator/**'
      - 'CLAUDE.md'
      - 'README.md'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**/*.cs'
      - 'src/**/*.fs'
      - 'tools/DocGenerator/**'
      - 'CLAUDE.md'
      - 'README.md'
  schedule:
    # Run weekly on Sunday at midnight to catch stale links
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      regenerate:
        description: 'Force regenerate all documentation'
        required: false
        default: 'false'
        type: boolean

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  validate-markdown:
    name: Validate Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": { "siblings_only": true },
            "MD029": { "style": "ordered" }
          }
          EOF

      - name: Lint markdown files
        run: |
          echo "## Markdown Validation" >> $GITHUB_STEP_SUMMARY

          markdownlint 'docs/**/*.md' 'README.md' 'CLAUDE.md' 2>&1 | tee lint-output.txt || true

          LINT_ERRORS=$(wc -l < lint-output.txt)
          if [ "$LINT_ERRORS" -gt 0 ]; then
            echo "::warning::Found markdown linting issues"
            echo "### âš ï¸ Linting Issues Found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 lint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Markdown Files Valid" >> $GITHUB_STEP_SUMMARY
          fi

  validate-links:
    name: Validate Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install link checker
        run: npm install -g markdown-link-check

      - name: Create link check config
        run: |
          cat > .markdown-link-check.json << 'EOF'
          {
            "ignorePatterns": [
              { "pattern": "^http://localhost" },
              { "pattern": "^https://localhost" },
              { "pattern": "^http://127.0.0.1" },
              { "pattern": "your-" },
              { "pattern": "example.com" }
            ],
            "timeout": "10s",
            "retryOn429": true,
            "retryCount": 3,
            "aliveStatusCodes": [200, 203, 206]
          }
          EOF

      - name: Check links in documentation
        run: |
          echo "## Link Validation" >> $GITHUB_STEP_SUMMARY

          find docs -name '*.md' -print0 | xargs -0 -I {} markdown-link-check {} --config .markdown-link-check.json 2>&1 | tee link-check.txt || true

          BROKEN_LINKS=$(grep -c "\[âœ–\]" link-check.txt || true)
          if [ "$BROKEN_LINKS" -gt 0 ]; then
            echo "::warning::Found $BROKEN_LINKS broken links"
            echo "### âš ï¸ Broken Links Found: $BROKEN_LINKS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A1 "\[âœ–\]" link-check.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Links Valid" >> $GITHUB_STEP_SUMMARY
          fi

  verify-adrs:
    name: Verify ADR Implementation Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore /p:EnableWindowsTargeting=true

      - name: Build DocGenerator
        run: dotnet build tools/DocGenerator -c Release --no-restore
        continue-on-error: true

      - name: Verify ADR implementation links
        run: |
          echo "## ADR Verification" >> $GITHUB_STEP_SUMMARY

          if [ -f "tools/DocGenerator/bin/Release/net9.0/DocGenerator" ]; then
            ./tools/DocGenerator/bin/Release/net9.0/DocGenerator verify-adrs --docs-path docs/architecture/decisions 2>&1 | tee adr-report.txt || true

            if grep -q "INVALID" adr-report.txt; then
              echo "::warning::Some ADR implementation links are invalid"
              echo "### âš ï¸ ADR Verification Issues" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat adr-report.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… All ADR Implementation Links Valid" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "::notice::DocGenerator not available, using fallback verification"
            echo "### â„¹ï¸ Basic ADR Check (DocGenerator not built)" >> $GITHUB_STEP_SUMMARY

            # Fallback: Check ADR files exist and have proper format
            ADR_COUNT=$(find docs/architecture/decisions -name "*.md" 2>/dev/null | wc -l)
            echo "Found $ADR_COUNT ADR files" >> $GITHUB_STEP_SUMMARY
          fi

  generate-context:
    name: Generate Project Context
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.regenerate == 'true')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore /p:EnableWindowsTargeting=true

      - name: Build DocGenerator
        run: dotnet build tools/DocGenerator -c Release --no-restore
        continue-on-error: true

      - name: Generate project context
        run: |
          mkdir -p docs/generated

          if [ -f "tools/DocGenerator/bin/Release/net9.0/DocGenerator" ]; then
            ./tools/DocGenerator/bin/Release/net9.0/DocGenerator context --output docs/generated/project-context.md || true
            ./tools/DocGenerator/bin/Release/net9.0/DocGenerator interfaces --output docs/generated/interfaces.md || true
          fi

          echo "## Documentation Generation" >> $GITHUB_STEP_SUMMARY
          echo "Generated documentation files:" >> $GITHUB_STEP_SUMMARY
          ls -la docs/generated/ 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No generated files" >> $GITHUB_STEP_SUMMARY

      - name: Check for documentation changes
        id: doc-changes
        run: |
          git diff --name-only docs/generated/ > changed-docs.txt || true
          if [ -s changed-docs.txt ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "### ðŸ“ Documentation Changes Detected" >> $GITHUB_STEP_SUMMARY
            cat changed-docs.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "### âœ… Documentation Up to Date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload generated documentation
        uses: actions/upload-artifact@v4
        with:
          name: generated-docs
          path: docs/generated/
          retention-days: 7

  check-diagrams:
    name: Validate Architecture Diagrams
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Validate DOT files
        run: |
          echo "## Architecture Diagrams" >> $GITHUB_STEP_SUMMARY

          DOT_FILES=$(find docs -name "*.dot" 2>/dev/null || true)
          if [ -n "$DOT_FILES" ]; then
            echo "### Validating DOT diagrams" >> $GITHUB_STEP_SUMMARY

            for file in $DOT_FILES; do
              if dot -Tsvg "$file" -o /dev/null 2>&1; then
                echo "âœ… $file" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ $file - Invalid syntax" >> $GITHUB_STEP_SUMMARY
                echo "::error file=$file::Invalid DOT syntax"
              fi
            done
          else
            echo "No DOT diagram files found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate diagram previews
        run: |
          mkdir -p docs/generated/diagrams
          for file in $(find docs -name "*.dot" 2>/dev/null); do
            basename=$(basename "$file" .dot)
            dot -Tpng "$file" -o "docs/generated/diagrams/${basename}.png" 2>/dev/null || true
          done

      - name: Upload diagram artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: architecture-diagrams
          path: docs/generated/diagrams/
          retention-days: 7

  documentation-coverage:
    name: Documentation Coverage Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate documentation coverage report
        run: |
          echo "## Documentation Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count documentation files
          TOTAL_MD=$(find docs -name "*.md" | wc -l)
          echo "### ðŸ“š Documentation Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total markdown files:** $TOTAL_MD" >> $GITHUB_STEP_SUMMARY

          # Count by category
          ARCH_DOCS=$(find docs/architecture -name "*.md" 2>/dev/null | wc -l || echo 0)
          GUIDE_DOCS=$(find docs/guides -name "*.md" 2>/dev/null | wc -l || echo 0)
          PROVIDER_DOCS=$(find docs/providers -name "*.md" 2>/dev/null | wc -l || echo 0)
          API_DOCS=$(find docs/api -name "*.md" 2>/dev/null | wc -l || echo 0)
          ADR_DOCS=$(find docs/architecture/decisions -name "*.md" 2>/dev/null | wc -l || echo 0)

          echo "- Architecture docs: $ARCH_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- Guides: $GUIDE_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- Provider docs: $PROVIDER_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- API docs: $API_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- ADRs: $ADR_DOCS" >> $GITHUB_STEP_SUMMARY

          # Count source files without corresponding docs
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Source Coverage" >> $GITHUB_STEP_SUMMARY

          CS_FILES=$(find src -name "*.cs" | wc -l)
          FS_FILES=$(find src -name "*.fs" | wc -l)
          echo "- C# source files: $CS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- F# source files: $FS_FILES" >> $GITHUB_STEP_SUMMARY

          # Check for README files in key directories
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Project README Coverage" >> $GITHUB_STEP_SUMMARY

          for dir in src/MarketDataCollector src/Microservices tests benchmarks; do
            if [ -f "$dir/README.md" ]; then
              echo "âœ… $dir/README.md" >> $GITHUB_STEP_SUMMARY
            else
              echo "â“ $dir/README.md (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          done
