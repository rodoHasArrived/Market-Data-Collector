# Documentation Validation Workflow
# Validates documentation, generates project context, and verifies ADR links

name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**/*.cs'
      - 'src/**/*.fs'
      - 'tools/DocGenerator/**'
      - 'CLAUDE.md'
      - 'README.md'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**/*.cs'
      - 'src/**/*.fs'
      - 'tools/DocGenerator/**'
      - 'CLAUDE.md'
      - 'README.md'
  schedule:
    # Run weekly on Sunday at midnight to catch stale links
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      regenerate:
        description: 'Force regenerate all documentation'
        required: false
        default: 'false'
        type: boolean
    branches: [ "main" ]
    paths:
      - 'docs/**'
      - '**.md'
      - 'src/**/*.cs'
      - 'tools/DocGenerator/**'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'docs/**'
      - '**.md'
      - 'src/**/*.cs'
      - 'tools/DocGenerator/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  validate-markdown:
    name: Validate Markdown
    runs-on: ubuntu-latest
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": { "siblings_only": true },
            "MD029": { "style": "ordered" }
          }
          EOF

      - name: Lint markdown files
        run: |
          echo "## Markdown Validation" >> $GITHUB_STEP_SUMMARY

          markdownlint 'docs/**/*.md' 'README.md' 'CLAUDE.md' 2>&1 | tee lint-output.txt || true

          LINT_ERRORS=$(wc -l < lint-output.txt)
          if [ "$LINT_ERRORS" -gt 0 ]; then
            echo "::warning::Found markdown linting issues"
            echo "### âš ï¸ Linting Issues Found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 lint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Markdown Files Valid" >> $GITHUB_STEP_SUMMARY
          fi

  validate-links:
    name: Validate Links
    runs-on: ubuntu-latest
      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/bin/**
            !**/obj/**

  link-validation:
    name: Link Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install link checker
        run: npm install -g markdown-link-check

      - name: Create link check config
        run: |
          cat > .markdown-link-check.json << 'EOF'
          {
            "ignorePatterns": [
              { "pattern": "^http://localhost" },
              { "pattern": "^https://localhost" },
              { "pattern": "^http://127.0.0.1" },
              { "pattern": "your-" },
              { "pattern": "example.com" }
            ],
            "timeout": "10s",
            "retryOn429": true,
            "retryCount": 3,
            "aliveStatusCodes": [200, 203, 206]
          }
          EOF

      - name: Check links in documentation
        run: |
          echo "## Link Validation" >> $GITHUB_STEP_SUMMARY

          find docs -name '*.md' -print0 | xargs -0 -I {} markdown-link-check {} --config .markdown-link-check.json 2>&1 | tee link-check.txt || true

          BROKEN_LINKS=$(grep -c "\[âœ–\]" link-check.txt || true)
          if [ "$BROKEN_LINKS" -gt 0 ]; then
            echo "::warning::Found $BROKEN_LINKS broken links"
            echo "### âš ï¸ Broken Links Found: $BROKEN_LINKS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A1 "\[âœ–\]" link-check.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Links Valid" >> $GITHUB_STEP_SUMMARY
          fi

  verify-adrs:
    name: Verify ADR Implementation Links
    runs-on: ubuntu-latest
      - name: Check links in documentation
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
          folder-path: 'docs/'
          max-depth: 5

      - name: Check links in root markdown files
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          file-path: './README.md,./CLAUDE.md,./CONTRIBUTING.md,./CHANGELOG.md'
        continue-on-error: true

  adr-verification:
    name: ADR Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore /p:EnableWindowsTargeting=true

      - name: Build DocGenerator
        run: dotnet build tools/DocGenerator -c Release --no-restore
        continue-on-error: true

      - name: Verify ADR implementation links
        run: |
          echo "## ADR Verification" >> $GITHUB_STEP_SUMMARY

          if [ -f "tools/DocGenerator/bin/Release/net9.0/DocGenerator" ]; then
            ./tools/DocGenerator/bin/Release/net9.0/DocGenerator verify-adrs --docs-path docs/architecture/decisions 2>&1 | tee adr-report.txt || true

            if grep -q "INVALID" adr-report.txt; then
              echo "::warning::Some ADR implementation links are invalid"
              echo "### âš ï¸ ADR Verification Issues" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat adr-report.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… All ADR Implementation Links Valid" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "::notice::DocGenerator not available, using fallback verification"
            echo "### â„¹ï¸ Basic ADR Check (DocGenerator not built)" >> $GITHUB_STEP_SUMMARY

            # Fallback: Check ADR files exist and have proper format
            ADR_COUNT=$(find docs/architecture/decisions -name "*.md" 2>/dev/null | wc -l)
            echo "Found $ADR_COUNT ADR files" >> $GITHUB_STEP_SUMMARY
          fi

  generate-context:
    name: Generate Project Context
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.regenerate == 'true')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          cache: true

      - name: Restore DocGenerator
        run: dotnet restore tools/DocGenerator/DocGenerator.csproj

      - name: Build DocGenerator
        run: dotnet build tools/DocGenerator/DocGenerator.csproj -c Release --no-restore

      - name: Verify ADR implementation links
        run: |
          echo "## ADR Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          dotnet run --project tools/DocGenerator/DocGenerator.csproj --no-build -c Release -- verify-adrs \
            --adr-dir docs/adr \
            --src-dir . 2>&1 | tee adr-verify.txt

          if grep -q "VERIFICATION FAILED" adr-verify.txt; then
            echo "âŒ ADR verification failed" >> $GITHUB_STEP_SUMMARY
            cat adr-verify.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All ADR implementation links are valid" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check ADR numbering sequence
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ADR Numbering" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List ADRs and check for gaps
          ls -1 docs/adr/*.md 2>/dev/null | grep -E '[0-9]{3}-' | sort | while read file; do
            basename "$file" | sed 's/\.md$//' >> $GITHUB_STEP_SUMMARY
          done

  project-context-generation:
    name: Project Context Generation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore /p:EnableWindowsTargeting=true

      - name: Build DocGenerator
        run: dotnet build tools/DocGenerator -c Release --no-restore
        continue-on-error: true
          cache: true

      - name: Restore dependencies
        run: |
          dotnet restore tools/DocGenerator/DocGenerator.csproj
          dotnet restore src/MarketDataCollector/MarketDataCollector.csproj /p:EnableWindowsTargeting=true

      - name: Build DocGenerator
        run: dotnet build tools/DocGenerator/DocGenerator.csproj -c Release --no-restore

      - name: Build MarketDataCollector for XML docs
        run: |
          dotnet build src/MarketDataCollector/MarketDataCollector.csproj \
            -c Release \
            --no-restore \
            /p:EnableWindowsTargeting=true \
            /p:GenerateDocumentationFile=true

      - name: Generate project context
        run: |
          mkdir -p docs/generated

          if [ -f "tools/DocGenerator/bin/Release/net9.0/DocGenerator" ]; then
            ./tools/DocGenerator/bin/Release/net9.0/DocGenerator context --output docs/generated/project-context.md || true
            ./tools/DocGenerator/bin/Release/net9.0/DocGenerator interfaces --output docs/generated/interfaces.md || true
          fi

          echo "## Documentation Generation" >> $GITHUB_STEP_SUMMARY
          echo "Generated documentation files:" >> $GITHUB_STEP_SUMMARY
          ls -la docs/generated/ 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No generated files" >> $GITHUB_STEP_SUMMARY

      - name: Check for documentation changes
        id: doc-changes
        run: |
          git diff --name-only docs/generated/ > changed-docs.txt || true
          if [ -s changed-docs.txt ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "### ðŸ“ Documentation Changes Detected" >> $GITHUB_STEP_SUMMARY
            cat changed-docs.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "### âœ… Documentation Up to Date" >> $GITHUB_STEP_SUMMARY
          fi
          dotnet run --project tools/DocGenerator/DocGenerator.csproj --no-build -c Release -- context \
            --src src/MarketDataCollector \
            --output docs/generated/project-context.md \
            --xml-docs src/MarketDataCollector/bin/Release/net9.0/MarketDataCollector.xml

      - name: Generate interface documentation
        run: |
          dotnet run --project tools/DocGenerator/DocGenerator.csproj --no-build -c Release -- interfaces \
            --src src/MarketDataCollector \
            --output docs/generated/interfaces.md

      - name: Upload generated documentation
        uses: actions/upload-artifact@v4
        with:
          name: generated-docs
          path: docs/generated/
          retention-days: 7

  check-diagrams:
    name: Validate Architecture Diagrams
    runs-on: ubuntu-latest
          name: generated-documentation
          path: docs/generated/
          retention-days: 7

      - name: Check for outdated generated docs
        if: github.event_name == 'pull_request'
        run: |
          echo "## Generated Documentation Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f docs/generated/project-context.md ]; then
            echo "âœ… Project context generated successfully" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f docs/generated/interfaces.md ]; then
            echo "âœ… Interface documentation generated successfully" >> $GITHUB_STEP_SUMMARY
          fi

  diagram-validation:
    name: Diagram Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Validate DOT files
        run: |
          echo "## Architecture Diagrams" >> $GITHUB_STEP_SUMMARY

          DOT_FILES=$(find docs -name "*.dot" 2>/dev/null || true)
          if [ -n "$DOT_FILES" ]; then
            echo "### Validating DOT diagrams" >> $GITHUB_STEP_SUMMARY

            for file in $DOT_FILES; do
              if dot -Tsvg "$file" -o /dev/null 2>&1; then
                echo "âœ… $file" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ $file - Invalid syntax" >> $GITHUB_STEP_SUMMARY
                echo "::error file=$file::Invalid DOT syntax"
              fi
            done
          else
            echo "No DOT diagram files found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate diagram previews
        run: |
          mkdir -p docs/generated/diagrams
          for file in $(find docs -name "*.dot" 2>/dev/null); do
            basename=$(basename "$file" .dot)
            dot -Tpng "$file" -o "docs/generated/diagrams/${basename}.png" 2>/dev/null || true
          done

      - name: Upload diagram artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: architecture-diagrams
          path: docs/generated/diagrams/
          retention-days: 7

  documentation-coverage:
    name: Documentation Coverage Report
    runs-on: ubuntu-latest
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Validate Mermaid diagrams in markdown
        run: |
          echo "## Diagram Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all markdown files with mermaid code blocks
          diagram_count=0
          error_count=0

          for mdfile in $(find docs -name "*.md" -type f); do
            # Extract mermaid blocks and validate them
            if grep -q '```mermaid' "$mdfile"; then
              echo "Checking diagrams in: $mdfile"
              diagram_count=$((diagram_count + 1))

              # Extract mermaid content to temp file
              awk '/```mermaid/,/```/' "$mdfile" | sed '1d;$d' > /tmp/diagram.mmd 2>/dev/null || true

              if [ -s /tmp/diagram.mmd ]; then
                if ! mmdc -i /tmp/diagram.mmd -o /tmp/diagram.svg 2>/dev/null; then
                  echo "âš ï¸ Invalid diagram in: $mdfile" >> $GITHUB_STEP_SUMMARY
                  error_count=$((error_count + 1))
                fi
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Checked $diagram_count files with Mermaid diagrams" >> $GITHUB_STEP_SUMMARY

          if [ $error_count -gt 0 ]; then
            echo "âŒ Found $error_count invalid diagrams" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All diagrams are valid" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check PlantUML diagrams
        run: |
          # Check for PlantUML files
          puml_count=$(find docs -name "*.puml" -o -name "*.plantuml" 2>/dev/null | wc -l)
          if [ "$puml_count" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### PlantUML Files" >> $GITHUB_STEP_SUMMARY
            echo "Found $puml_count PlantUML files" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  documentation-summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-validation, adr-verification, project-context-generation, diagram-validation]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate documentation coverage report
        run: |
          echo "## Documentation Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count documentation files
          TOTAL_MD=$(find docs -name "*.md" | wc -l)
          echo "### ðŸ“š Documentation Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total markdown files:** $TOTAL_MD" >> $GITHUB_STEP_SUMMARY

          # Count by category
          ARCH_DOCS=$(find docs/architecture -name "*.md" 2>/dev/null | wc -l || echo 0)
          GUIDE_DOCS=$(find docs/guides -name "*.md" 2>/dev/null | wc -l || echo 0)
          PROVIDER_DOCS=$(find docs/providers -name "*.md" 2>/dev/null | wc -l || echo 0)
          API_DOCS=$(find docs/api -name "*.md" 2>/dev/null | wc -l || echo 0)
          ADR_DOCS=$(find docs/architecture/decisions -name "*.md" 2>/dev/null | wc -l || echo 0)

          echo "- Architecture docs: $ARCH_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- Guides: $GUIDE_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- Provider docs: $PROVIDER_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- API docs: $API_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- ADRs: $ADR_DOCS" >> $GITHUB_STEP_SUMMARY

          # Count source files without corresponding docs
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Source Coverage" >> $GITHUB_STEP_SUMMARY

          CS_FILES=$(find src -name "*.cs" | wc -l)
          FS_FILES=$(find src -name "*.fs" | wc -l)
          echo "- C# source files: $CS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- F# source files: $FS_FILES" >> $GITHUB_STEP_SUMMARY

          # Check for README files in key directories
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Project README Coverage" >> $GITHUB_STEP_SUMMARY

          for dir in src/MarketDataCollector src/Microservices tests benchmarks; do
            if [ -f "$dir/README.md" ]; then
              echo "âœ… $dir/README.md" >> $GITHUB_STEP_SUMMARY
            else
              echo "â“ $dir/README.md (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          done
      - name: Generate documentation report
        run: |
          echo "# Documentation Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Documentation Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY

          md_count=$(find docs -name "*.md" | wc -l)
          echo "| Documentation files | $md_count |" >> $GITHUB_STEP_SUMMARY

          adr_count=$(find docs/adr -name "*.md" ! -name "README.md" ! -name "_template.md" 2>/dev/null | wc -l)
          echo "| Architecture Decision Records | $adr_count |" >> $GITHUB_STEP_SUMMARY

          guide_count=$(find docs/guides -name "*.md" 2>/dev/null | wc -l)
          echo "| Guides | $guide_count |" >> $GITHUB_STEP_SUMMARY

          ai_count=$(find docs/ai-assistants -name "*.md" 2>/dev/null | wc -l)
          echo "| AI Assistant Guides | $ai_count |" >> $GITHUB_STEP_SUMMARY
