name: Nightly Testing

on:
  schedule:
    # Run every day at 1 AM UTC (shifted from 2 AM to avoid midnight spike)
    - cron: '0 1 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  test-matrix:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.1

    - name: Setup .NET with Cache
      uses: ./.github/actions/setup-dotnet-cache
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache-suffix: nightly-${{ matrix.os }}

    - name: Restore dependencies
      run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

    - name: Build
      run: dotnet build MarketDataCollector.sln -c Release --no-restore /p:EnableWindowsTargeting=true

    - name: Run tests
      run: |
        dotnet test MarketDataCollector.sln \
          -c Release \
          --no-build \
          /p:EnableWindowsTargeting=true \
          --logger "console;verbosity=detailed" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Upload coverage
      if: success()
      uses: codecov/codecov-action@v5.5.2
      with:
        directory: ./coverage
        flags: ${{ matrix.os }}
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v6.0.0
      with:
        name: test-failure-logs-${{ matrix.os }}
        path: |
          **/*.trx
          **/coverage/**
        retention-days: 7

  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.1

    - name: Setup .NET with Cache
      uses: ./.github/actions/setup-dotnet-cache
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache-suffix: benchmark

    - name: Run benchmarks
      run: |
        dotnet run \
          --project benchmarks/MarketDataCollector.Benchmarks/MarketDataCollector.Benchmarks.csproj \
          -c Release \
          -- --filter * --exporters json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v6.0.0
      with:
        name: benchmark-results
        path: BenchmarkDotNet.Artifacts/results/
        retention-days: 30

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.1

    - name: Setup .NET with Cache
      uses: ./.github/actions/setup-dotnet-cache
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache-suffix: integration

    - name: Start services
      run: |
        # Create minimal config for testing
        cp config/appsettings.sample.json config/appsettings.json || true
        mkdir -p data logs

    - name: Build
      run: dotnet build MarketDataCollector.sln -c Release /p:EnableWindowsTargeting=true

    - name: Run self-tests
      run: |
        dotnet run \
          --project src/MarketDataCollector/MarketDataCollector.csproj \
          --no-build \
          -c Release \
          -- --selftest

  notify:
    name: Notify on Failure
    needs: [test-matrix, benchmark, integration-tests]
    runs-on: ubuntu-latest
    if: failure()
    timeout-minutes: 5

    steps:
    - name: Create issue on failure
      uses: actions/github-script@v8
      with:
        script: |
          const title = `Nightly tests failed on ${new Date().toISOString().split('T')[0]}`;
          const body = `The nightly test suite failed. Please check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`;
          
          // Check if similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'automated,nightly-tests',
          });
          
          if (issues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated', 'nightly-tests', 'bug'],
            });
          }

  nightly-summary:
    name: Nightly Summary
    needs: [test-matrix, benchmark, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5

    steps:
    - name: Generate nightly summary
      run: |
        echo "# Nightly Test Suite Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Test Matrix | ${{ needs.test-matrix.result == 'success' && '✅ Passed' || (needs.test-matrix.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Benchmarks | ${{ needs.benchmark.result == 'success' && '✅ Passed' || (needs.benchmark.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration | ${{ needs.integration-tests.result == 'success' && '✅ Passed' || (needs.integration-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status
        if [[ "${{ needs.test-matrix.result }}" == "success" ]] && \
           [[ "${{ needs.benchmark.result }}" == "success" ]] && \
           [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "## ✅ All nightly checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ❌ Some nightly checks failed" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed jobs above." >> $GITHUB_STEP_SUMMARY
        fi
