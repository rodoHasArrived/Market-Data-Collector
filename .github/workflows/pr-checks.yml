name: Pull Request Checks

on:
  pull_request:
    branches: [ "main", "develop" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/prompts/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  lint:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET with Cache
      uses: ./.github/actions/setup-dotnet-cache
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache-suffix: pr-lint

    - name: Restore dependencies
      run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

    - name: Check formatting
      run: dotnet format MarketDataCollector.sln --verify-no-changes --verbosity diagnostic

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET with Cache
      uses: ./.github/actions/setup-dotnet-cache
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache-suffix: pr-build-test

    - name: Restore dependencies
      run: dotnet restore MarketDataCollector.sln /p:EnableWindowsTargeting=true

    - name: Build
      run: dotnet build MarketDataCollector.sln -c Release --no-restore /p:EnableWindowsTargeting=true

    - name: Run tests
      run: |
        dotnet test MarketDataCollector.sln \
          -c Release \
          --no-build \
          /p:EnableWindowsTargeting=true \
          --logger "console;verbosity=detailed" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Upload coverage reports
      if: success()
      uses: codecov/codecov-action@v4
      with:
        directory: ./coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: ./coverage/
        retention-days: 7

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint, build-and-test]
    if: always()
    timeout-minutes: 5

    steps:
    - name: Generate PR summary
      run: |
        echo "## Pull Request Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Formatting | ${{ needs.lint.result == 'success' && '✅ Passed' || (needs.lint.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Test | ${{ needs.build-and-test.result == 'success' && '✅ Passed' || (needs.build-and-test.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.lint.result }}" == "failure" ]] || \
           [[ "${{ needs.build-and-test.result }}" == "failure" ]]; then
          echo "### ❌ Some checks failed" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed checks above." >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "### ✅ All checks passed!" >> $GITHUB_STEP_SUMMARY
        fi
