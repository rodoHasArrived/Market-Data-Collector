name: Pull Request Checks

on:
  pull_request:
    branches: [ "main", "develop" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/prompts/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  models: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  ACTIONS_STEP_DEBUG: ${{ vars.ACTIONS_STEP_DEBUG || 'false' }}
  ACTIONS_RUNNER_DEBUG: ${{ vars.ACTIONS_RUNNER_DEBUG || 'false' }}

jobs:
  lint:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET with Cache
      uses: ./.github/actions/setup-dotnet-cache
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache-suffix: pr-lint

    - name: Restore dependencies
      run: dotnet restore MarketDataCollector.sln -p:EnableWindowsTargeting=true /bl:./artifacts/lint-restore.binlog

    - name: Check formatting
      run: dotnet format MarketDataCollector.sln --verify-no-changes --verbosity diagnostic --report ./artifacts/dotnet-format-report.json

    - name: Upload lint diagnostics
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-diagnostics
        path: |
          ./artifacts/lint-restore.binlog
          ./artifacts/dotnet-format-report.json
        retention-days: 14

  build-and-test:
    name: Build & Test
    uses: ./.github/workflows/reusable-dotnet-build.yml
    with:
      fetch-depth: 0
      collect-coverage: true
      cache-suffix: pr-build-test
    secrets: inherit

  # ─── AI PR Review ──────────────────────────────────────────────────────

  ai-pr-review:
    name: AI PR Review
    runs-on: ubuntu-latest
    needs: [lint, build-and-test]
    if: always() && github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get PR diff summary
      id: diff
      run: |
        DIFF_STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -30)
        echo "stats=$DIFF_STATS" >> $GITHUB_OUTPUT
        echo "files<<FILESEOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "FILESEOF" >> $GITHUB_OUTPUT

    - name: AI review summary
      id: ai-review
      continue-on-error: true
      uses: actions/ai-inference@v1
      with:
        model: gpt-4o-mini
        max-tokens: 1500
        prompt: |
          You are a senior .NET engineer reviewing a pull request for a market data collection application (.NET 9.0, C# 11, F# 8).

          Lint result: ${{ needs.lint.result }}
          Build & test result: ${{ needs.build-and-test.result }}

          Changed files:
          ${{ steps.diff.outputs.files }}

          Diff stats: ${{ steps.diff.outputs.stats }}

          Provide a brief PR review summary in markdown:
          1) **Risk Assessment** (Low/Medium/High) based on the files changed
          2) **Review Focus Areas** - what a human reviewer should pay attention to
          3) **Potential Issues** - any concerns based on the file types and build results
          4) If any checks failed, suggest likely causes

          Keep response under 200 words.

    - name: Post AI review to summary
      if: always()
      run: |
        echo "## AI PR Review" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ steps.ai-review.outputs.response }}" ]; then
          echo "${{ steps.ai-review.outputs.response }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "_AI review was not available for this run._" >> $GITHUB_STEP_SUMMARY
        fi

  # ─── PR Summary ──────────────────────────────────────────────────────

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint, build-and-test, ai-pr-review]
    if: always()
    timeout-minutes: 5

    steps:
    - name: Generate PR summary
      run: |
        echo "## Pull Request Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Formatting | ${{ needs.lint.result == 'success' && '✅ Passed' || (needs.lint.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Test | ${{ needs.build-and-test.result == 'success' && '✅ Passed' || (needs.build-and-test.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AI PR Review | ${{ needs.ai-pr-review.result == 'success' && '✅ Completed' || (needs.ai-pr-review.result == 'skipped' && '⏭️ Skipped' || '⚠️ Unavailable') }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Debugging Tips" >> $GITHUB_STEP_SUMMARY
        echo "- Download artifacts **lint-diagnostics** and **build-test-diagnostics** for binlogs/TRX." >> $GITHUB_STEP_SUMMARY
        echo "- To enable verbose runner logs, set repository variable \\`ACTIONS_RUNNER_DEBUG=true\\`." >> $GITHUB_STEP_SUMMARY
        echo "- To enable step debug logs, set repository variable \\`ACTIONS_STEP_DEBUG=true\\`." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.lint.result }}" == "failure" ]] || \
           [[ "${{ needs.build-and-test.result }}" == "failure" ]]; then
          echo "### ❌ Some checks failed" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed checks above." >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "### ✅ All checks passed!" >> $GITHUB_STEP_SUMMARY
        fi
